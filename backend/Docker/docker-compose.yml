version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: mc-manager-nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - asset-server
      - frp-authjs
    networks:
      - mc-network
    restart: unless-stopped

  asset-server:
    user: "1000:1000"
    build:
      context: ../Asset
      dockerfile: Dockerfile
    container_name: mc-manager-asset-server
    environment:
      - NODE_ENV=development
      - PORT=3000
      - FRP_VERSION=${FRP_VERSION:-0.65.0}
      - BASE_URL=${BASE_URL}
    volumes:
      - ./AssetServ/Resource:/app/resources:rw
      - ./AssetServ/Data:/app/data:rw
    networks:
      - mc-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # === FRP Authentication System ===

  frp-authjs:
    user: "1000:1000"
    build:
      context: ./frp-authjs
      dockerfile: Dockerfile
    container_name: frp-authjs
    ports:
      - "3002:3000"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - DISCORD_CLIENT_ID=${AUTH_DISCORD_ID}
      - DISCORD_CLIENT_SECRET=${AUTH_DISCORD_SECRET}
      - DISCORD_REDIRECT_URI=${DISCORD_REDIRECT_URI}
      - BASE_URL=${BASE_URL}
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
    volumes:
      - ./frp-authjs/data:/app/data:rw
    networks:
      - mc-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frp-authz:
    build:
      context: ./frp-authz
      dockerfile: Dockerfile
    container_name: frp-authz
    environment:
      - AUTHJS_URL=${AUTHJS_INTERNAL_URL:-http://frp-authjs:3000}
      - SYNC_INTERVAL_MS=${SYNC_INTERVAL_MS:-1000}
      - FRP_DASHBOARD_URL=${FRP_DASHBOARD_URL:-http://frp-server:7500}
      - FRP_DASHBOARD_USER=${FRP_DASHBOARD_USER:-admin}
      - FRP_DASHBOARD_PASS=${FRP_DASHBOARD_PASS:-admin}
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
    volumes:
      - ./frp-authz/data:/app/data:rw
    depends_on:
      - frp-authjs
    networks:
      - mc-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frp-server:
    build:
      context: ./frp-server
      dockerfile: Dockerfile
    container_name: frp-server
    ports:
      - "${FRP_BIND_PORT:-7000}:7000"
      - "${FRP_DASHBOARD_PORT:-7500}:7500"
    volumes:
      - ./frp-server/frps.toml:/app/frps.toml:ro
    depends_on:
      - frp-authz
    networks:
      - mc-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "7000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  mc-network:
    driver: bridge
