# FRP認証システム PoC実装仕様書

**プロジェクト名:** FRP Token-Based Authentication System (Proof of Concept)  
**作成日:** 2025-11-26  
**対象:** 次期実装セッション  
**ステータス:** 概念検証フェーズ

---

## **1. プロジェクト概要**

### **1.1 背景と目的**

本プロジェクトでは、FRP（Fast Reverse Proxy）を利用したポートフォワーディングシステムをプロダクトに組み込むことを目標としています。最終的には細かい認証・認可システムを構築する予定ですが、まず概念検証（PoC）として、**JWTトークンを用いた一時認証システム**を実装し、以下の技術的検証を行います。

**主要検証項目:**
- JWTベースのクライアント認証がFRPと正常に連携できるか
- FRPの`httpPlugins`機能による外部認証サーバー統合の実現性
- ユーザーごとの許可ポート制御による認可システムの有効性
- 本番環境向け設計への技術的足がかりの確立

### **1.2 実装スコープ**

**本PoCで実装する範囲:**
- サーバーサイド認証・認可システム（Node.js + TypeScript）
- FRPSと認証サーバーのHTTPプラグイン連携
- クライアント制御ソフトの基本実装（frpc管理）
- JSON形式の簡易ユーザー・ポート管理システム

**実装しない範囲（将来拡張）:**
- 本格的なデータベース（PostgreSQL/MySQL等）
- ユーザー管理UI
- 複雑な認可ロジック（ポート範囲、時間制限等）
- TLS/SSL通信
- 本番セキュリティ強化

---

## **2. システムアーキテクチャ**

### **2.1 全体構成**

```
┌─────────────────────┐
│ Client Controller   │ (Node.js + TypeScript)
│ (ユーザーIF + frpc管理) │
└──────────┬──────────┘
           │ 1. ログイン要求 (username/password)
           ↓
┌─────────────────────┐
│   Auth Server       │ (Node.js + Express)
│   Port: 3000        │ ← 4. Webhook (Login/NewProxy)
└──────────┬──────────┘
           │ 2. JWT発行
           ↓
┌─────────────────────┐
│   frpc Client       │ (バイナリ、Node.jsが子プロセス管理)
│   (設定: JWT埋め込み)  │
└──────────┬──────────┘
           │ 3. JWT付き接続要求
           ↓
┌─────────────────────┐
│   frps Server       │ (バイナリ + HTTPプラグイン)
│   Port: 7000        │
└─────────────────────┘
```

### **2.2 コンポーネント詳細**

**サーバーサイド:**
- **frps:** FRP公式バイナリ（ポートフォワーディング実行）
- **認証サーバー:** Node.js + Express（JWT発行・検証、ポート認可）

**クライアントサイド:**
- **クライアント制御ソフト:** Node.js（ユーザーIF、frpc設定生成・起動管理）
- **frpc:** FRP公式バイナリ（実際のトンネル接続）

---

## **3. 技術スタック**

| コンポーネント | 技術 | バージョン |
|---------------|------|-----------|
| 実行環境 | Node.js | v18.x以上 |
| 開発言語 | TypeScript | v5.x |
| Webフレームワーク | Express | v4.x |
| JWT処理 | jsonwebtoken | latest |
| データ管理 | JSON File | - |
| FRPバイナリ | frps/frpc | v0.52.0以上 |

---

## **4. データ構造設計**

### **4.1 ユーザー・ポート管理データベース**

**ファイル:** `auth-server/data/users.json`

```json
{
  "users": [
    {
      "username": "user_alpha",
      "passwordHash": "hashed_password_string",
      "allowedPorts": [8080, 22, 3000],
      "role": "admin"
    },
    {
      "username": "user_beta", 
      "passwordHash": "hashed_password_string",
      "allowedPorts": [3000],
      "role": "user"
    }
  ]
}
```

**フィールド説明:**
- `username`: ユーザー識別子（一意）
- `passwordHash`: パスワードハッシュ（PoC段階では平文も許容）
- `allowedPorts`: 使用可能なリモートポート番号配列
- `role`: ユーザーロール（将来拡張用）

---

## **5. API仕様**

### **5.1 クライアント向けAPI**

#### **POST /api/login**
ユーザー認証を行い、JWTトークンを発行します。

**リクエスト:**
```json
{
  "username": "user_alpha",
  "password": "password123"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**レスポンス（失敗）:**
```json
{
  "success": false,
  "message": "Invalid username or password"
}
```

### **5.2 FRP Webhook API**

#### **POST /webhook/handler**
frpsからの認証・認可リクエストを処理します。

**TypeScript型定義:**
```typescript
interface FrpWebhookRequest {
  version: string;
  op: "Login" | "NewProxy" | "Ping";
  content: {
    user?: string;
    metas?: { [key: string]: string };  // tokenがここに含まれる
    proxy_name?: string;
    proxy_type?: string;
    remote_port?: number;
  };
}

interface FrpWebhookResponse {
  reject: boolean;           // true=拒否, false=許可
  reject_reason?: string;    // 拒否理由
  unchange?: boolean;        // true=frps設定をそのまま使用
  content?: any;             // 設定上書き用（今回未使用）
}
```

**処理ロジック:**

**A. op: "Login"の場合**
1. `content.metas.token`からJWTを取得
2. JWT署名・有効期限を検証
3. 成功 → `{ reject: false, unchange: true }`
4. 失敗 → `{ reject: true, reject_reason: "Invalid or expired token" }`

**B. op: "NewProxy"の場合**
1. JWTからユーザー名を特定
2. `users.json`から該当ユーザーの`allowedPorts`を取得
3. `content.remote_port`が許可リストに含まれるかチェック
4. 許可 → `{ reject: false, unchange: true }`
5. 拒否 → `{ reject: true, reject_reason: "Port not allowed for this user" }`

---

## **6. 設定ファイル仕様**

### **6.1 frps.toml（サーバー設定）**

```toml
bindAddr = "0.0.0.0"
bindPort = 7000

# 認証サーバーへのHTTPプラグイン設定
[[httpPlugins]]
name = "auth-plugin"
addr = "127.0.0.1:3000"        # 認証サーバーアドレス
path = "/webhook/handler"       # Webhookエンドポイント
ops = ["Login", "NewProxy"]     # 処理対象オペレーション
```

### **6.2 frpc.toml（クライアント設定テンプレート）**

クライアント制御ソフトが動的生成する設定ファイル例：

```toml
serverAddr = "x.x.x.x"          # frpsサーバーIP
serverPort = 7000

user = "user_alpha"              # ユーザー名
metadatas.token = "eyJhbGci..."  # 取得したJWTトークン

[[proxies]]
name = "ssh-tunnel"
type = "tcp"
localIP = "127.0.0.1"
localPort = 22
remotePort = 2222                # 許可チェック対象ポート
```

---

## **7. ディレクトリ構成**

```text
my-frp-project/
├── frps/                        # FRPサーバー実行環境
│   ├── frps                     # frpsバイナリ
│   └── frps.toml                # サーバー設定
│
├── auth-server/                 # 認証サーバー (Node.js)
│   ├── src/
│   │   ├── index.ts             # Expressサーバーエントリーポイント
│   │   ├── config.ts            # 設定管理（JWT秘密鍵等）
│   │   ├── db.ts                # JSON DB読み書きロジック
│   │   ├── auth.ts              # JWT発行・検証ロジック
│   │   └── types.ts             # TypeScript型定義
│   ├── data/
│   │   └── users.json           # ユーザー・ポート管理データ
│   ├── package.json
│   ├── tsconfig.json
│   └── .env                     # 環境変数
│
└── client-controller/           # クライアント制御ソフト
    ├── bin/
    │   └── frpc                 # frpcバイナリ
    ├── src/
    │   ├── index.ts             # メイン処理
    │   ├── api.ts               # 認証サーバーAPI通信
    │   └── frp.ts               # frpc起動・設定生成
    ├── temp/                    # 動的生成設定ファイル保存先
    ├── package.json
    └── tsconfig.json
```

---

## **8. 実装タスクリスト**

### **Phase 1: 基盤準備**
- [ ] **Task 1-1:** `users.json`サンプルデータ作成
- [ ] **Task 1-2:** TypeScript型定義作成（`types.ts`）
- [ ] **Task 1-3:** 環境変数設定（`.env`ファイル）

### **Phase 2: 認証サーバー実装**
- [ ] **Task 2-1:** Expressサーバー初期化（`index.ts`）
- [ ] **Task 2-2:** ユーザーログインAPI実装（`POST /api/login`）
- [ ] **Task 2-3:** Webhookハンドラ実装（`POST /webhook/handler`）
- [ ] **Task 2-4:** JWT発行・検証ロジック（`auth.ts`）
- [ ] **Task 2-5:** JSON DB操作ロジック（`db.ts`）

### **Phase 3: クライアント制御ソフト実装**
- [ ] **Task 3-1:** 認証サーバーAPI通信（`api.ts`）
- [ ] **Task 3-2:** frpc設定ファイル動的生成（`frp.ts`）
- [ ] **Task 3-3:** frpc子プロセス管理（`frp.ts`）
- [ ] **Task 3-4:** メインフロー実装（`index.ts`）

### **Phase 4: 結合テスト**
- [ ] **Task 4-1:** 正常系テスト（許可ポート接続成功）
- [ ] **Task 4-2:** 異常系テスト（不正トークン・未許可ポート拒否）

---

## **9. 環境変数設定**

### **認証サーバー用 .env**
```bash
# JWT署名用秘密鍵
JWT_SECRET=your-super-secret-key-change-this

# JWT有効期限（秒）
JWT_EXPIRES_IN=3600

# サーバーポート
PORT=3000

# データベースファイルパス
DB_PATH=./data/users.json
```

---

## **10. 基本フロー**

### **10.1 初回接続シーケンス**
1. **[Client]** ユーザーがクライアントソフトを起動、ID/PW入力
2. **[Client → Auth]** `POST /api/login`でJWT取得
3. **[Client]** JWTを含む`frpc.toml`を動的生成
4. **[Client]** `frpc`プロセス起動
5. **[frpc → frps]** JWT付きで接続要求
6. **[frps → Auth]** `POST /webhook/handler (op: Login)`でJWT検証
7. **[Auth → frps]** 検証結果返答
8. **[frpc → frps]** プロキシ作成要求（ポート指定）
9. **[frps → Auth]** `POST /webhook/handler (op: NewProxy)`でポート許可チェック
10. **[Auth → frps]** 許可/拒否結果返答
11. **[frps]** トンネル作成 or 拒否

---

## **11. セキュリティ考慮事項**

### **11.1 PoC段階での簡易実装項目**
- パスワード管理：平文保存も許容（将来はbcrypt等）
- 通信：HTTP通信（将来はHTTPS必須）
- レート制限：未実装（将来は必要）

### **11.2 本番移行時の必須対応**
- 全通信のTLS化
- パスワードの適切なハッシュ化
- データベースへの移行（PostgreSQL等）
- 監査ログの実装
- セキュリティヘッダーの設定

---

## **12. 次セッション開始時のチェックリスト**

実装開始前に以下を確認してください：

- [ ] Node.js v18.x以上がインストール済み
- [ ] FRP v0.52.0以上のバイナリ（frps/frpc）を取得済み
- [ ] 上記ディレクトリ構成でプロジェクトフォルダを作成済み
- [ ] 本仕様書の内容を理解し、不明点があれば事前に整理済み

---

**以上が、次回実装セッションで使用する完全な仕様書です。この文書に基づいて、Phase 1から順次実装を進めていきましょう。**