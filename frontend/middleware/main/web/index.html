<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server Manager - Enhanced</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.js"></script>
    <link href="./style/main.css" rel="stylesheet">
</head>

<body>
    <div id="app"></div>

    <script type="module">
        import { API_ENDPOINTS } from "./js/Endpoints.js";
        const { createApp } = Vue;


        createApp({
            data() {
                return {
                    loading: true,
                    isAuthenticated: false,
                    authMode: 'login',
                    username: '',

                    darkMode: false,
                    sidebarOpen: false,
                    userMenuOpen: false,

                    signupForm: { id: '', password: '' },
                    loginForm: { id: '', password: '' },
                    authMessage: '',
                    authMessageType: 'error',

                    activeTab: 'servers',
                    tabs: [
                        { id: 'servers', label: 'ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§', icon: 'fas fa-server' },
                        { id: 'create', label: 'æ–°è¦ä½œæˆ', icon: 'fas fa-plus-circle' },
                        { id: 'settings', label: 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š', icon: 'fas fa-cogs' },
                        { id: 'downloads', label: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç®¡ç†', icon: 'fas fa-cloud-download-alt' }
                    ],
                    sidebarMenu: [
                        { id: 'servers', label: 'ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§', icon: 'fas fa-server' },
                        { id: 'create', label: 'æ–°è¦ä½œæˆ', icon: 'fas fa-plus-circle' },
                        { id: 'settings', label: 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š', icon: 'fas fa-cogs' },
                        { id: 'downloads', label: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç®¡ç†', icon: 'fas fa-cloud-download-alt' },
                        { id: 'about', label: 'About Us', icon: 'fas fa-info-circle' },
                        { id: 'tutorials', label: 'Tutorials', icon: 'fas fa-book' }
                    ],

                    errorMessage: '',
                    successMessage: '',

                    servers: [],
                    serversLoading: false,
                    editingServer: null,
                    serverForm: {
                        serverName: '',
                        minecraftVersion: '',
                        serverSoftware: '',
                        jdkVersion: ''
                    },
                    serverSoftwarePlaceholder: 'ã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„',
                    isFetchingServerList: false,
                    serverSoftwareFetchFailed: false,
                    formSubmitting: false,

                    // Step-by-step form data
                    serverListData: null,
                    availableVersions: [],
                    loadingVersions: false,

                    apiResponse: 'APIãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„...',

                    wsConnected: false,
                    ws: null,
                    downloadListType: '',
                    downloadListData: null,
                    fetchingList: false,
                    selectedFile: null,
                    startingDownload: false,
                    activeDownloads: [],

                    // New download progress state for server creation
                    downloadActive: false,
                    downloadProgress: {
                        filename: '',
                        percentage: 0,
                        downloadedMB: 0,
                        totalMB: 0,
                        speed: 0,
                        status: ''
                    }
                };
            },

            async mounted() {
                // Load saved theme preference
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    this.darkMode = true;
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    this.darkMode = false;
                    document.documentElement.setAttribute('data-theme', 'light');
                }

                // Close user menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.user-menu-container')) {
                        this.userMenuOpen = false;
                    }
                });

                // Fetch server list data
                await this.fetchServerList();

                await this.checkAuth();
                this.connectWebSocket();
            },

            beforeUnmount() {
                if (this.ws) {
                    this.ws.close();
                }
            },

            computed: {
                serverSoftwareOptions() {
                    const fallbackOptions = [
                        { value: 'vanilla', label: 'ã‚µãƒ¼ãƒãƒ¼ãƒªã‚¹ãƒˆã®è¦æ±‚ã«å¤±æ•—ã—ã¾ã—ãŸ' },
                    ];

                    if (this.isFetchingServerList || this.serverSoftwareFetchFailed) {
                        return [];
                    }

                    if (!Array.isArray(this.serverListData) || this.serverListData.length === 0) {
                        return fallbackOptions;
                    }

                    const seen = new Set();
                    const options = [];

                    for (const entry of this.serverListData) {
                        if (!entry) continue;

                        const rawValue = (entry.key || entry.id || entry.slug || entry.name || '').toString().trim();
                        if (!rawValue) continue;

                        const normalizedKey = rawValue.toLowerCase();
                        if (seen.has(normalizedKey)) continue;
                        seen.add(normalizedKey);

                        const label = (entry.displayName || entry.label || entry.name || rawValue).toString().trim() || rawValue;
                        options.push({ value: rawValue, label });
                    }

                    if (options.length === 0) {
                        return fallbackOptions;
                    }

                    return options;
                },

                minecraftVersionPlaceholder() {
                    if (this.serverSoftwareFetchFailed) {
                        return 'ãƒªã‚¹ãƒˆã®è¦æ±‚ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    }
                    if (this.isFetchingServerList) {
                        return 'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®é¸æŠå¾…ã¡...';
                    }
                    if (!this.serverForm.serverSoftware) {
                        return 'ã¾ãšã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„';
                    }
                    if (!this.serverListData) {
                        return 'ã‚µãƒ¼ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...';
                    }
                    if (this.loadingVersions) {
                        return 'èª­ã¿è¾¼ã¿ä¸­...';
                    }
                    if (this.availableVersions.length === 0 && this.serverListData) {
                        return 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    }
                    return 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„';
                }
            },

            watch: {
                'serverForm.serverSoftware'(newValue, oldValue) {
                    // Reset version and JDK when software changes
                    this.serverForm.minecraftVersion = '';
                    this.serverForm.jdkVersion = '';
                    this.availableVersions = [];

                    // If software is selected, fetch available versions
                    if (newValue) {
                        if (this.serverListData) {
                            this.loadAvailableVersions(newValue);
                        } else {
                            // If serverListData is not loaded yet, wait for it
                            // fetchServerList will handle loading versions when data arrives
                        }
                    }
                },

                'serverForm.minecraftVersion'(newValue) {
                    // Auto-select JDK based on selected version
                    if (newValue && this.availableVersions.length > 0) {
                        const selectedVersion = this.availableVersions.find(v => v.version === newValue);
                        if (selectedVersion) {
                            this.serverForm.jdkVersion = `OpenJDK ${selectedVersion.jdk}`;
                        }
                    } else {
                        this.serverForm.jdkVersion = '';
                    }
                },

                serverListData(newValue) {
                    // When serverListData loads, if software is already selected, load its versions
                    if (newValue && this.serverForm.serverSoftware) {
                        this.loadAvailableVersions(this.serverForm.serverSoftware);
                    }
                }
            },

            methods: {
                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    if (this.darkMode) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.documentElement.setAttribute('data-theme', 'light');
                        localStorage.setItem('theme', 'light');
                    }
                },

                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen;
                },

                closeSidebar() {
                    this.sidebarOpen = false;
                },

                toggleUserMenu() {
                    this.userMenuOpen = !this.userMenuOpen;
                },

                closeUserMenu() {
                    this.userMenuOpen = false;
                },

                lockServerFormControls() {
                    this.isFetchingServerList = true;
                    this.serverSoftwareFetchFailed = false;
                    this.serverSoftwarePlaceholder = 'ã‚µãƒ¼ãƒãƒ¼å•ã„åˆã‚ã›ä¸­...';
                    this.serverForm.serverSoftware = '';
                    this.serverForm.minecraftVersion = '';
                    this.serverForm.jdkVersion = '';
                    this.availableVersions = [];
                },

                unlockServerFormControls() {
                    this.isFetchingServerList = false;
                    this.serverSoftwareFetchFailed = false;
                    this.serverSoftwarePlaceholder = 'ã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„';
                },

                handleServerListFetchError() {
                    this.serverSoftwarePlaceholder = 'ãƒªã‚¹ãƒˆã®è¦æ±‚ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    this.isFetchingServerList = false;
                    this.serverSoftwareFetchFailed = true;
                    this.serverListData = [];
                    this.availableVersions = [];
                    this.serverForm.minecraftVersion = '';
                    this.serverForm.jdkVersion = '';
                    if (this.activeTab === 'create') {
                        this.showError('ã‚µãƒ¼ãƒãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                },

                async checkAuth() {
                    try {
                        const response = await fetch(API_ENDPOINTS.user.auth, {
                            credentials: 'include'
                        });
                        const data = await response.json();

                        if (data.ok) {
                            this.isAuthenticated = true;
                            this.username = data.userId;
                            await this.loadServers();
                        } else if (data.reason === 'no_user_registered') {
                            this.authMode = 'signup';
                        } else {
                            this.authMode = 'login';
                        }
                    } catch (error) {
                        console.error('Auth check failed:', error);
                        this.authMode = 'login';
                    } finally {
                        this.loading = false;
                    }
                },

                async handleSignup() {
                    try {
                        console.log('Attempting signup with:', this.signupForm);

                        const response = await fetch(API_ENDPOINTS.user.signup, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },
                            credentials: 'include',
                            body: JSON.stringify({ id: this.signupForm.id, password: this.signupForm.password })
                        });

                        console.log('Signup response status:', response.status);

                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('Non-JSON response:', text.substring(0, 200));
                            this.authMessage = `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (Status: ${response.status})`;
                            this.authMessageType = 'error';
                            return;
                        }

                        const data = await response.json();
                        console.log('Signup response data:', data);

                        if (data.ok) {
                            this.authMessage = 'ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ!';
                            this.authMessageType = 'success';
                            setTimeout(() => {
                                this.isAuthenticated = true;
                                this.username = this.signupForm.id;
                                this.loadServers();
                            }, 1000);
                        } else {
                            this.authMessage = data.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
                            this.authMessageType = 'error';
                        }
                    } catch (error) {
                        console.error('Signup error:', error);
                        this.authMessage = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                        this.authMessageType = 'error';
                    }
                },

                async handleLogin() {
                    try {
                        const response = await fetch(API_ENDPOINTS.user.login, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify(this.loginForm)
                        });

                        const data = await response.json();

                        if (data.ok) {
                            this.authMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ!';
                            this.authMessageType = 'success';
                            setTimeout(() => {
                                this.isAuthenticated = true;
                                this.username = this.loginForm.id;
                                this.loadServers();
                            }, 500);
                        } else {
                            this.authMessage = data.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
                            this.authMessageType = 'error';
                        }
                    } catch (error) {
                        this.authMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                        this.authMessageType = 'error';
                    }
                },

                async handleLogout() {
                    try {
                        await fetch(API_ENDPOINTS.user.logout, {
                            method: 'POST',
                            credentials: 'include'
                        });
                        this.userMenuOpen = false;
                        this.isAuthenticated = false;
                        this.authMode = 'login';
                        this.servers = [];
                        this.loginForm = { id: '', password: '' };
                    } catch (error) {
                        console.error('Logout failed:', error);
                    }
                },

                async loadServers() {
                    this.serversLoading = true;
                    try {
                        const response = await fetch(API_ENDPOINTS.server.list, {
                            credentials: 'include'
                        });

                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('Non-JSON response:', text);
                            this.showError('ã‚µãƒ¼ãƒãƒ¼ãŒäºˆæœŸã—ãªã„å½¢å¼ã®å¿œç­”ã‚’è¿”ã—ã¾ã—ãŸ');
                            this.serversLoading = false;
                            return;
                        }

                        const data = await response.json();

                        if (data.ok) {
                            setTimeout(() => {
                                this.servers = data.servers || [];
                                this.serversLoading = false;
                            }, 300);
                        } else {
                            this.showError('ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                            this.serversLoading = false;
                        }
                    } catch (error) {
                        console.error('Load servers error:', error);
                        this.showError(`ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                        this.serversLoading = false;
                    }
                },

                async fetchServerList(options = {}) {
                    const { lockUI = false } = options;

                    if (lockUI) {
                        this.lockServerFormControls();
                    } else {
                        this.isFetchingServerList = true;
                        this.serverSoftwareFetchFailed = false;
                    }

                    let success = false;

                    try {
                        const response = await fetch(API_ENDPOINTS.list.servers);
                        const data = await response.json();

                        if (data.success && data.data) {
                            this.serverListData = data.data;
                            success = true;

                            if (this.serverForm.serverSoftware) {
                                this.loadAvailableVersions(this.serverForm.serverSoftware);
                            }
                        } else {
                            console.error('Failed to fetch server list:', data);
                            if (lockUI) {
                                this.handleServerListFetchError();
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching server list:', error);
                        if (lockUI) {
                            this.handleServerListFetchError();
                        }
                    } finally {
                        if (lockUI) {
                            if (success) {
                                this.unlockServerFormControls();
                            }
                        } else {
                            this.isFetchingServerList = false;
                        }
                    }

                    return success;
                },

                prepareCreateTab() {
                    if (this.editingServer) {
                        return;
                    }
                    if (this.isFetchingServerList) {
                        return;
                    }
                    this.fetchServerList({ lockUI: true });
                },

                loadAvailableVersions(serverSoftware) {
                    this.loadingVersions = true;
                    this.availableVersions = [];

                    // Small delay to show loading state
                    setTimeout(() => {
                        if (!Array.isArray(this.serverListData) || this.serverListData.length === 0) {
                            this.loadingVersions = false;
                            return;
                        }

                        const normalizedSoftware = (serverSoftware || '').toString().trim().toLowerCase();
                        const candidatesFor = (entry) => {
                            return [entry.name, entry.id, entry.slug, entry.key]
                                .filter(Boolean)
                                .map(value => value.toString().trim().toLowerCase());
                        };

                        let serverData = this.serverListData.find((entry) => {
                            if (!entry) return false;
                            const candidates = candidatesFor(entry);
                            return candidates.includes(normalizedSoftware);
                        });

                        if (!serverData) {
                            serverData = this.serverListData.find((entry) => {
                                if (!entry) return false;
                                const candidates = candidatesFor(entry);
                                return candidates.some(value => value.includes(normalizedSoftware));
                            });
                        }

                        if (serverData && Array.isArray(serverData.versions)) {
                            this.availableVersions = serverData.versions;
                        } else {
                            this.availableVersions = [];
                        }

                        if (!this.availableVersions.some(v => v.version === this.serverForm.minecraftVersion)) {
                            this.serverForm.minecraftVersion = '';
                            this.serverForm.jdkVersion = '';
                        }

                        this.loadingVersions = false;
                    }, 100);
                },

                async handleServerSubmit() {
                    this.formSubmitting = true;

                    // Start download simulation for new feature
                    this.startDownloadSimulation();

                    try {
                        if (this.editingServer) {
                            await this.updateServer();
                        } else {
                            await this.createServer();
                        }
                    } finally {
                        this.formSubmitting = false;
                    }
                },

                startDownloadSimulation() {
                    this.downloadActive = true;
                    this.downloadProgress = {
                        filename: `${this.serverForm.serverSoftware}-${this.serverForm.minecraftVersion}.jar`,
                        percentage: 0,
                        downloadedMB: 0,
                        totalMB: 45.8,
                        speed: 0,
                        status: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...'
                    };

                    const interval = setInterval(() => {
                        if (this.downloadProgress.percentage >= 100) {
                            clearInterval(interval);
                            this.downloadProgress.status = 'å®Œäº†!';
                            setTimeout(() => {
                                this.downloadActive = false;
                            }, 2000);
                            return;
                        }

                        const increment = Math.random() * 15 + 5;
                        this.downloadProgress.percentage = Math.min(100, this.downloadProgress.percentage + increment);
                        this.downloadProgress.downloadedMB = (this.downloadProgress.totalMB * this.downloadProgress.percentage / 100).toFixed(1);
                        this.downloadProgress.speed = (Math.random() * 3000 + 1000).toFixed(0);
                    }, 500);
                },

                closeDownload() {
                    if (this.downloadProgress.percentage < 100) {
                        if (confirm('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ä¸­æ­¢ã—ã¾ã™ã‹?')) {
                            this.downloadActive = false;
                            this.formSubmitting = false;
                        }
                    } else {
                        this.downloadActive = false;
                    }
                },

                async createServer() {
                    try {
                        console.log('Creating server with data:', this.serverForm);
                        const response = await fetch(API_ENDPOINTS.server.create, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify(this.serverForm)
                        });

                        console.log('Response status:', response.status);

                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('Non-JSON response from server:', text.substring(0, 200));
                            this.showError(`ã‚µãƒ¼ãƒãƒ¼ãŒäºˆæœŸã—ãªã„å½¢å¼ã®å¿œç­”ã‚’è¿”ã—ã¾ã—ãŸ (Status: ${response.status})`);
                            return;
                        }

                        const data = await response.json();
                        console.log('Response data:', data);

                        if (data.ok) {
                            this.showSuccess(`ğŸ‰ "${this.serverForm.serverName}" ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ!`);
                            this.resetForm();
                            await this.loadServers();
                            setTimeout(() => this.switchTab('servers'), 1500);
                        } else {
                            this.showError(data.message || 'ã‚µãƒ¼ãƒãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        console.error('Server creation error:', error);
                        this.showError(`ã‚µãƒ¼ãƒãƒ¼ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                    }
                },

                async updateServer() {
                    try {
                        const response = await fetch(API_ENDPOINTS.server.update(this.editingServer.id), {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify(this.serverForm)
                        });

                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('Non-JSON response:', text);
                            this.showError('ã‚µãƒ¼ãƒãƒ¼ãŒäºˆæœŸã—ãªã„å½¢å¼ã®å¿œç­”ã‚’è¿”ã—ã¾ã—ãŸ');
                            return;
                        }

                        const data = await response.json();

                        if (data.ok) {
                            this.showSuccess(`âœ… "${this.serverForm.serverName}" ã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ!`);
                            this.resetForm();
                            await this.loadServers();
                            setTimeout(() => this.switchTab('servers'), 1500);
                        } else {
                            this.showError(data.message || 'ã‚µãƒ¼ãƒãƒ¼ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        console.error('Server update error:', error);
                        this.showError(`ã‚µãƒ¼ãƒãƒ¼æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                    }
                },

                editServer(server) {
                    this.editingServer = server;
                    this.serverForm = {
                        serverName: server.serverName,
                        minecraftVersion: server.minecraftVersion,
                        serverSoftware: server.serverSoftware,
                        jdkVersion: server.jdkVersion
                    };
                    // Load available versions for the selected software
                    if (this.serverListData && server.serverSoftware) {
                        this.loadAvailableVersions(server.serverSoftware);
                    }
                    this.switchTab('create');
                    this.showSuccess(`${server.serverName} ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`);
                },

                async deleteServer(server) {
                    const confirmMessage = `æœ¬å½“ã« "${server.serverName}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹?\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n- ã‚µãƒ¼ãƒãƒ¼å: ${server.serverName}\n- ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${server.minecraftVersion}\n- ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢: ${server.serverSoftware}`;

                    if (!confirm(confirmMessage)) return;

                    try {
                        const response = await fetch(API_ENDPOINTS.server.delete(server.id), {
                            method: 'DELETE',
                            credentials: 'include'
                        });

                        const data = await response.json();

                        if (data.ok) {
                            this.showSuccess(`ğŸ—‘ï¸ "${server.serverName}" ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                            await this.loadServers();
                        } else {
                            this.showError(data.message || 'ã‚µãƒ¼ãƒãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        this.showError('ã‚µãƒ¼ãƒãƒ¼å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    }
                },

                resetForm() {
                    this.editingServer = null;
                    this.serverForm = {
                        serverName: '',
                        minecraftVersion: '',
                        serverSoftware: '',
                        jdkVersion: ''
                    };
                    this.availableVersions = [];
                },

                switchTab(tabId) {
                    if (tabId === 'create' && this.activeTab === 'create' && this.editingServer) {
                        this.resetForm();
                    }
                    this.activeTab = tabId;

                    if (tabId === 'create' && !this.editingServer) {
                        this.prepareCreateTab();
                    }
                    // Close sidebar on mobile after selection
                    if (window.innerWidth < 1024) {
                        this.closeSidebar();
                    }
                },

                async testProtectedApi() {
                    try {
                        const response = await fetch(API_ENDPOINTS.protected, {
                            credentials: 'include'
                        });
                        const data = await response.json();
                        this.apiResponse = JSON.stringify(data, null, 2);
                    } catch (error) {
                        this.apiResponse = `Error: ${error.message}`;
                    }
                },

                connectWebSocket() {
                    this.ws = new WebSocket(API_ENDPOINTS.WS_URL);

                    this.ws.onopen = () => {
                        console.log('âœ… WebSocket connected');
                        this.wsConnected = true;
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleWebSocketMessage(message);
                        } catch (error) {
                            console.error('Failed to parse WebSocket message:', error);
                        }
                    };

                    this.ws.onclose = () => {
                        console.log('âŒ WebSocket disconnected');
                        this.wsConnected = false;
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                },

                handleWebSocketMessage(message) {
                    console.log('ğŸ“¨ WebSocket message:', message);

                    switch (message.type) {
                        case 'download_progress':
                            this.updateDownloadProgress(message.data);
                            break;
                        case 'download_complete':
                            this.handleDownloadComplete(message.data);
                            break;
                        case 'download_error':
                            this.handleDownloadError(message.data);
                            break;
                    }
                },

                async fetchDownloadList() {
                    if (!this.downloadListType) {
                        this.showError('ãƒªã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
                        return;
                    }

                    this.fetchingList = true;

                    try {
                        const response = await fetch(API_ENDPOINTS.download.list(this.downloadListType));
                        const data = await response.json();

                        if (data.success) {
                            this.downloadListData = data.data;
                            this.showSuccess('ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸ');
                        } else {
                            this.showError(`ã‚¨ãƒ©ãƒ¼: ${data.error.message}`);
                        }
                    } catch (error) {
                        console.error('Failed to fetch list:', error);
                        this.showError('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒªã‚¹ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    } finally {
                        this.fetchingList = false;
                    }
                },

                selectFile(fileInfo) {
                    this.selectedFile = fileInfo;
                },

                async startDownload() {
                    if (!this.selectedFile) {
                        this.showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                        return;
                    }

                    this.startingDownload = true;

                    try {
                        const response = await fetch(API_ENDPOINTS.download.start, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: this.selectedFile.url })
                        });

                        const data = await response.json();

                        if (data.success) {
                            console.log('Download started:', data.data);
                            this.addDownload(data.data.status);
                            this.showSuccess('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
                        } else {
                            this.showError(`ã‚¨ãƒ©ãƒ¼: ${data.error.message}`);
                        }
                    } catch (error) {
                        console.error('Failed to start download:', error);
                        this.showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    } finally {
                        this.startingDownload = false;
                    }
                },

                addDownload(status) {
                    const existingIndex = this.activeDownloads.findIndex(d => d.taskId === status.taskId);
                    if (existingIndex === -1) {
                        this.activeDownloads.unshift(status);
                    }
                },

                updateDownloadProgress(progress) {
                    const index = this.activeDownloads.findIndex(d => d.taskId === progress.taskId);
                    if (index !== -1) {
                        this.activeDownloads[index] = progress;
                    } else {
                        this.addDownload(progress);
                    }
                },

                handleDownloadComplete(data) {
                    console.log('âœ… Download completed:', data);
                    const index = this.activeDownloads.findIndex(d => d.taskId === data.taskId);
                    if (index !== -1) {
                        this.activeDownloads[index].status = 'completed';
                    }
                    this.showSuccess('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ');
                },

                handleDownloadError(data) {
                    console.error('âŒ Download error:', data);
                    const index = this.activeDownloads.findIndex(d => d.taskId === data.taskId);
                    if (index !== -1) {
                        this.activeDownloads[index].status = 'error';
                    }
                    this.showError(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                },

                async cancelDownload(taskId) {
                    try {
                        const response = await fetch(API_ENDPOINTS.download.cancel(taskId), {
                            method: 'DELETE'
                        });

                        const data = await response.json();

                        if (data.success) {
                            const index = this.activeDownloads.findIndex(d => d.taskId === taskId);
                            if (index !== -1) {
                                this.activeDownloads[index].status = 'cancelled';
                            }
                            this.showSuccess('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                        } else {
                            this.showError(`ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•—: ${data.error.message}`);
                        }
                    } catch (error) {
                        console.error('Error cancelling download:', error);
                        this.showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    }
                },

                showError(message) {
                    this.errorMessage = message;
                    setTimeout(() => {
                        this.errorMessage = '';
                    }, 5000);
                },

                showSuccess(message) {
                    this.successMessage = message;
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 5000);
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString('ja-JP');
                },

                formatTime(seconds) {
                    const min = Math.floor(seconds / 60);
                    const sec = Math.floor(seconds % 60);
                    return `${min}åˆ† ${sec}ç§’`;
                }
            },

            template: `
                <div v-if="loading" id="loading-overlay">
                    <div class="loading-spinner"></div>
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>

                <div v-else-if="!isAuthenticated">
                    <section v-if="authMode === 'signup'" class="auth-container">
                        <div class="auth-card">
                            <div class="auth-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="auth-header">
                                <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h2>
                                <p>ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’1åç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                            </div>
                            <form @submit.prevent="handleSignup">
                                <div class="form-group">
                                    <label for="signup-id">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                                    <input 
                                        type="text" 
                                        id="signup-id" 
                                        v-model="signupForm.id" 
                                        required
                                        placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›"
                                    >
                                </div>
                                <div class="form-group">
                                    <label for="signup-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                    <input 
                                        type="password" 
                                        id="signup-password" 
                                        v-model="signupForm.password" 
                                        required
                                        placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                                    >
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check-circle"></i>
                                    ç™»éŒ²ã—ã¦é–‹å§‹
                                </button>
                                <div v-if="authMessage" :class="['message', authMessageType]">
                                    {{ authMessage }}
                                </div>
                                <p style="text-align: center; margin-top: 20px; color: var(--theme-text-secondary);">
                                    æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ 
                                    <a href="#" @click.prevent="authMode = 'login'" style="color: var(--theme-primary); font-weight: 600; text-decoration: none;">
                                        ã“ã¡ã‚‰ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³
                                    </a>
                                </p>
                            </form>
                        </div>
                    </section>

                    <section v-else class="auth-container">
                        <div class="auth-card">
                            <div class="auth-icon">
                                <i class="fas fa-sign-in-alt"></i>
                            </div>
                            <div class="auth-header">
                                <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
                                <p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                            </div>
                            <form @submit.prevent="handleLogin">
                                <div class="form-group">
                                    <label for="login-id">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                                    <input 
                                        type="text" 
                                        id="login-id" 
                                        v-model="loginForm.id" 
                                        required
                                        placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›"
                                    >
                                </div>
                                <div class="form-group">
                                    <label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                    <input 
                                        type="password" 
                                        id="login-password" 
                                        v-model="loginForm.password" 
                                        required
                                        placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                                    >
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-sign-in-alt"></i>
                                    ãƒ­ã‚°ã‚¤ãƒ³
                                </button>
                                <div v-if="authMessage" :class="['message', authMessageType]">
                                    {{ authMessage }}
                                </div>
                                <p style="text-align: center; margin-top: 20px; color: var(--theme-text-secondary);">
                                    ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ 
                                    <a href="#" @click.prevent="authMode = 'signup'" style="color: var(--theme-primary); font-weight: 600; text-decoration: none;">
                                        ã“ã¡ã‚‰ã‹ã‚‰æ–°è¦ç™»éŒ²
                                    </a>
                                </p>
                            </form>
                        </div>
                    </section>
                </div>

                <main v-else class="main-wrapper">
                    <nav class="navbar">
                        <div class="navbar-content">
                            <div style="display: flex; align-items: center;">
                                <button @click="toggleSidebar" class="hamburger-menu">
                                    <i class="fas fa-bars"></i>
                                </button>
                                <div class="navbar-brand">
                                    <i class="fas fa-cubes"></i>
                                    Minecraft Server Manager
                                </div>
                            </div>
                            <div class="navbar-actions">
                                <button @click="toggleTheme" class="theme-toggle" :title="darkMode ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ'">
                                    <i v-if="darkMode" class="fas fa-sun" style="font-size: 14px;"></i>
                                    <i v-else class="fas fa-moon" style="font-size: 14px;"></i>
                                </button>
                                <div class="user-menu-container" :class="{ open: userMenuOpen }" @click.stop="toggleUserMenu">
                                    <div class="user-menu">
                                        <div class="user-avatar">
                                            <i class="fas fa-user" style="font-size: 12px;"></i>
                                        </div>
                                        <span>{{ username || 'ç®¡ç†è€…' }}</span>
                                        <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                                    </div>
                                    <div class="user-menu-dropdown">
                                        <div class="user-menu-item" @click="handleLogout">
                                            <i class="fas fa-sign-out-alt"></i>
                                            <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <!-- Sidebar Overlay -->
                    <div :class="['sidebar-overlay', { active: sidebarOpen }]" @click="closeSidebar"></div>

                    <!-- Sidebar -->
                    <aside :class="['sidebar', { open: sidebarOpen }]">
                        <ul class="sidebar-menu">
                            <li v-for="item in sidebarMenu" :key="item.id" class="sidebar-menu-item">
                                <button 
                                    :class="['sidebar-menu-button', { active: activeTab === item.id }]"
                                    @click="switchTab(item.id)"
                                >
                                    <i :class="item.icon"></i>
                                    <span>{{ item.label }}</span>
                                </button>
                            </li>
                        </ul>
                    </aside>

                    <div class="dashboard">
                        <div class="dashboard-header">
                            <h1 class="dashboard-title">ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                            <p class="dashboard-subtitle">Minecraftã‚µãƒ¼ãƒãƒ¼ã®ä½œæˆã€ç®¡ç†ã€ç›£è¦–ã‚’è¡Œã„ã¾ã™</p>
                        </div>

                        <transition name="fade">
                            <div v-if="errorMessage" class="message-area error">
                                {{ errorMessage }}
                            </div>
                        </transition>
                        <transition name="fade">
                            <div v-if="successMessage" class="message-area success">
                                {{ successMessage }}
                            </div>
                        </transition>

                        <div v-show="activeTab === 'servers'" class="content-section active">
                            <div class="section-title">
                                <i class="fas fa-server"></i>
                                Minecraftã‚µãƒ¼ãƒãƒ¼ä¸€è¦§
                            </div>
                            
                            <div v-if="serversLoading" class="empty-state">
                                <i class="fas fa-spinner fa-spin" style="font-size: 36px; color: var(--theme-primary);"></i>
                                <h3>ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</h3>
                                <p>å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</p>
                            </div>

                            <div v-else-if="servers.length === 0" class="empty-state">
                                <i class="fas fa-server"></i>
                                <h3>ã‚µãƒ¼ãƒãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
                                <p>ã€Œæ–°è¦ä½œæˆã€ã‚¿ãƒ–ã‹ã‚‰æœ€åˆã®Minecraftã‚µãƒ¼ãƒãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                                <button class="btn btn-primary" @click="switchTab('create')">
                                    <i class="fas fa-plus-circle"></i>
                                    ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆã™ã‚‹
                                </button>
                            </div>

                            <div v-else class="servers-grid">
                                <div 
                                    v-for="server in servers" 
                                    :key="server.id"
                                    class="server-card"
                                >
                                    <div :class="['server-status', server.isRunning ? 'running' : 'stopped']">
                                        {{ server.isRunning ? 'ğŸŸ¢ ç¨¼åƒä¸­' : 'ğŸ”´ åœæ­¢ä¸­' }}
                                    </div>
                                    
                                    <div class="server-name">
                                        <i class="fas fa-cube" style="color: var(--theme-primary); margin-right: 6px; font-size: 14px;"></i>
                                        {{ server.serverName }}
                                    </div>
                                    
                                    <div class="server-details">
                                        <div class="server-detail">
                                            <span class="server-detail-label">
                                                <i class="fas fa-code-branch"></i> ãƒãƒ¼ã‚¸ãƒ§ãƒ³
                                            </span>
                                            <span class="server-detail-value">{{ server.minecraftVersion }}</span>
                                        </div>
                                        <div class="server-detail">
                                            <span class="server-detail-label">
                                                <i class="fas fa-cogs"></i> ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢
                                            </span>
                                            <span class="server-detail-value">{{ server.serverSoftware }}</span>
                                        </div>
                                        <div class="server-detail">
                                            <span class="server-detail-label">
                                                <i class="fas fa-coffee"></i> JDK
                                            </span>
                                            <span class="server-detail-value">{{ server.jdkVersion }}</span>
                                        </div>
                                        <div class="server-detail">
                                            <span class="server-detail-label">
                                                <i class="fas fa-calendar-alt"></i> ä½œæˆæ—¥
                                            </span>
                                            <span class="server-detail-value">{{ formatDate(server.createdAt) }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="server-actions">
                                        <button class="btn btn-secondary btn-sm" @click="editServer(server)">
                                            <i class="fas fa-edit"></i>
                                            ç·¨é›†
                                        </button>
                                        <button class="btn btn-danger btn-sm" @click="deleteServer(server)">
                                            <i class="fas fa-trash-alt"></i>
                                            å‰Šé™¤
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-show="activeTab === 'create'" class="content-section active">
                            <div class="section-title">
                                <i class="fas fa-plus-circle"></i>
                                <span>{{ editingServer ? \`"\${editingServer.serverName}" ã‚’ç·¨é›†\` : 'æ–°ã—ã„Minecraftã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆ' }}</span>
                            </div>
                            
                            <form @submit.prevent="handleServerSubmit">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="serverName">
                                            <i class="fas fa-tag"></i>
                                            ã‚µãƒ¼ãƒãƒ¼å
                                        </label>
                                        <input 
                                            type="text" 
                                            id="serverName" 
                                            v-model="serverForm.serverName" 
                                            required
                                            placeholder="ä¾‹: My Minecraft Server"
                                        >
                                    </div>
                                    <div class="form-group">
                                        <label for="serverSoftware">
                                            <i class="fas fa-cogs"></i>
                                            ã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’é¸æŠ
                                        </label>
                                        <select 
                                            id="serverSoftware" 
                                            v-model="serverForm.serverSoftware" 
                                            required
                                            :disabled="isFetchingServerList || serverSoftwareFetchFailed"
                                        >
                                            <option value="">{{ serverSoftwarePlaceholder }}</option>
                                            <option 
                                                v-for="option in serverSoftwareOptions"
                                                :key="option.value"
                                                :value="option.value"
                                            >
                                                {{ option.label }}
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="minecraftVersion">
                                            <i class="fas fa-code-branch"></i>
                                            Minecraftãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠ
                                        </label>
                                        <select 
                                            id="minecraftVersion" 
                                            v-model="serverForm.minecraftVersion" 
                                            :disabled="isFetchingServerList || serverSoftwareFetchFailed || !serverForm.serverSoftware || loadingVersions || availableVersions.length === 0"
                                            required
                                        >
                                            <option value="">{{ minecraftVersionPlaceholder }}</option>
                                            <option 
                                                v-for="version in availableVersions" 
                                                :key="version.version" 
                                                :value="version.version"
                                            >
                                                {{ version.version }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="jdkVersion">
                                            <i class="fas fa-coffee"></i>
                                            JDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ (è‡ªå‹•é¸æŠ)
                                        </label>
                                        <input 
                                            type="text" 
                                            id="jdkVersion" 
                                            v-model="serverForm.jdkVersion" 
                                            :disabled="isFetchingServerList || serverSoftwareFetchFailed || !serverForm.minecraftVersion"
                                            :placeholder="serverForm.minecraftVersion ? '' : 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠå¾Œã«è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™'"
                                            readonly
                                            style="background: var(--theme-bg); cursor: not-allowed;"
                                        >
                                    </div>
                                </div>
                                
                                <button type="submit" :class="['btn', editingServer ? 'btn-secondary' : 'btn-primary']" :disabled="formSubmitting">
                                    <i :class="formSubmitting ? 'fas fa-spinner fa-spin' : (editingServer ? 'fas fa-save' : 'fas fa-rocket')"></i>
                                    {{ formSubmitting ? (editingServer ? 'æ›´æ–°ä¸­...' : 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ & ä½œæˆä¸­...') : (editingServer ? 'ã‚µãƒ¼ãƒãƒ¼ã‚’æ›´æ–°' : 'ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆ') }}
                                </button>
                            </form>
                        </div>

                        <div v-show="activeTab === 'settings'" class="content-section active">
                            <div class="section-title">
                                <i class="fas fa-cogs"></i>
                                ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
                            </div>
                            
                            <div style="background: var(--theme-bg); padding: 24px; border-radius: 16px; margin-bottom: 24px;">
                                <h4 style="color: var(--theme-text); margin-bottom: 16px; font-size: 18px;">
                                    <i class="fas fa-shield-alt" style="color: var(--theme-primary);"></i>
                                    ä¿è­·ã•ã‚ŒãŸAPI ãƒ†ã‚¹ãƒˆ
                                </h4>
                                <p style="color: var(--theme-text-secondary); margin-bottom: 20px; line-height: 1.6;">
                                    ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚<br>
                                    èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚
                                </p>
                                <button @click="testProtectedApi" class="btn btn-success">
                                    <i class="fas fa-flask"></i>
                                    /api/protected ã‚’ãƒ†ã‚¹ãƒˆ
                                </button>
                            </div>
                            
                            <div style="background: var(--theme-surface); border: 2px solid var(--theme-border); border-radius: 16px; padding: 20px;">
                                <h5 style="color: var(--theme-text); margin-bottom: 12px;">
                                    <i class="fas fa-terminal" style="color: var(--theme-primary);"></i>
                                    APIãƒ¬ã‚¹ãƒãƒ³ã‚¹
                                </h5>
                                <pre style="
                                    background: #1f2937; 
                                    color: #e5e7eb; 
                                    padding: 20px; 
                                    border-radius: 12px; 
                                    font-family: 'Monaco', 'Consolas', monospace;
                                    font-size: 14px;
                                    line-height: 1.5;
                                    white-space: pre-wrap; 
                                    word-wrap: break-word; 
                                    min-height: 60px;
                                    overflow-x: auto;
                                ">{{ apiResponse }}</pre>
                            </div>
                        </div>

                        <div v-show="activeTab === 'downloads'" class="content-section active">
                            <h2>
                                <i class="fas fa-cloud-download-alt"></i>
                                ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç®¡ç†
                            </h2>
                            
                            <div class="download-section">
                                <h3><i class="fas fa-plug"></i> æ¥ç¶šçŠ¶æ…‹</h3>
                                <div :class="['connection-badge', wsConnected ? 'connected' : 'disconnected']">
                                    <i :class="wsConnected ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i>
                                    {{ wsConnected ? 'æ¥ç¶šæ¸ˆã¿' : 'æœªæ¥ç¶š' }}
                                </div>
                                <p style="color: var(--theme-text-secondary); font-size: 0.9rem; margin-top: 10px;">
                                    WebSocketã‚µãƒ¼ãƒãƒ¼ (localhost:4000) ã¸ã®æ¥ç¶šçŠ¶æ…‹ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
                                </p>
                            </div>

                            <div class="download-section">
                                <h3><i class="fas fa-list"></i> ãƒªã‚¹ãƒˆå–å¾—</h3>
                                <div class="download-control-group">
                                    <label for="downloadListType">
                                        <i class="fas fa-filter"></i>
                                        ãƒªã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠ:
                                    </label>
                                    <select id="downloadListType" v-model="downloadListType">
                                        <option value="">-- ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ --</option>
                                        <option value="servers">ã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢</option>
                                        <option value="jdk">JDK</option>
                                    </select>
                                </div>
                                <button @click="fetchDownloadList" class="btn btn-primary" :disabled="!downloadListType || fetchingList">
                                    <i :class="fetchingList ? 'fas fa-spinner fa-spin' : 'fas fa-download'"></i>
                                    {{ fetchingList ? 'èª­ã¿è¾¼ã¿ä¸­...' : 'ãƒªã‚¹ãƒˆã‚’å–å¾—' }}
                                </button>

                                <div v-if="downloadListData" class="download-list-preview">
                                    <pre>{{ JSON.stringify(downloadListData, null, 2) }}</pre>
                                </div>
                            </div>

                            <div v-if="downloadListData" class="download-section">
                                <h3><i class="fas fa-code-branch"></i> ãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ</h3>
                                <div v-if="downloadListType === 'servers'">
                                    <div v-for="server in downloadListData" :key="server.name" style="margin-bottom: 20px;">
                                        <h4 style="margin-bottom: 10px; color: var(--theme-primary);">{{ server.name }}</h4>
                                        <div class="download-version-grid">
                                            <button
                                                v-for="version in server.versions"
                                                :key="version.version"
                                                :class="['download-version-btn', { selected: selectedFile && selectedFile.url === version.downloadUrl }]"
                                                @click="selectFile({ name: server.name, version: version.version, jdk: version.jdk, url: version.downloadUrl, type: 'server' })"
                                            >
                                                {{ version.version }} (JDK {{ version.jdk }})
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div v-else-if="downloadListType === 'jdk'">
                                    <div v-for="jdk in downloadListData" :key="jdk.version" style="margin-bottom: 20px;">
                                        <h4 style="margin-bottom: 10px; color: var(--theme-primary);">JDK {{ jdk.version }} {{ jdk.vendor ? \`(\${jdk.vendor})\` : '' }}</h4>
                                        <div class="download-version-grid">
                                            <button
                                                v-for="download in jdk.downloads"
                                                :key="download.os"
                                                :class="['download-version-btn', { selected: selectedFile && selectedFile.url === download.downloadUrl }]"
                                                @click="selectFile({ version: jdk.version, os: download.os, url: download.downloadUrl, vendor: jdk.vendor, type: 'jdk' })"
                                            >
                                                {{ download.os.toUpperCase() }}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="selectedFile" class="download-section">
                                <h3><i class="fas fa-check-circle"></i> é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«</h3>
                                <div class="download-selected-file-card">
                                    <h4>ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±:</h4>
                                    <p class="download-selected-file-name">
                                        <template v-if="selectedFile.type === 'server'">
                                            {{ selectedFile.name }} {{ selectedFile.version }} (JDK {{ selectedFile.jdk }})
                                        </template>
                                        <template v-else>
                                            JDK {{ selectedFile.version }} - {{ selectedFile.os.toUpperCase() }}
                                        </template>
                                    </p>
                                    <p class="download-selected-file-url">{{ selectedFile.url }}</p>
                                    <button @click="startDownload" class="btn btn-primary" style="margin-top: 15px;" :disabled="startingDownload">
                                        <i :class="startingDownload ? 'fas fa-spinner fa-spin' : 'fas fa-download'"></i>
                                        {{ startingDownload ? 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹ä¸­...' : 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹' }}
                                    </button>
                                </div>
                            </div>

                            <div class="download-section">
                                <h3><i class="fas fa-tasks"></i> ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h3>
                                <div v-if="activeDownloads.length === 0" class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <h3>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                                    <p>ä¸Šè¨˜ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
                                </div>
                                <div v-else>
                                    <div v-for="download in activeDownloads" :key="download.taskId" class="download-card">
                                        <div class="download-card-header">
                                            <div class="download-filename">
                                                <i class="fas fa-file-download"></i>
                                                {{ download.filename }}
                                            </div>
                                            <div :class="['download-status-badge', \`status-\${download.status}\`]">
                                                {{ download.status.toUpperCase() }}
                                            </div>
                                        </div>
                                        <div class="download-progress-container">
                                            <div class="download-progress-bar" :style="{ width: download.percentage + '%' }"></div>
                                        </div>
                                        <div class="download-info-grid">
                                            <div class="download-info-item">
                                                <span class="download-info-label">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿</span>
                                                <span class="download-info-value">
                                                    {{ (download.downloadedBytes / (1024 * 1024)).toFixed(2) }} MB / {{ (download.totalBytes / (1024 * 1024)).toFixed(2) }} MB
                                                </span>
                                            </div>
                                            <div class="download-info-item">
                                                <span class="download-info-label">é€Ÿåº¦</span>
                                                <span class="download-info-value">{{ (download.speed / 1024).toFixed(2) }} KB/s</span>
                                            </div>
                                            <div class="download-info-item">
                                                <span class="download-info-label">æ®‹ã‚Šæ™‚é–“</span>
                                                <span class="download-info-value">
                                                    {{ download.remainingTime > 0 ? formatTime(download.remainingTime) : '--' }}
                                                </span>
                                            </div>
                                            <div class="download-info-item">
                                                <button 
                                                    v-if="download.status === 'downloading'" 
                                                    @click="cancelDownload(download.taskId)"
                                                    class="btn btn-danger btn-sm"
                                                >
                                                    <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-show="activeTab === 'about'" class="content-section active">
                            <div class="section-title">
                                <i class="fas fa-info-circle"></i>
                                About Us
                            </div>
                            <div class="empty-state">
                                <i class="fas fa-info-circle"></i>
                                <h3>About Us</h3>
                                <p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯æº–å‚™ä¸­ã§ã™ã€‚</p>
                            </div>
                        </div>

                        <div v-show="activeTab === 'tutorials'" class="content-section active">
                            <div class="section-title">
                                <i class="fas fa-book"></i>
                                Tutorials
                            </div>
                            <div class="empty-state">
                                <i class="fas fa-book"></i>
                                <h3>Tutorials</h3>
                                <p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯æº–å‚™ä¸­ã§ã™ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- Download Progress Overlay for Server Creation -->
                    <div :class="['download-overlay', { active: downloadActive }]">
                        <div class="download-overlay-content">
                            <div class="download-header">
                                <div class="download-title">
                                    <i class="fas fa-download"></i>
                                    ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­
                                </div>
                                <button class="download-close" @click="closeDownload" v-if="downloadProgress.percentage >= 100">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="download-info">
                                <div class="download-filename">
                                    <i class="fas fa-file"></i> {{ downloadProgress.filename }}
                                </div>
                                <div class="download-stats">
                                    <div class="download-stat">
                                        <i class="fas fa-hdd"></i>
                                        <span>{{ downloadProgress.downloadedMB }} / {{ downloadProgress.totalMB }} MB</span>
                                    </div>
                                    <div class="download-stat">
                                        <i class="fas fa-tachometer-alt"></i>
                                        <span>{{ downloadProgress.speed }} KB/s</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="download-progress-wrapper">
                                <div class="download-progress-fill" :style="{ width: downloadProgress.percentage + '%' }"></div>
                            </div>
                            <div style="text-align: center; margin-top: 8px; font-size: 13px; color: var(--theme-text-secondary); font-weight: 500;">
                                {{ downloadProgress.percentage.toFixed(0) }}%
                            </div>
                            
                            <div class="download-status">
                                <i :class="downloadProgress.percentage >= 100 ? 'fas fa-check-circle' : 'fas fa-spinner fa-spin'"></i>
                                {{ downloadProgress.status }}
                            </div>
                        </div>
                    </div>
                </main>
            `
        }).mount('#app');
    </script>
</body>

</html>