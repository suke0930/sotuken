# å®Ÿè£…ä¾é ¼æ›¸ - è¿½è¨˜äº‹é …ï¼ˆè³ªå•å›ç­”ã«åŸºã¥ãè£œè¶³ï¼‰

**ä½œæˆæ—¥:** 2025-11-03  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0.2  
**å¤‰æ›´ç†ç”±:** å®Ÿè£…å‰ã®è³ªå•äº‹é …ã¨å›ç­”ã‚’è¿½åŠ 

---

## ğŸ“‹ ç›®æ¬¡

1. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è©³ç´°ä»•æ§˜](#1-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è©³ç´°ä»•æ§˜)
2. [ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°ä»•æ§˜](#2-ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°ä»•æ§˜)
3. [ç¨¼åƒæ™‚é–“ç®¡ç†ã®è©³ç´°ä»•æ§˜](#3-ç¨¼åƒæ™‚é–“ç®¡ç†ã®è©³ç´°ä»•æ§˜)
4. [å‹å®šç¾©ã®è£œè¶³](#4-å‹å®šç¾©ã®è£œè¶³)
5. [ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã®è©³ç´°ä»•æ§˜](#5-ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã®è©³ç´°ä»•æ§˜)
6. [è‡ªå‹•å†èµ·å‹•ã®è©³ç´°ä»•æ§˜](#6-è‡ªå‹•å†èµ·å‹•ã®è©³ç´°ä»•æ§˜)
7. [è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã®è©³ç´°ä»•æ§˜](#7-è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã®è©³ç´°ä»•æ§˜)
8. [ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è©³ç´°ä»•æ§˜](#8-ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è©³ç´°ä»•æ§˜)
9. [å‰ææ¡ä»¶ã¨è²¬ä»»ç¯„å›²](#9-å‰ææ¡ä»¶ã¨è²¬ä»»ç¯„å›²)
10. [å®Ÿè£…å‰ã®è³ªå•äº‹é …ã¨å›ç­”ï¼ˆè¿½åŠ ï¼‰](#10-å®Ÿè£…å‰ã®è³ªå•äº‹é …ã¨å›ç­”è¿½åŠ )

---

## 1. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è©³ç´°ä»•æ§˜

### **1.1 removeInstance()ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥**

**ç¢ºå®šä»•æ§˜:** ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ã‚’å…ˆã«å®Ÿè¡Œã—ã€æˆåŠŸã—ãŸå ´åˆã®ã¿ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’æ›´æ–°

```mermaid
flowchart TD
    Start([removeInstance]) --> Check[èµ·å‹•çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯]
    Check --> DeleteDir[1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤]
    DeleteDir --> DirOK{æˆåŠŸ?}
    
    DirOK -->|No| ErrorReturn[Errorè¿”å´<br/>ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå¤‰æ›´ãªã—]
    DirOK -->|Yes| DeleteMap[2. Mapã‹ã‚‰å‰Šé™¤]
    DeleteMap --> DeleteTimer[3. ã‚¿ã‚¤ãƒãƒ¼å‰Šé™¤]
    DeleteTimer --> Save[4. saveConfig]
    Save --> Success[Successè¿”å´]
    
    ErrorReturn --> End([çµ‚äº†])
    Success --> End
    
    style DeleteDir fill:#fff9c4
    style DirOK fill:#fff9c4
    style ErrorReturn fill:#ffcdd2
    style Success fill:#c8e6c9
```

**å‡¦ç†é †åº:**

$$\text{å‡¦ç†é †åº} = \text{ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤} \rightarrow \text{ãƒ¬ã‚¸ã‚¹ãƒˆãƒªæ›´æ–°} \rightarrow \text{è¨­å®šä¿å­˜}$$

**å®Ÿè£…ä¾‹:**
```typescript
async removeInstance(uuid: string): Promise<VoidResult> {
  const instance = this.instances.get(uuid);
  if (!instance) {
    return { success: false, error: ServerManagerErrors.INSTANCE_NOT_FOUND };
  }
  
  // èµ·å‹•çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
  if (instance.isRunning()) {
    return { success: false, error: ServerManagerErrors.INSTANCE_RUNNING };
  }
  
  const serverDir = path.join(this.serversBasePath, instance.getData().name);
  
  // 1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ï¼ˆå…ˆã«å®Ÿè¡Œï¼‰
  try {
    await fs.promises.rm(serverDir, { recursive: true, force: true });
    this.logger.info(`Deleted directory: ${serverDir}`);
  } catch (error) {
    this.logger.error(`Failed to delete directory: ${serverDir}`, error);
    // âŒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•— â†’ å…¨å‡¦ç†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    return { 
      success: false, 
      error: `${ServerManagerErrors.DIRECTORY_DELETE_FAILED}: ${error.message}` 
    };
  }
  
  // 2. ãƒ¬ã‚¸ã‚¹ãƒˆãƒªæ›´æ–°ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤æˆåŠŸå¾Œã®ã¿ï¼‰
  this.instances.delete(uuid);
  this.uptimeIntervals.delete(uuid);
  await this.saveConfig();
  
  return { success: true };
}
```

**ç†ç”±:**
- ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ä¿ã¤ï¼ˆã‚´ãƒŸãƒ•ã‚¡ã‚¤ãƒ«ã®è“„ç©ã‚’é˜²ãï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå•é¡Œã‚’è§£æ±ºã—ã¦ã‹ã‚‰å†è©¦è¡Œã§ãã‚‹
- ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ä¸ä¸€è‡´ã‚’é˜²ã

---

### **1.2 addInstance()ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥**

**ç¢ºå®šä»•æ§˜:** server.propertiesä½œæˆå¤±æ•—æ™‚ã€ä½œæˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã‚’å‰Šé™¤ï¼ˆå…ƒã®jarãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒï¼‰

```mermaid
graph TB
    subgraph "ä½œæˆã•ã‚Œã‚‹ã‚‚ã®ï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡ï¼‰"
        Dir[servers/name/]
        Jar[servers/name/server.jar]
        Eula[servers/name/eula.txt]
        Props[servers/name/server.properties]
    end
    
    subgraph "å…ƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¿æŒï¼‰"
        Original[serverBinaryFilePath<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®jarãƒ•ã‚¡ã‚¤ãƒ«]
    end
    
    Dir --> Jar
    Dir --> Eula
    Dir --> Props
    
    Original -.ã‚³ãƒ”ãƒ¼å…ƒ.-> Jar
    
    Rollback[ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯] -->|å‰Šé™¤| Dir
    Rollback -.ä¿æŒ.-> Original
    
    style Rollback fill:#ffcdd2
    style Original fill:#c8e6c9
```

**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡:**
- âœ… ä½œæˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ï¼ˆ`servers/name/`ï¼‰
- âœ… ã‚³ãƒ”ãƒ¼ã—ãŸjarãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`servers/name/server.jar`ï¼‰
- âœ… ä½œæˆã—ãŸeula.txt
- âœ… ä½œæˆã—ãŸserver.properties
- âŒ å…ƒã®jarãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`serverBinaryFilePath`ï¼‰ã¯å‰Šé™¤ã—ãªã„

**å®Ÿè£…ä¾‹:**
```typescript
async addInstance(params: AddInstanceParams): Promise<AddInstanceResult> {
  // ... ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã€jarç§»å‹•ã€eula.txtä½œæˆ
  
  // server.propertiesä½œæˆ
  const propManager = this.getServerPropertiesManager(uuid);
  try {
    await propManager.create({
      'server-port': port.toString()
    });
  } catch (error) {
    this.logger.error('Failed to create server.properties', error);
    
    // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨å‰Šé™¤
    await fs.promises.rm(serverDir, { recursive: true, force: true });
    
    // å…ƒã®jarãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã—ãªã„
    
    return {
      success: false,
      error: 'Failed to create server.properties'
    };
  }
  
  // ... ä»¥é™ã®å‡¦ç†
}
```

**jarãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰±ã„:**

$$\text{jarãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†} = \text{ã‚³ãƒ”ãƒ¼}(\text{serverBinaryFilePath} \rightarrow \text{servers/name/server.jar})$$

- `serverBinaryFilePath`ã‹ã‚‰`servers/name/server.jar`ã«**ã‚³ãƒ”ãƒ¼**
- å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ®‹ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸãƒ‘ã‚¹ï¼‰
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã‚‚å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã—ãªã„

---

## 2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°ä»•æ§˜

### **2.1 ãƒãƒ¼ãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ã®è©³ç´°**

**ç¢ºå®šä»•æ§˜:** å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆåœæ­¢ä¸­ã‚‚å«ã‚€ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ã€ãŸã ã—ç¨¼åƒä¸­ã¯ã‚¨ãƒ©ãƒ¼ã€åœæ­¢ä¸­ã¯è­¦å‘Š

```mermaid
flowchart TD
    Start([validatePort]) --> GetAll[å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—]
    GetAll --> Find{åŒã˜ãƒãƒ¼ãƒˆ<br/>ä½¿ç”¨ä¸­?}
    
    Find -->|ãªã—| Success[Valid: true]
    Find -->|ã‚ã‚Š| CheckStatus{ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª}
    
    CheckStatus -->|running| Error[Error: Port in use<br/>by running server]
    CheckStatus -->|stopped| Warning[Warning: Port configured<br/>but not in use]
    
    Error --> End([çµ‚äº†])
    Warning --> End
    Success --> End
    
    style Success fill:#c8e6c9
    style Error fill:#ffcdd2
    style Warning fill:#fff9c4
```

**å®Ÿè£…ä¾‹:**
```typescript
validatePort(port: number, excludeUuid?: string): ValidationResult {
  const instances = this.manager.getAllInstances();
  const conflict = instances.find(inst => 
    inst.launchConfig.port === port && 
    inst.uuid !== excludeUuid
  );
  
  if (conflict) {
    if (conflict.status === 'running') {
      // ç¨¼åƒä¸­ â†’ ã‚¨ãƒ©ãƒ¼
      return ValidationResultHelper.failure(
        `Port ${port} is already in use by running server "${conflict.name}"`
      );
    } else {
      // åœæ­¢ä¸­ â†’ è­¦å‘Š
      return ValidationResultHelper.warning([
        `Port ${port} is configured for server "${conflict.name}" (currently stopped)`
      ]);
    }
  }
  
  return ValidationResultHelper.success();
}
```

**åˆ¤å®šåŸºæº–:**

| çŠ¶æ³ | çµæœ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
|------|------|-----------|
| ãƒãƒ¼ãƒˆé‡è¤‡ãªã— | `valid: true` | ãªã— |
| ãƒãƒ¼ãƒˆé‡è¤‡ï¼ˆç¨¼åƒä¸­ï¼‰ | `valid: false` | `Port in use by running server` |
| ãƒãƒ¼ãƒˆé‡è¤‡ï¼ˆåœæ­¢ä¸­ï¼‰ | `valid: true, warnings: [...]` | `Port configured but not in use` |

**excludeUuidã®ç”¨é€”:**
- `updateInstance()`ã§è‡ªåˆ†è‡ªèº«ã®ãƒãƒ¼ãƒˆã‚’å¤‰æ›´ã™ã‚‹éš›ã«ä½¿ç”¨
- è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–ã—ã¦ãƒã‚§ãƒƒã‚¯ï¼ˆä»–ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã®é‡è¤‡ã®ã¿ç¢ºèªï¼‰

---

### **2.2 ãƒ¡ãƒ¢ãƒªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°**

**ç¢ºå®šä»•æ§˜:** `os.totalmem()`ã®80%è¶…éã§è­¦å‘Šã€å˜ä¸€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ãƒ¢ãƒªã®ã¿ãƒã‚§ãƒƒã‚¯

**è¨ˆç®—å¼:**

$$\text{è­¦å‘Šæ¡ä»¶}_1 = \text{maxMemory} > \text{os.totalmem()} \times 0.8$$

$$\text{è­¦å‘Šæ¡ä»¶}_2 = \text{maxMemory} > \text{os.freemem()}$$

**å®Ÿè£…ä¾‹:**
```typescript
validateMemorySettings(minMemory: number, maxMemory: number): ValidationResult {
  const warnings: string[] = [];
  
  // åŸºæœ¬ãƒã‚§ãƒƒã‚¯
  if (minMemory < 512) {
    return ValidationResultHelper.failure(
      'Minimum memory must be at least 512MB'
    );
  }
  
  if (maxMemory < minMemory) {
    return ValidationResultHelper.failure(
      'Maximum memory must be greater than or equal to minimum memory'
    );
  }
  
  // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒªãƒã‚§ãƒƒã‚¯
  const systemMemory = os.totalmem() / (1024 * 1024); // MB
  const availableMemory = os.freemem() / (1024 * 1024); // MB
  
  // totalmemã®80%è¶…é â†’ è­¦å‘Š
  if (maxMemory > systemMemory * 0.8) {
    warnings.push(
      `Maximum memory (${maxMemory}MB) is more than 80% of total system memory (${Math.round(systemMemory)}MB)`
    );
  }
  
  // freememã‚’è¶…é â†’ è­¦å‘Š
  if (maxMemory > availableMemory) {
    warnings.push(
      `Maximum memory (${maxMemory}MB) exceeds currently available memory (${Math.round(availableMemory)}MB)`
    );
  }
  
  return warnings.length > 0
    ? ValidationResultHelper.warning(warnings)
    : ValidationResultHelper.success();
}
```

**è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã®åˆè¨ˆãƒ¡ãƒ¢ãƒªã‚’è€ƒæ…®ã—ãªã„ç†ç”±:**
- ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è²¬ä»»
- å‹•çš„ã«å¤‰åŒ–ã™ã‚‹ãŸã‚æ­£ç¢ºãªåˆ¤å®šãŒå›°é›£
- è­¦å‘Šã®ã¿ã§ååˆ†ï¼ˆã‚¨ãƒ©ãƒ¼ã«ã¯ã—ãªã„ï¼‰

---

## 3. ç¨¼åƒæ™‚é–“ç®¡ç†ã®è©³ç´°ä»•æ§˜

### **3.1 ç¨¼åƒæ™‚é–“ã®è¨ˆç®—æ–¹æ³•**

**ç¢ºå®šä»•æ§˜:** ç¾åœ¨æ™‚åˆ» - èµ·å‹•æ™‚åˆ»

**è¨ˆç®—å¼:**

$$\text{sessionUptime} = \text{Date.now()} - \text{currentSessionStartTime}$$

$$\text{totalUptime}_{\text{new}} = \text{totalUptime}_{\text{old}} + \lfloor \frac{\text{sessionUptime}}{1000} \rfloor$$

**å®Ÿè£…ä¾‹:**
```typescript
private updateUptime(uuid: string): void {
  const wrapper = this.instances.get(uuid);
  if (!wrapper) return;
  
  const runtimeState = wrapper.getRuntimeState();
  if (!runtimeState.currentSessionStartTime) return;
  
  // ç¾åœ¨æ™‚åˆ» - ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»
  const sessionUptime = Date.now() - runtimeState.currentSessionStartTime;
  
  // ç´¯è¨ˆç¨¼åƒæ™‚é–“ã«åŠ ç®—ï¼ˆç§’å˜ä½ï¼‰
  const data = wrapper.getData();
  data.metadata.totalUptime += Math.floor(sessionUptime / 1000);
  
  wrapper.updateData(data);
}
```

---

### **3.2 ç¨¼åƒæ™‚é–“ã®æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°**

**ç¢ºå®šä»•æ§˜:** 5åˆ†ã”ã¨ + åœæ­¢æ™‚ã«å³åº§ã«å®Ÿè¡Œ

```mermaid
sequenceDiagram
    participant SM as ServerManager
    participant Wrapper
    
    Note over SM,Wrapper: èµ·å‹•æ™‚
    SM->>Wrapper: start()
    SM->>SM: startUptimeTracking(uuid)
    SM->>SM: setInterval(5åˆ†)
    
    loop 5åˆ†ã”ã¨
        SM->>SM: updateUptime(uuid)
    end
    
    Note over SM,Wrapper: åœæ­¢æ™‚
    SM->>Wrapper: stop()
    SM->>SM: stopUptimeTracking(uuid)
    SM->>SM: clearInterval()
    SM->>SM: updateUptime(uuid) â† å³åº§ã«å®Ÿè¡Œ
    SM->>SM: saveConfig()
```

**å®Ÿè£…ä¾‹:**
```typescript
private startUptimeTracking(uuid: string): void {
  const timer = setInterval(() => {
    this.updateUptime(uuid);
  }, 5 * 60 * 1000); // 5åˆ†
  
  this.uptimeIntervals.set(uuid, timer);
}

private stopUptimeTracking(uuid: string): void {
  // ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢
  const timer = this.uptimeIntervals.get(uuid);
  if (timer) {
    clearInterval(timer);
    this.uptimeIntervals.delete(uuid);
  }
  
  // æœ€çµ‚æ›´æ–°ï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰
  this.updateUptime(uuid);
  
  // è¨­å®šä¿å­˜
  await this.saveConfig();
}
```

**æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°:**

| ã‚¿ã‚¤ãƒŸãƒ³ã‚° | æ›´æ–°æ–¹æ³• | å‚™è€ƒ |
|----------|---------|------|
| èµ·å‹•æ™‚ | ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ | 5åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–° |
| ç¨¼åƒä¸­ï¼ˆ5åˆ†ã”ã¨ï¼‰ | `updateUptime()` | ã‚¿ã‚¤ãƒãƒ¼ç™ºç« |
| åœæ­¢æ™‚ | `updateUptime()` | å³åº§ã«å®Ÿè¡Œï¼ˆã‚¿ã‚¤ãƒãƒ¼ã‚’å¾…ãŸãªã„ï¼‰ |

---

## 4. å‹å®šç¾©ã®è£œè¶³

### **4.1 AddInstanceResultã®æ§‹é€ **

**ç¢ºå®šä»•æ§˜:** ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å½¢å¼

```typescript
export interface AddInstanceResult {
  success: boolean;
  uuid?: string;      // æˆåŠŸæ™‚ã®ã¿å­˜åœ¨
  error?: string;     // å¤±æ•—æ™‚ã®ã¿å­˜åœ¨
}
```

**ä½¿ç”¨ä¾‹:**
```typescript
const result = await manager.addInstance(params);

if (result.success) {
  console.log(`Created: ${result.uuid}`);
  // result.uuidã¯å¿…ãšå­˜åœ¨ã™ã‚‹
} else {
  console.error(`Failed: ${result.error}`);
  // result.errorã¯å¿…ãšå­˜åœ¨ã™ã‚‹
}
```

**ç†ç”±:**
- æ—¢å­˜ã®è¨­è¨ˆæ›¸ã§ä½¿ç”¨ã—ã¦ã„ã‚‹å½¢å¼
- å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«
- å‹ã‚¬ãƒ¼ãƒ‰ãŒä¸è¦

---

### **4.2 VoidResultã®ä¸€è²«ä½¿ç”¨**

**ç¢ºå®šä»•æ§˜:** ã™ã¹ã¦ã®voidè¿”å´ãƒ¡ã‚½ãƒƒãƒ‰ã§`VoidResult`ã‚’ä½¿ç”¨

```typescript
// âœ… æ¨å¥¨
async removeInstance(uuid: string): Promise<VoidResult>
async updateInstance(params: UpdateInstanceParams): Promise<VoidResult>
async startServer(uuid: string): Promise<VoidResult>
async stopServer(uuid: string, timeout?: number): Promise<VoidResult>

// âŒ éæ¨å¥¨
async removeInstance(uuid: string): Promise<ServerManagerResult<void>>
```

**ç†ç”±:**
- ä¸€è²«æ€§ã®å‘ä¸Š
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Š
- ã‚¿ã‚¤ãƒ—é‡ã®å‰Šæ¸›

---

## 5. ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã®è©³ç´°ä»•æ§˜

### **5.1 stopServer()ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã®å‹•ä½œ**

**ç¢ºå®šä»•æ§˜:** ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§`forceKillServer()`ã‚’å‘¼ã³å‡ºã™

```mermaid
sequenceDiagram
    participant User
    participant SM as ServerManager
    participant Wrapper
    participant PE as ProcessExecutor
    
    User->>SM: stopServer(uuid, 30000)
    SM->>Wrapper: stop(30000)
    Wrapper->>PE: stop(30000)
    
    alt 30ç§’ä»¥å†…ã«çµ‚äº†
        PE->>Wrapper: onExit(0)
        Wrapper->>SM: reportEvent('stopped')
        SM->>User: callbacks.onServerStopped(uuid, 0)
        SM-->>User: Result success
    else ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        PE->>Wrapper: onStopTimeout()
        Wrapper->>SM: reportEvent('stopTimeout')
        SM->>User: callbacks.onStopTimeout(uuid, message)
        SM-->>User: Result success
        Note over User: ãƒ—ãƒ­ã‚»ã‚¹ã¯æ®‹å­˜<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¤æ–­ãŒå¿…è¦
        
        User->>User: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º<br/>"å¼·åˆ¶çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ"
        User->>SM: forceKillServer(uuid)
        SM->>Wrapper: forceKill()
        Wrapper->>PE: kill()
        PE->>PE: SIGKILLé€ä¿¡
        Wrapper->>SM: reportEvent('forcedKill')
        SM->>User: callbacks.onForcedKill(uuid)
    end
```

**stopServer()ã®æˆ»ã‚Šå€¤:**
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚`success: true`ã‚’è¿”ã™
- ã‚¨ãƒ©ãƒ¼ã§ã¯ãªãã€æ­£å¸¸ãªå‹•ä½œã®ä¸€éƒ¨

**å®Ÿè£…ä¾‹:**
```typescript
async stopServer(uuid: string, timeout: number = 30000): Promise<VoidResult> {
  const wrapper = this.instances.get(uuid);
  if (!wrapper) {
    return { success: false, error: ServerManagerErrors.INSTANCE_NOT_FOUND };
  }
  
  if (!wrapper.isRunning()) {
    return { success: false, error: ServerManagerErrors.INSTANCE_NOT_RUNNING };
  }
  
  await wrapper.stop(timeout);
  
  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ success: true
  return { success: true };
}
```

**ç†ç”±:**
- å¼·åˆ¶çµ‚äº†ã¯ãƒ‡ãƒ¼ã‚¿ç ´æã®ãƒªã‚¹ã‚¯ãŒã‚ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«åˆ¤æ–­ã™ã¹ã
- UIã§ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹æƒ³å®š

---

### **5.2 forceKillServer()ã®å®Ÿè£…**

**ç¢ºå®šä»•æ§˜:** å³åº§ã«æˆåŠŸã‚’è¿”ã™ï¼ˆãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã¯éåŒæœŸï¼‰

```typescript
public forceKillServer(uuid: string): void {
  const wrapper = this.instances.get(uuid);
  if (!wrapper) {
    this.logger.warn('Instance not found for force kill', { uuid });
    return;
  }
  
  wrapper.forceKill();
  
  // å³åº§ã«returnï¼ˆãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã¯éåŒæœŸï¼‰
  this.logger.info('Force kill requested', { uuid });
}
```

**å‹•ä½œ:**
- `ProcessExecutor.kill()`ã‚’å‘¼ã³å‡ºã™ã®ã¿
- ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã‚’å¾…ãŸãªã„
- `onExit`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§çµ‚äº†ã‚’é€šçŸ¥

**ç†ç”±:**
- ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã¯éåŒæœŸ
- åŒæœŸçš„ã«å¾…ã¤å¿…è¦ãªã—
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯`onForcedKill`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§çµ‚äº†ã‚’ç¢ºèª

---

### **5.3 ProcessExecutor.stop()ã®æˆ»ã‚Šå€¤ï¼ˆé‡è¦ãªå¤‰æ›´ï¼‰**

**ç¢ºå®šä»•æ§˜:** `Promise<boolean>`ã‚’è¿”ã™

```typescript
/**
 * ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
 * 
 * @param timeout - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
 * @returns æ­£å¸¸ã«åœæ­¢ã§ããŸå ´åˆtrueã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸå ´åˆfalse
 */
public async stop(timeout: number = 30000): Promise<boolean>
```

**æˆ»ã‚Šå€¤ã®æ„å‘³:**

| æˆ»ã‚Šå€¤ | æ„å‘³ | ãƒ—ãƒ­ã‚»ã‚¹ã®çŠ¶æ…‹ |
|--------|------|--------------|
| `true` | æ­£å¸¸ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå†…ã§åœæ­¢ | çµ‚äº†æ¸ˆã¿ |
| `false` | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸ | **ã¾ã å®Ÿè¡Œä¸­** |

**å®Ÿè£…ä¾‹:**
```typescript
public async stop(timeout: number = 30000): Promise<boolean> {
  // æ—¢ã«åœæ­¢ã—ã¦ã„ã‚‹å ´åˆ
  if (!this.isRunningFlag || !this.process) {
    return true; // æ—¢ã«åœæ­¢ã—ã¦ã„ã‚‹ã®ã§true
  }
  
  this.logger.info('Stopping process', { timeout });
  
  // stopã‚³ãƒãƒ³ãƒ‰é€ä¿¡
  this.sendCommand('stop');
  
  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§çµ‚äº†å¾…æ©Ÿ
  const terminated = await this.waitForExit(timeout);
  
  if (terminated) {
    // æ­£å¸¸åœæ­¢
    this.logger.info('Process stopped gracefully');
    return true;
  } else {
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    this.logger.warn('Process did not stop within timeout');
    
    // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é€šçŸ¥
    if (this.onStopTimeout) {
      this.onStopTimeout();
    }
    
    return false; // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã®ã§false
  }
}
```

**ServerInstanceWrapperã§ã®ä½¿ç”¨:**
```typescript
private async executeStop(timeout: number): Promise<void> {
  if (!this.process) {
    return;
  }
  
  const stopped = await this.process.stop(timeout);
  
  if (!stopped) {
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã¯æ—¢ã«ç™ºç«æ¸ˆã¿ï¼‰
    this.logger.warn(`Server stop timed out: ${this.data.name}`);
    // âš ï¸ ãƒ—ãƒ­ã‚»ã‚¹ã¯ã¾ã å®Ÿè¡Œä¸­
    // âš ï¸ forceKill()ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹
  } else {
    // æ­£å¸¸åœæ­¢
    // âœ… ãƒ—ãƒ­ã‚»ã‚¹ã¯çµ‚äº†æ¸ˆã¿
    // âœ… cleanup()ã¯ onExit ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹
  }
}
```

**ãªãœbooleanã‚’è¿”ã™ã®ã‹:**
1. **çŠ¶æ…‹ã®æ˜ç¤º**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã‹ã©ã†ã‹ã‚’å‘¼ã³å‡ºã—å´ãŒåˆ¤æ–­ã§ãã‚‹
2. **æŸ”è»Ÿãªå¯¾å¿œ**: å‘¼ã³å‡ºã—å´ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®å‡¦ç†ã‚’é¸æŠã§ãã‚‹
3. **ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ä»•æ§˜ä¸Šã®æ­£å¸¸ãªå‹•ä½œï¼ˆã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ï¼‰

---

## 6. è‡ªå‹•å†èµ·å‹•ã®è©³ç´°ä»•æ§˜

### **6.1 ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°**

**ç¢ºå®šä»•æ§˜:** `start()`æˆåŠŸå¾Œï¼ˆãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ç¢ºèªå¾Œï¼‰ã€å…·ä½“çš„ã«ã¯`executeStart()`ç›´å¾Œ

```mermaid
sequenceDiagram
    participant Wrapper
    participant PE as ProcessExecutor
    
    Wrapper->>PE: start(...)
    PE->>PE: spawn process
    PE-->>Wrapper: èµ·å‹•æˆåŠŸ
    
    Note over Wrapper: âœ… ã“ã“ã§ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    
    Wrapper->>Wrapper: startResetTimer()
    Wrapper->>Wrapper: setTimeout(10åˆ†)
    
    Wrapper->>Wrapper: status = 'running'
    Wrapper->>Wrapper: metadataæ›´æ–°
    Wrapper->>Wrapper: reportEvent('started')
```

**å®Ÿè£…ç®‡æ‰€:**
```typescript
public async start(): Promise<void> {
  // ... JDKå–å¾—ã€ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•
  
  await this.executeStart(jdkEntry);
  
  // âœ… executeStart()ç›´å¾Œã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å‰ï¼‰
  this.startResetTimer();
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  this.data.status = 'running';
  this.data.metadata.lastStartedAt = new Date().toISOString();
  this.runtimeState.currentSessionStartTime = Date.now();
  
  // ã‚¤ãƒ™ãƒ³ãƒˆå ±å‘Š
  this.reportEvent('started');
}
```

**ç†ç”±:**
- ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ã—ãŸç¬é–“ã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆé–‹å§‹
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚„ã‚¤ãƒ™ãƒ³ãƒˆå ±å‘Šã¯é–¢ä¿‚ãªã„
- ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹• = ç¨¼åƒé–‹å§‹ã®ãŸã‚

---

### **6.2 ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆæ¡ä»¶**

**ç¢ºå®šä»•æ§˜:** èµ·å‹•ã‹ã‚‰10åˆ†å¾Œã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ

```mermaid
stateDiagram-v2
    [*] --> Running: èµ·å‹•
    
    state Running {
        [*] --> Counting: ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        Counting --> Reset: 10åˆ†çµŒé
        Reset --> [*]: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼=0
    }
    
    Running --> Crashed: exitCode != 0
    
    state Crashed {
        [*] --> Check: å†èµ·å‹•åˆ¤å®š
        Check --> Restart: count < limit
        Check --> Stop: count >= limit
    }
    
    Restart --> Running: å†èµ·å‹•
    Stop --> [*]
    Running --> [*]: æ­£å¸¸çµ‚äº†
    
    note right of Reset
        èµ·å‹•ã‹ã‚‰10åˆ†çµŒéã§
        consecutiveRestartCount = 0
    end note
```

**å®Ÿè£…ä¾‹:**
```typescript
private startResetTimer(): void {
  this.clearResetTimer();
  
  const { resetThresholdSeconds } = this.data.autoRestart;
  
  // èµ·å‹•ã‹ã‚‰10åˆ†å¾Œã«ãƒªã‚»ãƒƒãƒˆ
  this.runtimeState.resetTimerId = setTimeout(() => {
    this.logger.info('Resetting restart counter', {
      uuid: this.data.uuid,
      previousCount: this.runtimeState.consecutiveRestartCount
    });
    this.resetRestartCounter();
  }, resetThresholdSeconds * 1000);
}
```

**ã‚·ãƒŠãƒªã‚ªä¾‹:**

| æ™‚åˆ» | ã‚¤ãƒ™ãƒ³ãƒˆ | count | å‚™è€ƒ |
|------|---------|-------|------|
| 0:00 | èµ·å‹• | 0 | ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼ˆ10åˆ†ï¼‰ |
| 0:05 | ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ | 1 | å†èµ·å‹• |
| 0:08 | ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ | 2 | å†èµ·å‹•ï¼ˆã¾ã 10åˆ†çµŒéã—ã¦ã„ãªã„ï¼‰ |
| 0:23 | 15åˆ†ç¨¼åƒ | 0 | ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ |
| 0:25 | ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ | 1 | å†èµ·å‹•ï¼ˆãƒªã‚»ãƒƒãƒˆæ¸ˆã¿ãªã®ã§1ã‹ã‚‰ï¼‰ |

---

## 7. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã®è©³ç´°ä»•æ§˜

### **7.1 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´æ™‚ã®å‹•ä½œ**

**ç¢ºå®šä»•æ§˜:** è­¦å‘Šã®ã¿ã§å‡¦ç†ç¶šè¡Œï¼ˆZodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ä»»ã›ã‚‹ï¼‰

```typescript
private async loadAndValidateConfig(): Promise<void> {
  const raw = await fs.promises.readFile(this.configPath, 'utf-8');
  const parsed = JSON.parse(raw);
  
  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰
  if (parsed.configVersion !== '1.0.0') {
    this.logger.warn('Config version mismatch', {
      expected: '1.0.0',
      actual: parsed.configVersion
    });
    // å‡¦ç†ã¯ç¶™ç¶š
  }
  
  // Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ä¾‹å¤–ï¼‰
  this.config = ServerManagerConfigSchema.parse(parsed);
}
```

**ç†ç”±:**
- Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ§‹é€ ã®æ­£å½“æ€§ã¯ä¿è¨¼ã•ã‚Œã‚‹
- å°†æ¥çš„ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®ä½™åœ°ã‚’æ®‹ã™

---

### **7.2 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆ**

**ç¢ºå®šä»•æ§˜:** `initialize()`æ™‚ã«ã‚¨ãƒ©ãƒ¼

```typescript
static async initialize(
  configPath: string,
  serversBasePath: string,
  logPath: string,
  jdkManager: JDKManager,
  callbacks?: ServerCallbacks
): Promise<ServerManager> {
  const manager = new ServerManager(
    configPath,
    serversBasePath,
    logPath,
    jdkManager,
    callbacks
  );
  
  // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
  if (!fs.existsSync(manager.configPath)) {
    const dir = path.dirname(manager.configPath);
    
    // è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
    if (!fs.existsSync(dir)) {
      throw new Error(`Config directory does not exist: ${dir}`);
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§æ–°è¦ä½œæˆ
    manager.config = manager.createDefaultConfig();
    await manager.saveConfig();
  } else {
    // æ—¢å­˜è¨­å®šã‚’èª­ã¿è¾¼ã¿
    await manager.loadAndValidateConfig();
  }
  
  // Wrapperç”Ÿæˆ
  manager.createWrappers();
  
  return manager;
}
```

**ç†ç”±:**
- æ—©æœŸã‚¨ãƒ©ãƒ¼æ¤œå‡º
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ„å›³ã—ãªã„å ´æ‰€ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã®ã‚’é˜²ã

---

## 8. ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è©³ç´°ä»•æ§˜

### **8.1 test.env.jsonã®ãƒ‘ã‚¹æŒ‡å®š**

**ç¢ºå®šä»•æ§˜:** ç›¸å¯¾ãƒ‘ã‚¹ã‚‚è¨±å®¹ã™ã‚‹ãŒã€å®Ÿè¡Œæ™‚ã«çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›

```json
{
  "jdkManager": {
    "configPath": "./tests/tmp/jdk-registry.json",
    "jdkArchives": {
      "jdk8": "./tests/fixtures/jdk8.zip",
      "jdk17": "./tests/fixtures/jdk17.zip",
      "jdk21": "./tests/fixtures/jdk21.zip"
    }
  },
  "minecraftServer": {
    "vanillaJar": "./tests/fixtures/server.jar",
    "paperJar": "./tests/fixtures/paper.jar"
  },
  "testPaths": {
    "configDir": "./tests/tmp/config",
    "serversDir": "./tests/tmp/servers",
    "logsDir": "./tests/tmp/logs"
  }
}
```

**èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†:**
```typescript
export function loadTestEnv(): TestEnv {
  const envPath = path.join(__dirname, 'test.env.json');
  const content = fs.readFileSync(envPath, 'utf-8');
  const env = JSON.parse(content);
  
  // ç›¸å¯¾ãƒ‘ã‚¹ã‚’çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
  return {
    jdkManager: {
      configPath: path.resolve(env.jdkManager.configPath),
      jdkArchives: {
        jdk8: path.resolve(env.jdkManager.jdkArchives.jdk8),
        jdk17: path.resolve(env.jdkManager.jdkArchives.jdk17),
        jdk21: path.resolve(env.jdkManager.jdkArchives.jdk21)
      }
    },
    minecraftServer: {
      vanillaJar: path.resolve(env.minecraftServer.vanillaJar),
      paperJar: path.resolve(env.minecraftServer.paperJar)
    },
    testPaths: {
      configDir: path.resolve(env.testPaths.configDir),
      serversDir: path.resolve(env.testPaths.serversDir),
      logsDir: path.resolve(env.testPaths.logsDir)
    }
  };
}
```

**ç†ç”±:**
- ç›¸å¯¾ãƒ‘ã‚¹ã®æ–¹ãŒãƒ†ã‚¹ãƒˆç’°å¢ƒã®å¯æ¬æ€§ãŒé«˜ã„
- å®Ÿè¡Œæ™‚ã«çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›ã™ã‚Œã°å•é¡Œãªã—

---

### **8.2 ãƒ†ã‚¹ãƒˆç”¨ã®Minecraft Server jar**

**ç¢ºå®šä»•æ§˜:** ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã”ã¨ã«ä½¿ã„åˆ†ã‘

| ãƒ†ã‚¹ãƒˆç¨®åˆ¥ | ä½¿ç”¨ã™ã‚‹jar | ç†ç”± |
|-----------|-----------|------|
| å˜ä½“ãƒ†ã‚¹ãƒˆ | ãƒ¢ãƒƒã‚¯jarï¼ˆç©ºãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚å¯ï¼‰ | å‹•ä½œç¢ºèªãŒç›®çš„ |
| çµ±åˆãƒ†ã‚¹ãƒˆ | ãƒ¢ãƒƒã‚¯jarï¼ˆç©ºãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚å¯ï¼‰ | å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã¯ä¸è¦ |
| E2Eãƒ†ã‚¹ãƒˆ | å®Ÿéš›ã®jarï¼ˆPaperæ¨å¥¨ï¼‰ | å®Ÿéš›ã®å‹•ä½œç¢ºèª |

**ãƒ¢ãƒƒã‚¯jarã®ä½œæˆä¾‹:**
```typescript
// tests/setup/createMockJar.ts
export async function createMockJar(outputPath: string): Promise<void> {
  // ç©ºã®zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆjarã¯zipå½¢å¼ï¼‰
  const content = Buffer.from([
    0x50, 0x4b, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  ]);
  
  await fs.promises.writeFile(outputPath, content);
}
```

**ç†ç”±:**
- å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆã¯å‹•ä½œç¢ºèªãŒç›®çš„ï¼ˆå®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã¯ä¸è¦ï¼‰
- E2Eãƒ†ã‚¹ãƒˆã®ã¿å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
- Paper Serverã¯è»½é‡ã§èµ·å‹•ãŒé€Ÿã„

---

## 9. å‰ææ¡ä»¶ã¨è²¬ä»»ç¯„å›²

### **9.1 JDKManagerã®åˆæœŸåŒ–çŠ¶æ…‹**

**ç¢ºå®šä»•æ§˜:** ServerManagerã«æ¸¡ã™JDKManagerã¯å¿…ãšåˆæœŸåŒ–æ¸ˆã¿ï¼ˆãƒã‚§ãƒƒã‚¯ãªã—ï¼‰

```typescript
// âœ… æ­£ã—ã„ä½¿ç”¨æ–¹æ³•
const jdkManager = new JdkManager(path);
await jdkManager.Data.load(); // ã¾ãŸã¯ init()

const serverManager = await ServerManager.initialize(
  configPath,
  serversBasePath,
  logPath,
  jdkManager,  // â† åˆæœŸåŒ–æ¸ˆã¿
  callbacks
);
```

```typescript
// âŒ èª¤ã£ãŸä½¿ç”¨æ–¹æ³•
const jdkManager = new JdkManager(path);
// Data.load()ã‚’å‘¼ã³å‡ºã—ã¦ã„ãªã„ï¼

const serverManager = await ServerManager.initialize(
  configPath,
  serversBasePath,
  logPath,
  jdkManager,  // â† æœªåˆæœŸåŒ–
  callbacks
);
// â†’ JDKå–å¾—æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
```

**ç†ç”±:**
- ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤ãŒè²¬ä»»ã‚’æŒã¤
- ServerManagerã®è²¬ä»»ç¯„å›²ã‚’æ˜ç¢ºã«ã™ã‚‹
- åˆæœŸåŒ–é †åºã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ˜è¨˜

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¨˜è¼‰å¿…é ˆ:**
```markdown
## å‰ææ¡ä»¶

ServerManager.initialize()ã‚’å‘¼ã³å‡ºã™å‰ã«ã€ä»¥ä¸‹ã‚’å®Œäº†ã—ã¦ãã ã•ã„ï¼š

1. JDKManagerã®åˆæœŸåŒ–
   ```typescript
   const jdkManager = new JdkManager(path);
   await jdkManager.Data.load(); // ã¾ãŸã¯ init()
   ```

2. ServerManagerã®åˆæœŸåŒ–
   ```typescript
   const manager = await ServerManager.initialize(..., jdkManager, ...);
   ```
```

---

### **9.2 JDKManagerå‚ç…§ã®ä¿æŒæ–¹æ³•**

**ç¢ºå®šä»•æ§˜:** readonlyå‚ç…§

```typescript
class ServerManager {
  constructor(
    private readonly configPath: string,
    private readonly serversBasePath: string,
    private readonly logPath: string,
    private readonly jdkManager: JDKManager,  // â† readonly
    private readonly callbacks?: ServerCallbacks
  ) {
    // ...
  }
}
```

**ç†ç”±:**
- ä¸å¤‰æ€§ã‚’ä¿è¨¼
- èª¤ã£ã¦å†ä»£å…¥ã‚’é˜²ã
- TypeScriptã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

---

## 10. å®Ÿè£…å‰ã®è³ªå•äº‹é …ã¨å›ç­”ï¼ˆè¿½åŠ ï¼‰

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å®Ÿè£…é–‹å§‹å‰ã«ç¢ºèªã•ã‚ŒãŸè³ªå•äº‹é …ã¨ãã®å›ç­”ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

### **10.1 JDKManagerã¨ã®é€£æºã«é–¢ã™ã‚‹è³ªå•**

#### **Q10.1-1: JDKManager.Entrys.getByVersion()ã®æˆ»ã‚Šå€¤ã®æ‰±ã„**

**è³ªå•:**
JDKManagerã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã¯`Result<JDKEntry>`ã‚’è¿”ã—ã¾ã™ãŒã€å®Ÿè£…ä¾é ¼æ›¸ã§ã¯ã€ŒJDKEntry | nullã€ã¨è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚ã©ã¡ã‚‰ã®å½¢å¼ã§æ‰±ã†ã¹ãã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼ˆResultå‹ï¼‰ãŒæ­£ã—ã„ã§ã™ã€‚**

```typescript
// âœ… æ­£ã—ã„å®Ÿè£…
const result = jdkManager.Entrys.getByVersion(jdkVersion);
if (!result.success) {
  return { success: false, error: result.error };
}
const jdkEntry = result.data;
```

**ç†ç”±:**
- JDKManagerã¯ç‹¬è‡ªã®Resultå‹ã‚’ä½¿ç”¨
- ServerManagerã®Resultå‹ã¨ã¯åˆ¥ç‰©
- ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å«ã‚€ãŸã‚ã€ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå¯èƒ½

---

#### **Q10.1-2: JDKEntry.getExecutableFilePath()ã®ä½¿ç”¨**

**è³ªå•:**
`getExecutableFilePath()`ã‚’`ProcessExecutor.start()`ã«æ¸¡ã™javaPathã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ç†è§£ã§æ­£ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€ãã®ä½¿ç”¨æ–¹æ³•ã§æ­£ã—ã„ã§ã™ã€‚**

```typescript
// âœ… æ­£ã—ã„ä½¿ç”¨æ–¹æ³•
const javaPath = jdkEntry.getExecutableFilePath();
// Windows: "C:\runtime\jdk-17-temurin\bin\java.exe"
// Unix: "/runtime/jdk-17-temurin/bin/java"

await this.processExecutor.start(javaPath, jarPath, args);
```

---

### **10.2 ProcessExecutorã®å®Ÿè£…ã«é–¢ã™ã‚‹è³ªå•**

#### **Q10.2-1: waitForExit()ã®å®Ÿè£…æ–¹æ³•**

**è³ªå•:**
`stop()`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹éš›ã€`waitForExit()`ã¯ã©ã®ã‚ˆã†ã«å®Ÿè£…ã™ã¹ãã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼ˆã‚¿ã‚¤ãƒãƒ¼ã¨ãƒ•ãƒ©ã‚°ï¼‰ã‚’æ¨å¥¨ã—ã¾ã™ã€‚**

```typescript
// âœ… æ¨å¥¨: ãƒ‘ã‚¿ãƒ¼ãƒ³B
private async waitForExit(timeout: number): Promise<boolean> {
  if (!this.process) {
    return true;
  }
  
  return new Promise<boolean>((resolve) => {
    const timer = setTimeout(() => {
      resolve(false); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    }, timeout);
    
    // çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ï¼ˆä¸€åº¦ã ã‘ï¼‰
    this.process!.once('exit', () => {
      clearTimeout(timer);
      resolve(true); // æ­£å¸¸çµ‚äº†
    });
  });
}
```

**ç†ç”±:**
- ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã‚‚PromiseãŒæ­£å¸¸ã«è§£æ±ºã•ã‚Œã‚‹
- `stop()`ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ï¼ˆbooleanï¼‰ã¨æ•´åˆæ€§ãŒå–ã‚Œã‚‹

---

#### **Q10.2-2: readline interfaceã®è¨­å®š**

**è³ªå•:**
å®Ÿè£…ä¾é ¼æ›¸ã§ã¯ã€Œ`createInterface({ input: process.stdout })`ã€ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯èª¤ã‚Šã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€`this.process.stdout`ãŒæ­£ã—ã„ã§ã™ã€‚å®Ÿè£…ä¾é ¼æ›¸ã«èª¤è¨˜ãŒã‚ã‚Šã¾ã—ãŸã€‚**

```typescript
// âœ… æ­£ã—ã„å®Ÿè£…
const stdoutReader = createInterface({
  input: this.process.stdout,  // â† child_processã®stdout
  crlfDelay: Infinity
});

const stderrReader = createInterface({
  input: this.process.stderr,  // â† child_processã®stderr
  crlfDelay: Infinity
});
```

**èª¤è¨˜ç®‡æ‰€:**
- âŒ `process.stdout` â†’ Node.jsã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ—ãƒ­ã‚»ã‚¹
- âœ… `this.process.stdout` â†’ child_processã®stdout

---

### **10.3 ServerPropertiesManagerã®å®Ÿè£…ã«é–¢ã™ã‚‹è³ªå•**

#### **Q10.3-1: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**

**è³ªå•:**
server.propertiesãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ç‚¹ã‚’ç¢ºèªã•ã›ã¦ãã ã•ã„ï¼š
- ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¯ `#` ã§å§‹ã¾ã‚‹è¡Œã®ã¿ã§ã™ã‹ï¼Ÿ
- ç©ºç™½è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ
- `key=value` ã®å‰å¾Œã«ç©ºç™½ãŒã‚ã‚‹å ´åˆã€ãƒˆãƒªãƒ ã—ã¾ã™ã‹ï¼Ÿ
- å€¤ã« `=` ãŒå«ã¾ã‚Œã‚‹å ´åˆã€ã©ã†æ‰±ã„ã¾ã™ã‹ï¼Ÿ

**å›ç­”:**
**ä»¥ä¸‹ã®ä»•æ§˜ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚**

| é …ç›® | ä»•æ§˜ |
|------|------|
| ã‚³ãƒ¡ãƒ³ãƒˆè¡Œ | `#`ã§å§‹ã¾ã‚‹è¡Œã®ã¿ï¼ˆ`;`ã¯ä½¿ç”¨ã—ãªã„ï¼‰ |
| ç©ºç™½è¡Œ | ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ |
| å‰å¾Œã®ç©ºç™½ | ãƒˆãƒªãƒ ã™ã‚‹ï¼ˆ`key = value` â†’ `key=value`ï¼‰ |
| å€¤ã«`=`ã‚’å«ã‚€å ´åˆ | æœ€åˆã®`=`ã§åˆ†å‰²ï¼ˆ`motd=Welcome=to=Server` â†’ key: `motd`, value: `Welcome=to=Server`ï¼‰ |

**å®Ÿè£…ä¾‹:**
```typescript
private parseContent(content: string): Map<string, string> {
  const properties = new Map<string, string>();
  const lines = content.split('\n');
  
  for (const line of lines) {
    const trimmed = line.trim();
    
    // ç©ºè¡Œã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
    if (!trimmed || trimmed.startsWith('#')) {
      continue;
    }
    
    // key=valueå½¢å¼ã‚’ãƒ‘ãƒ¼ã‚¹
    const equalIndex = trimmed.indexOf('=');
    if (equalIndex === -1) {
      continue; // '='ãŒãªã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
    }
    
    const key = trimmed.substring(0, equalIndex).trim();
    const value = trimmed.substring(equalIndex + 1).trim();
    
    properties.set(key, value);
  }
  
  return properties;
}
```

---

#### **Q10.3-2: update()ãƒ¡ã‚½ãƒƒãƒ‰ã®å‹•ä½œ**

**è³ªå•:**
æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã€è©²å½“è¡Œã®ã¿ç½®ãæ›ãˆã‚‹å®Ÿè£…ã§æ­£ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€ãã®æ–¹é‡ã§æ­£ã—ã„ã§ã™ã€‚ãŸã ã—ã€è‹¥å¹²ã®ä¿®æ­£ã‚’æ¨å¥¨ã—ã¾ã™ã€‚**

```typescript
// âœ… æ¨å¥¨å®Ÿè£…
async update(key: string, value: string): Promise<void> {
  let properties: Map<string, string>;
  
  if (this.exists()) {
    properties = await this.read();
  } else {
    properties = new Map();
  }
  
  // Map.set()ã§æ›´æ–°ã¾ãŸã¯è¿½åŠ 
  properties.set(key, value);
  
  await this.write(properties);
  
  this.logger.info(`Updated property: ${key}=${value}`, {
    file: this.filePath
  });
}
```

**ç†ç”±:**
- Mapã®`set()`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€æ—¢å­˜ã‚­ãƒ¼ãªã‚‰æ›´æ–°ã€ãªã‘ã‚Œã°è¿½åŠ 
- è¡Œå˜ä½ã®å‡¦ç†ã‚ˆã‚Šç°¡æ½”
- ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚„ç©ºè¡Œã‚‚ä¿æŒã•ã‚Œã‚‹ï¼ˆ`write()`ã§å†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºï¼‰

**æ³¨æ„:**
- ã“ã®å®Ÿè£…ã ã¨ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¯å¤±ã‚ã‚Œã¾ã™
- Minecraftã®server.propertiesã§ã¯ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¯é‡è¦ã§ãªã„ãŸã‚å•é¡Œãªã—

---

### **10.4 ServerInstanceWrapperã®å®Ÿè£…ã«é–¢ã™ã‚‹è³ªå•**

#### **Q10.4-1: ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°**

**è³ªå•:**
å®Ÿè£…ä¾é ¼æ›¸ã§ã¯ã€Œstart()æˆåŠŸå¾Œã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã€ã¨ã‚ã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã®ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã—ã‚‡ã†ã‹ï¼Ÿ
- A. executeStart()ç›´å¾Œ
- B. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å¾Œ
- C. ã‚¤ãƒ™ãƒ³ãƒˆå ±å‘Šå¾Œ

**å›ç­”:**
**A. executeStart()ç›´å¾Œï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å‰ï¼‰ãŒæ­£ã—ã„ã§ã™ã€‚**

```typescript
public async start(): Promise<void> {
  // ... JDKå–å¾—ã€ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•
  
  await this.executeStart(jdkEntry);
  
  // âœ… A. executeStart()ç›´å¾Œã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
  this.startResetTimer();
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  this.data.status = 'running';
  this.data.metadata.lastStartedAt = new Date().toISOString();
  this.runtimeState.currentSessionStartTime = Date.now();
  
  // ã‚¤ãƒ™ãƒ³ãƒˆå ±å‘Š
  this.reportEvent('started');
}
```

**ç†ç”±:**
- ãƒ—ãƒ­ã‚»ã‚¹ãŒèµ·å‹•ã—ãŸç¬é–“ã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆé–‹å§‹
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚„ã‚¤ãƒ™ãƒ³ãƒˆå ±å‘Šã¯é–¢ä¿‚ãªã„
- ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹• = ç¨¼åƒé–‹å§‹ã®ãŸã‚

---

#### **Q10.4-2: RuntimeStateã®åˆæœŸåŒ–**

**è³ªå•:**
RuntimeStateã®åˆæœŸå€¤ã¯ä»¥ä¸‹ã§æ­£ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€ãã®åˆæœŸå€¤ã§æ­£ã—ã„ã§ã™ã€‚**

```typescript
// âœ… æ­£ã—ã„åˆæœŸåŒ–
private runtimeState: RuntimeState = {
  consecutiveRestartCount: 0,
  lastRestartTime: null,
  resetTimerId: null,
  currentSessionStartTime: null
};
```

---

### **10.5 ServerValidatorã®å®Ÿè£…ã«é–¢ã™ã‚‹è³ªå•**

#### **Q10.5-1: ãƒãƒ¼ãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ã®è©³ç´°**

**è³ªå•:**
`excludeUuid`ã¯ä½•ã®ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã‹ï¼ŸupdateInstance()ã§è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€`excludeUuid`ã¯è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ã™ã‚‹ãŸã‚ã§ã™ã€‚**

```typescript
validatePort(port: number, excludeUuid?: string): ValidationResult {
  const instances = this.manager.getAllInstances();
  const conflict = instances.find(inst => 
    inst.launchConfig.port === port && 
    inst.uuid !== excludeUuid  // â† è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–
  );
  
  // ...
}
```

**ä½¿ç”¨ä¾‹:**
```typescript
// addInstanceæ™‚ï¼ˆæ–°è¦è¿½åŠ ï¼‰
const portResult = validator.validatePort(25565);
// â† excludeUuidãªã—ï¼ˆã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰

// updateInstanceæ™‚ï¼ˆæ—¢å­˜æ›´æ–°ï¼‰
const portResult = validator.validatePort(25565, 'some-uuid');
// â† excludeUuidã‚ã‚Šï¼ˆè‡ªåˆ†è‡ªèº«ã¯é™¤å¤–ï¼‰
```

---

#### **Q10.5-2: ãƒ¡ãƒ¢ãƒªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è­¦å‘Šæ¡ä»¶**

**è³ªå•:**
ä¸¡æ–¹ã®æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã©ã¡ã‚‰ã‹ã«è©²å½“ã™ã‚Œã°è­¦å‘Šã‚’å‡ºã™ã€ã¨ã„ã†ç†è§£ã§æ­£ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€ä¸¡æ–¹ã®æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€è©²å½“ã™ã‚Œã°è­¦å‘Šã‚’è¿½åŠ ã—ã¾ã™ã€‚**

```typescript
const warnings: string[] = [];

// æ¡ä»¶1: ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒªã®80%è¶…é
if (maxMemory > systemMemory * 0.8) {
  warnings.push('...');
}

// æ¡ä»¶2: åˆ©ç”¨å¯èƒ½ãƒ¡ãƒ¢ãƒªè¶…é
if (maxMemory > availableMemory) {
  warnings.push('...');
}

return warnings.length > 0
  ? ValidationResultHelper.warning(warnings)
  : ValidationResultHelper.success();
```

---

### **10.6 ServerManagerã®å®Ÿè£…ã«é–¢ã™ã‚‹è³ªå•**

#### **Q10.6-1: updateInstance()ã®nameå¤‰æ›´ã¨portå¤‰æ›´ã®åŒæ™‚å‡¦ç†**

**è³ªå•:**
nameå¤‰æ›´ã¨portå¤‰æ›´ã‚’åŒæ™‚ã«è¡Œã†å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã§æ­£ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€ãã®å®Ÿè£…ã§æ­£ã—ã„ã§ã™ã€‚**

```typescript
// âœ… æ­£ã—ã„å®Ÿè£…
let currentName = instance.getData().name;

// 1. nameå¤‰æ›´ã‚’å…ˆã«å®Ÿè¡Œ
if (params.updates.name !== undefined) {
  const oldDir = path.join(this.serversBasePath, currentName);
  const newDir = path.join(this.serversBasePath, params.updates.name);
  await fs.promises.rename(oldDir, newDir);
  currentName = params.updates.name; // â† é‡è¦: ç¾åœ¨ã®åå‰ã‚’æ›´æ–°
}

// 2. portå¤‰æ›´ã¯æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’ä½¿ç”¨
if (params.updates.port !== undefined) {
  const serverDir = path.join(this.serversBasePath, currentName); // â† æ–°ã—ã„åå‰
  const serverPropertiesPath = path.join(serverDir, 'server.properties');
  const propManager = new ServerPropertiesManager(serverPropertiesPath, this.logger);
  await propManager.updatePort(params.updates.port);
}
```

---

#### **Q10.6-2: addInstance()ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¯„å›²**

**è³ªå•:**
server.propertiesä½œæˆå¤±æ•—æ™‚ã€ã©ã“ã¾ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ

**å›ç­”:**
**A. serverDirå…¨ä½“ã‚’å‰Šé™¤ï¼ˆ1, 2, 3ã‚’å‰Šé™¤ï¼‰ãŒæ­£ã—ã„ã§ã™ã€‚**

```typescript
// server.propertiesä½œæˆ
try {
  await propManager.create({ 'server-port': port.toString() });
} catch (error) {
  this.logger.error('Failed to create server.properties', error);
  
  // âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨å‰Šé™¤
  await fs.promises.rm(serverDir, { recursive: true, force: true });
  
  return {
    success: false,
    error: 'Failed to create server.properties'
  };
}
```

**ç†ç”±:**
- éƒ¨åˆ†çš„ã«ä½œæˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ®‹ã™ã¨ä¸æ•´åˆãŒç™ºç”Ÿ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†è©¦è¡Œã™ã‚‹éš›ã«å•é¡Œã«ãªã‚‹
- ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‹ã‚‰å†å®Ÿè¡Œã§ãã‚‹

---

### **10.7 ãƒ†ã‚¹ãƒˆã«é–¢ã™ã‚‹è³ªå•**

#### **Q10.7-1: test.env.jsonã®ãƒ‘ã‚¹**

**è³ªå•:**
çµ¶å¯¾ãƒ‘ã‚¹ã«çµ±ä¸€ã™ã¹ãã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚ç›¸å¯¾ãƒ‘ã‚¹ã‚‚è¨±å®¹ã•ã‚Œã¾ã™ã‹ï¼Ÿ

**å›ç­”:**
**ç›¸å¯¾ãƒ‘ã‚¹ã‚‚è¨±å®¹ã—ã¾ã™ã€‚ãŸã ã—ã€å®Ÿè¡Œæ™‚ã«çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚**

ï¼ˆå®Ÿè£…ä¾‹ã¯8.1å‚ç…§ï¼‰

---

#### **Q10.7-2: ãƒ†ã‚¹ãƒˆç”¨ã®Minecraft Server jar**

**è³ªå•:**
E2Eãƒ†ã‚¹ãƒˆã§ã¯å®Ÿéš›ã®jarã‚’ä½¿ç”¨ã—ã€å˜ä½“ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆã§ã¯ãƒ¢ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã€ã¨ã„ã†ç†è§£ã§æ­£ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€ãã®ç†è§£ã§æ­£ã—ã„ã§ã™ã€‚**

ï¼ˆè©³ç´°ã¯8.2å‚ç…§ï¼‰

---

### **10.8 ãã®ä»–ã®è³ªå•**

#### **Q10.8-1: ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®ä½¿ã„åˆ†ã‘**

**è³ªå•:**
ä»¥ä¸‹ã®ã‚ˆã†ãªå ´åˆã€ã©ã®ãƒ¬ãƒ™ãƒ«ã‚’ä½¿ç”¨ã™ã¹ãã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**

**ã‚±ãƒ¼ã‚¹1: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§è­¦å‘ŠãŒå‡ºãŸå ´åˆ**
```typescript
// âœ… warn ã‚’ä½¿ç”¨
if (validation.warnings && validation.warnings.length > 0) {
  validation.warnings.forEach(warning => {
    this.logger.warn(warning);
  });
}
```

**ã‚±ãƒ¼ã‚¹2: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•—ï¼ˆå…¨å‡¦ç†ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰**
```typescript
// âœ… error ã‚’ä½¿ç”¨
try {
  await fs.promises.rm(serverDir, { recursive: true, force: true });
} catch (error) {
  this.logger.error(`Failed to delete directory: ${serverDir}`, error);
  return { success: false, error: '...' };
}
```

**ã‚±ãƒ¼ã‚¹3: server.propertiesæ›´æ–°å¤±æ•—ï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰**
```typescript
// âœ… warn ã‚’ä½¿ç”¨
try {
  await propManager.updatePort(port);
} catch (error) {
  this.logger.warn('Failed to update server.properties', error);
  // å‡¦ç†ã¯ç¶™ç¶š
}
```

**åŸå‰‡:**
- å‡¦ç†ã‚’ç¶™ç¶šã§ãã‚‹ â†’ `warn` + å‡¦ç†ç¶™ç¶š
- å‡¦ç†ã‚’ç¶™ç¶šã§ããªã„ â†’ `error` + ã‚¨ãƒ©ãƒ¼è¿”å´

---

#### **Q10.8-2: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´æ™‚ã®å‹•ä½œ**

**è³ªå•:**
è­¦å‘Šã®ã¿ã§å‡¦ç†ç¶šè¡Œã—ã€Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ä»»ã›ã‚‹å®Ÿè£…ã§æ­£ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”:**
**ã¯ã„ã€ãã®å®Ÿè£…ã§æ­£ã—ã„ã§ã™ã€‚**

ï¼ˆå®Ÿè£…ä¾‹ã¯7.1å‚ç…§ï¼‰

---

### **10.9 è¿½åŠ ã®è£œè¶³äº‹é …**

#### **è£œè¶³1: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€æ–¹é‡**

```mermaid
flowchart TD
    Error[ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ] --> Type{å‡¦ç†ç¶™ç¶šå¯èƒ½?}
    
    Type -->|Yes| Warn[logger.warn]
    Type -->|No| ErrorLog[logger.error]
    
    Warn --> Continue[å‡¦ç†ç¶™ç¶š]
    ErrorLog --> Return[Errorè¿”å´]
    
    style Warn fill:#fff9c4
    style ErrorLog fill:#ffcdd2
    style Continue fill:#c8e6c9
```

---

#### **è£œè¶³2: ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã®å¿…è¦æ€§**

```typescript
// âŒ é–“é•ã„: å‚ç…§ã‚’è¿”ã™
public getData(): ServerInstance {
  return this.data; // â† å¤–éƒ¨ã‹ã‚‰ç›´æ¥å¤‰æ›´å¯èƒ½ã«ãªã‚‹
}

// âœ… æ­£ã—ã„: ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã‚’è¿”ã™
public getData(): ServerInstance {
  return JSON.parse(JSON.stringify(this.data));
}
```

---

#### **è£œè¶³3: ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢**

```typescript
// âœ… æ­£ã—ã„: ã‚¿ã‚¤ãƒãƒ¼ã‚’å¿…ãšã‚¯ãƒªã‚¢
private clearResetTimer(): void {
  if (this.runtimeState.resetTimerId) {
    clearTimeout(this.runtimeState.resetTimerId);
    this.runtimeState.resetTimerId = null; // â† é‡è¦: nullã«æˆ»ã™
  }
}

// ServerManagerã® uptimeIntervals ã‚‚åŒæ§˜
private stopUptimeTracking(uuid: string): void {
  const timer = this.uptimeIntervals.get(uuid);
  if (timer) {
    clearInterval(timer);
    this.uptimeIntervals.delete(uuid); // â† é‡è¦: Mapã‹ã‚‰å‰Šé™¤
  }
}
```

---

## ğŸ“Š ç¢ºå®šã—ãŸä»•æ§˜ä¸€è¦§è¡¨ï¼ˆæ›´æ–°ç‰ˆï¼‰

| é …ç›® | æ¡ç”¨æ¡ˆ | å„ªå…ˆåº¦ | è¿½åŠ æ—¥ |
|------|--------|--------|--------|
| removeInstanceã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ã‚’å…ˆã«å®Ÿè¡Œ | é«˜ | v1.0.1 |
| addInstanceã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨å‰Šé™¤ã€å…ƒjarã¯ä¿æŒ | é«˜ | v1.0.1 |
| stopServerã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§forceKill | é«˜ | v1.0.1 |
| **ProcessExecutor.stop()ã®æˆ»ã‚Šå€¤** | **Promise<boolean>** | **é«˜** | **v1.0.2** |
| AddInstanceResultæ§‹é€  | ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å½¢å¼ | é«˜ | v1.0.1 |
| **JDKManager.getByVersion()** | **Result<JDKEntry>å‹** | **é«˜** | **v1.0.2** |
| **JDKEntryä½¿ç”¨** | **getExecutableFilePath()** | **é«˜** | **v1.0.2** |
| **waitForExit()å®Ÿè£…** | **ã‚¿ã‚¤ãƒãƒ¼ã¨ãƒ•ãƒ©ã‚°æ–¹å¼** | **é«˜** | **v1.0.2** |
| **readline interface** | **this.process.stdout** | **é«˜** | **v1.0.2** |
| JDKManageråˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯ | ãƒã‚§ãƒƒã‚¯ãªã—ï¼ˆå‰ææ¡ä»¶ï¼‰ | ä¸­ | v1.0.1 |
| ç¨¼åƒæ™‚é–“è¨ˆç®— | ç¾åœ¨æ™‚åˆ» - èµ·å‹•æ™‚åˆ» | ä¸­ | v1.0.1 |
| ãƒãƒ¼ãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ | å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€ç¨¼åƒä¸­ã¯ã‚¨ãƒ©ãƒ¼ | ä¸­ | v1.0.1 |
| **excludeUuidã®ç”¨é€”** | **è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–** | **ä¸­** | **v1.0.2** |
| ãƒ¡ãƒ¢ãƒªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | totalmemã®80%ã€å˜ä¸€ã‚µãƒ¼ãƒãƒ¼ã®ã¿ | ä¸­ | v1.0.1 |
| **ãƒ¡ãƒ¢ãƒªè­¦å‘Šæ¡ä»¶** | **ä¸¡æ–¹ãƒã‚§ãƒƒã‚¯** | **ä¸­** | **v1.0.2** |
| ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ | start()æˆåŠŸå¾Œ | ä¸­ | v1.0.1 |
| **ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼è©³ç´°** | **executeStart()ç›´å¾Œ** | **ä¸­** | **v1.0.2** |
| ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆæ¡ä»¶ | èµ·å‹•ã‹ã‚‰10åˆ†å¾Œ | ä¸­ | v1.0.1 |
| **ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼** | **#ã‚³ãƒ¡ãƒ³ãƒˆã€ç©ºè¡Œã‚¹ã‚­ãƒƒãƒ—** | **ä¸­** | **v1.0.2** |
| **update()ãƒ¡ã‚½ãƒƒãƒ‰** | **Map.set()ä½¿ç”¨** | **ä¸­** | **v1.0.2** |
| **name+portåŒæ™‚å¤‰æ›´** | **currentNameè¿½è·¡** | **ä¸­** | **v1.0.2** |
| JDKManagerå‚ç…§ | readonly | ä½ | v1.0.1 |
| åœæ­¢æ™‚ã®ç¨¼åƒæ™‚é–“æ›´æ–° | å³åº§ã«å®Ÿè¡Œ | ä½ | v1.0.1 |
| è¨­å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ | è­¦å‘Šã®ã¿ | ä½ | v1.0.1 |
| è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã— | initialize()æ™‚ã«ã‚¨ãƒ©ãƒ¼ | ä½ | v1.0.1 |
| forceKillServer | å³åº§ã«return | ä½ | v1.0.1 |
| VoidResult | ä¸€è²«ã—ã¦ä½¿ç”¨ | ä½ | v1.0.1 |
| **test.env.json** | **ç›¸å¯¾ãƒ‘ã‚¹è¨±å®¹ã€å®Ÿè¡Œæ™‚å¤‰æ›** | **ä½** | **v1.0.2** |
| **ãƒ†ã‚¹ãƒˆç”¨jar** | **ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã§ä½¿ã„åˆ†ã‘** | **ä½** | **v1.0.2** |
| **ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«** | **ç¶™ç¶šå¯èƒ½=warnã€ä¸å¯=error** | **ä½** | **v1.0.2** |
| FAQè¨˜è¼‰ç¯„å›² | å®Ÿéš›ã®å•é¡Œã®ã¿ | ä½ | v1.0.1 |

---

## âœ… ã¾ã¨ã‚

### **v1.0.2ã§ã®ä¸»ãªå¤‰æ›´ç‚¹**

1. **ProcessExecutor.stop()ã®æˆ»ã‚Šå€¤ã‚’æ˜ç¢ºåŒ–**
   - `Promise<boolean>`ã‚’è¿”ã™
   - `true` = æ­£å¸¸åœæ­¢ã€`false` = ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

2. **JDKManagerã¨ã®é€£æºã‚’æ˜ç¢ºåŒ–**
   - `getByVersion()`ã¯`Result<JDKEntry>`å‹
   - `getExecutableFilePath()`ã‚’ä½¿ç”¨

3. **å®Ÿè£…ã®è©³ç´°ã‚’è¿½åŠ **
   - readline interfaceã®æ­£ã—ã„è¨­å®š
   - waitForExit()ã®æ¨å¥¨å®Ÿè£…æ–¹æ³•
   - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä»•æ§˜
   - update()ãƒ¡ã‚½ãƒƒãƒ‰ã®æ¨å¥¨å®Ÿè£…

4. **ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æŸ”è»Ÿæ€§ã‚’å‘ä¸Š**
   - test.env.jsonã§ç›¸å¯¾ãƒ‘ã‚¹è¨±å®¹
   - ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã”ã¨ã®jarä½¿ã„åˆ†ã‘

5. **ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®ä½¿ã„åˆ†ã‘ã‚’æ˜ç¢ºåŒ–**
   - å‡¦ç†ç¶™ç¶šå¯èƒ½ â†’ warn
   - å‡¦ç†ç¶™ç¶šä¸å¯ â†’ error

---

**ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€å®Ÿè£…ä¾é ¼æ›¸ã®è£œè¶³ã¨ã—ã¦ã€è³ªå•å›ç­”ã«åŸºã¥ãä»•æ§˜ã®æ˜ç¢ºåŒ–ã‚’æä¾›ã—ã¾ã™ã€‚**

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0.2  
**æœ€çµ‚æ›´æ–°:** 2025-11-03

---

**ğŸš€ å®Ÿè£…ã‚’é–‹å§‹ã§ãã¾ã™ï¼**