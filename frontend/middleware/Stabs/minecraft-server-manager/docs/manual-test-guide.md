# Minecraft Server Manager - 手動テストガイド

このドキュメントは、Minecraft Server Managerの手動テスト項目を列挙しています。自動テストでカバーできない項目や、実際のMinecraft Serverを使用した動作確認が必要な項目を記載しています。

## 目次

- [前提条件](#前提条件)
- [環境準備](#環境準備)
- [テストカテゴリ](#テストカテゴリ)
  - [1. インストールと初期化](#1-インストールと初期化)
  - [2. サーバーライフサイクル](#2-サーバーライフサイクル)
  - [3. コンソール入出力](#3-コンソール入出力)
  - [4. 自動再起動](#4-自動再起動)
  - [5. 複数サーバー管理](#5-複数サーバー管理)
  - [6. パフォーマンスと安定性](#6-パフォーマンスと安定性)
  - [7. エラーハンドリング](#7-エラーハンドリング)
  - [8. JDK統合](#8-jdk統合)

---

## 前提条件

### 必要なソフトウェア

- **Node.js**: v18.x以上
- **TypeScript**: 5.x以上
- **JDK**: 8, 17, 21のいずれか（テストするMinecraftバージョンに応じて）
- **Minecraft Server**: 
  - Vanilla Server jar (1.20.x推奨)
  - Paper Server jar (オプション)
  - その他のサーバーソフトウェア (オプション)

### 必要なディスク容量

- 最小: 5GB (JDK + Minecraft Server + ワールドデータ)
- 推奨: 10GB以上

### 必要なメモリ

- 最小: 4GB RAM
- 推奨: 8GB RAM以上

---

## 環境準備

### 1. プロジェクトのセットアップ

```bash
# プロジェクトディレクトリに移動
cd frontend/middleware/driver/Stabtest/minecraft-server-manager

# 依存関係のインストール
npm install

# TypeScriptのビルド
npx tsc
```

### 2. JDKManagerのセットアップ

```bash
# JDKManagerディレクトリに移動
cd ../jdk-manager

# JDKManagerの依存関係をインストール
npm install

# JDKをインストール（必要に応じて）
# 詳細はJDKManagerのドキュメントを参照
```

### 3. Minecraft Server Jarの準備

```bash
# テスト用ディレクトリを作成
mkdir -p test-servers/jars

# Vanilla Serverをダウンロード
# 例: 1.20.1
wget https://piston-data.mojang.com/v1/objects/84194a2f286ef7c14ed7ce0090dba59902951553/server.jar \
  -O test-servers/jars/vanilla-1.20.1.jar

# または公式サイトから手動でダウンロード
# https://www.minecraft.net/en-us/download/server
```

### 4. テスト環境設定ファイルの作成

`tests/manual-test.env.json` を作成:

```json
{
  "jdkManager": {
    "configPath": "../jdk-manager/config/registry.json"
  },
  "serverJars": {
    "vanilla_1_20_1": "../../test-servers/jars/vanilla-1.20.1.jar",
    "paper_1_20_1": "../../test-servers/jars/paper-1.20.1.jar"
  },
  "testPaths": {
    "configDir": "./manual-test-data/config",
    "serversDir": "./manual-test-data/servers",
    "logsDir": "./manual-test-data/logs"
  }
}
```

---

## テストカテゴリ

## 1. インストールと初期化

### MT-001: 初回起動とデフォルト設定の作成

**目的**: ServerManagerが正常に初期化され、デフォルト設定ファイルが作成されることを確認

**手順**:
1. 設定ファイルが存在しない状態でServerManager.initialize()を実行
2. 設定ファイルが作成されることを確認
3. 設定ファイルの内容を確認

**期待結果**:
- `configPath`に指定した場所に設定ファイルが作成される
- 設定ファイルにconfigVersion, instances, lastUpdatedが含まれる
- instances配列が空である

**確認ポイント**:
- [ ] 設定ファイルが正しい場所に作成される
- [ ] JSON形式が正しい
- [ ] タイムスタンプが現在時刻である

---

### MT-002: 既存設定の読み込み

**目的**: 既存の設定ファイルを正常に読み込めることを確認

**手順**:
1. サーバーインスタンスを1つ追加
2. ServerManagerを終了（dispose）
3. 同じ設定ファイルでServerManagerを再初期化
4. サーバーインスタンスが復元されることを確認

**期待結果**:
- 以前のサーバーインスタンスがすべて復元される
- 設定（名前、ポート、メモリなど）が保持されている

**確認ポイント**:
- [ ] インスタンス数が一致
- [ ] 各インスタンスの設定が完全に復元される
- [ ] UUIDが変更されていない

---

## 2. サーバーライフサイクル

### MT-101: サーバーインスタンスの追加

**目的**: 新しいMinecraftサーバーインスタンスを追加できることを確認

**手順**:
1. `addInstance()`を呼び出し、以下のパラメータを指定:
   - name: "test-server-1"
   - jdkVersion: 17
   - serverBinaryFilePath: (準備したjarのパス)
   - port: 25565
   - memory: { min: 1024, max: 2048 }
2. 戻り値を確認
3. ファイルシステムを確認

**期待結果**:
- `success: true` が返される
- UUIDが生成される
- サーバーディレクトリが作成される
- server.propertiesが作成される
- eula.txtが作成される（eula=true）

**確認ポイント**:
- [ ] サーバーディレクトリ: `serversBasePath/test-server-1/`
- [ ] server.properties内のポート設定が正しい
- [ ] eula.txtに`eula=true`が含まれる
- [ ] 設定ファイルにインスタンスが追加される

---

### MT-102: サーバーの起動

**目的**: Minecraftサーバーを正常に起動できることを確認

**手順**:
1. MT-101で追加したサーバーを起動
2. サーバーログを監視
3. サーバーのステータスを確認

**期待結果**:
- `startServer()` が `success: true` を返す
- サーバープロセスが起動する
- ログに"Done"または起動完了メッセージが表示される
- ステータスが`running`になる

**確認ポイント**:
- [ ] プロセスIDが取得できる
- [ ] ポートがリッスンしている（`netstat`等で確認）
- [ ] Minecraftクライアントから接続可能
- [ ] JDKのロックが取得されている

**確認コマンド**:
```bash
# ポートの確認（Windows）
netstat -an | findstr :25565

# ポートの確認（Linux/Mac）
netstat -an | grep 25565
```

---

### MT-103: サーバーへのコマンド送信

**目的**: 実行中のサーバーにコマンドを送信できることを確認

**手順**:
1. サーバーを起動
2. `sendServerCommand(uuid, "list")` を実行
3. `sendServerCommand(uuid, "help")` を実行
4. コンソール出力を確認

**期待結果**:
- コマンドが正常に送信される
- サーバーがコマンドを実行する
- 標準出力に結果が表示される

**確認ポイント**:
- [ ] "list"コマンドで現在のプレイヤー数が表示される
- [ ] "help"コマンドでヘルプメッセージが表示される
- [ ] エラーが発生しない

---

### MT-104: サーバーの停止（正常停止）

**目的**: サーバーを正常に停止できることを確認

**手順**:
1. サーバーを起動
2. 10秒待機
3. `stopServer(uuid, 30000)` を実行
4. 停止を待つ

**期待結果**:
- `success: true` が返される
- サーバーが"stop"コマンドで停止する
- タイムアウト時間内に停止する
- ステータスが`stopped`になる

**確認ポイント**:
- [ ] プロセスが終了している
- [ ] ポートが解放されている
- [ ] JDKのロックが解放されている
- [ ] ワールドデータが保存されている

---

### MT-105: サーバーの強制終了

**目的**: タイムアウト後にサーバーを強制終了できることを確認

**手順**:
1. サーバーを起動
2. `stopServer(uuid, 100)` を実行（短いタイムアウト）
3. タイムアウト後の動作を確認

**期待結果**:
- タイムアウト後、`onStopTimeout`コールバックが呼ばれる
- `forceKillServer()`を手動で呼び出すとプロセスが強制終了される

**確認ポイント**:
- [ ] タイムアウトが発生する
- [ ] プロセスが強制終了される
- [ ] リソースがクリーンアップされる

---

### MT-106: サーバーの再起動

**目的**: サーバーを再起動できることを確認

**手順**:
1. サーバーを起動
2. 10秒待機
3. `restartServer(uuid, 30000)` を実行
4. 再起動を待つ

**期待結果**:
- サーバーが停止される
- サーバーが再度起動される
- ステータスが`running`に戻る
- 稼働時間がリセットされない（累積される）

**確認ポイント**:
- [ ] プロセスIDが変更される
- [ ] ワールドデータが保持される
- [ ] 稼働時間が継続してカウントされる

---

## 3. コンソール入出力

### MT-201: 標準出力のリアルタイム取得

**目的**: サーバーの標準出力をリアルタイムで取得できることを確認

**手順**:
1. サーバーを起動
2. `openProcessStd()`でstdoutコールバックを登録
3. サーバーログを監視
4. `list`コマンドを送信
5. 出力を確認

**期待結果**:
- サーバー起動時のログがリアルタイムで受信される
- コマンド実行結果が受信される
- 出力が正しい順序で受信される

**確認ポイント**:
- [ ] 起動メッセージが受信される
- [ ] "Done"メッセージが受信される
- [ ] listコマンドの結果が受信される
- [ ] タイムスタンプ順に受信される

---

### MT-202: 標準エラー出力の取得

**目的**: エラーメッセージを正常に取得できることを確認

**手順**:
1. サーバーを起動
2. `openProcessStd()`でstderrコールバックを登録
3. 意図的にエラーを発生させる（不正なコマンドなど）
4. エラー出力を確認

**期待結果**:
- エラーメッセージが標準エラー出力に出力される
- stderrコールバックが呼ばれる

**確認ポイント**:
- [ ] エラーメッセージが受信される
- [ ] stdoutとstderrが区別される

---

### MT-203: 複数のリスナー登録

**目的**: 複数のリスナーを登録できることを確認

**手順**:
1. サーバーを起動
2. 2つの異なるstdoutコールバックを登録
3. サーバーログを確認

**期待結果**:
- 両方のコールバックが呼ばれる
- 同じメッセージが両方のコールバックに渡される

**確認ポイント**:
- [ ] 両リスナーが呼ばれる
- [ ] メッセージが重複しない
- [ ] リスナーの順序が保証される

---

## 4. 自動再起動

### MT-301: 自動再起動の有効化

**目的**: 自動再起動機能が正常に動作することを確認

**手順**:
1. 自動再起動を有効にしたサーバーを追加:
   ```typescript
   autoRestart: {
     enabled: true,
     maxConsecutiveRestarts: 3,
     consecutiveRestartResetTime: 600000 // 10分
   }
   ```
2. サーバーを起動
3. サーバーをクラッシュさせる（killコマンドなど）
4. 自動再起動を確認

**期待結果**:
- サーバーがクラッシュする
- 自動的に再起動される
- ステータスが`crashed` → `running`に変わる
- consecutiveRestartCountが増加する

**確認ポイント**:
- [ ] 自動再起動が実行される
- [ ] カウンターが正しく増加する
- [ ] ログに再起動メッセージが記録される

---

### MT-302: 連続再起動の制限

**目的**: 最大連続再起動回数を超えると停止することを確認

**手順**:
1. maxConsecutiveRestarts=2のサーバーを追加
2. サーバーを起動
3. 3回連続でクラッシュさせる

**期待結果**:
- 1回目と2回目のクラッシュ後は自動再起動される
- 3回目のクラッシュ後は自動再起動されない
- エラーログが記録される

**確認ポイント**:
- [ ] 2回は再起動される
- [ ] 3回目は再起動されない
- [ ] ステータスが`crashed`のまま
- [ ] エラーコールバックが呼ばれる

---

### MT-303: 再起動カウンターのリセット

**目的**: 時間経過後に再起動カウンターがリセットされることを確認

**手順**:
1. consecutiveRestartResetTime=60000（1分）のサーバーを追加
2. サーバーをクラッシュさせる（consecutiveRestartCount=1）
3. 1分以上待機
4. 再度クラッシュさせる

**期待結果**:
- 1分経過後、consecutiveRestartCountが0にリセットされる
- 2回目のクラッシュでcount=1になる

**確認ポイント**:
- [ ] タイマーが正常に動作する
- [ ] カウンターがリセットされる
- [ ] リセット後も自動再起動が機能する

---

## 5. 複数サーバー管理

### MT-401: 複数サーバーの同時起動

**目的**: 複数のサーバーを同時に起動・管理できることを確認

**手順**:
1. 3つのサーバーを異なるポートで追加:
   - Server A: port 25565
   - Server B: port 25566
   - Server C: port 25567
2. 3つすべてを起動
3. それぞれのステータスを確認

**期待結果**:
- 3つすべてのサーバーが起動する
- ポートの競合が発生しない
- すべてのステータスが`running`

**確認ポイント**:
- [ ] 3つのプロセスが起動している
- [ ] 各サーバーが独立して動作している
- [ ] JDKロックが3つ取得されている
- [ ] メモリ消費が適切

---

### MT-402: ポート競合の検出

**目的**: ポート競合を正しく検出できることを確認

**手順**:
1. ポート25565でサーバーを起動
2. 同じポート25565で別のサーバーを追加しようとする

**期待結果**:
- バリデーションエラーが発生する
- エラーメッセージに"port is in use"が含まれる
- 2つ目のサーバーは追加されない

**確認ポイント**:
- [ ] バリデーションが機能する
- [ ] 適切なエラーメッセージが表示される
- [ ] 実行中サーバーに影響しない

---

### MT-403: サーバー間の独立性

**目的**: 各サーバーが独立して動作することを確認

**手順**:
1. 2つのサーバーを起動
2. Server Aにコマンドを送信
3. Server Bにコマンドを送信
4. 各サーバーの出力を確認

**期待結果**:
- コマンドが正しいサーバーに送信される
- 他のサーバーに影響しない
- 出力が混在しない

**確認ポイント**:
- [ ] コマンドが正しいサーバーに届く
- [ ] 出力が分離されている
- [ ] プロセスが独立している

---

## 6. パフォーマンスと安定性

### MT-501: 長時間稼働テスト

**目的**: サーバーが長時間安定して稼働することを確認

**手順**:
1. サーバーを起動
2. 30分以上稼働させる
3. メモリリーク、クラッシュがないことを確認

**期待結果**:
- サーバーがクラッシュしない
- メモリ使用量が安定している
- ログが正常に記録される

**確認ポイント**:
- [ ] プロセスが継続して動作
- [ ] メモリ使用量が一定範囲内
- [ ] CPUusageが安定
- [ ] 稼働時間が正確にカウントされる

---

### MT-502: 高負荷時の動作

**目的**: 高負荷時でも安定して動作することを確認

**手順**:
1. サーバーを起動
2. 複数のMinecraftクライアントから同時接続
3. ワールド生成など負荷の高い操作を実行
4. ServerManagerの動作を確認

**期待結果**:
- ServerManagerが応答し続ける
- コマンド送信が機能する
- ログ取得が継続する

**確認ポイント**:
- [ ] ServerManagerが応答する
- [ ] コマンドが遅延なく送信される
- [ ] ログが欠落しない

---

### MT-503: メモリ制限の遵守

**目的**: 設定したメモリ制限が正しく適用されることを確認

**手順**:
1. memory: { min: 1024, max: 2048 } でサーバーを起動
2. プロセスのメモリ使用量を監視
3. JVMフラグを確認

**期待結果**:
- JVMに-Xms1024M -Xmx2048Mが渡される
- メモリ使用量が設定範囲内

**確認ポイント**:
- [ ] JVMフラグが正しい
- [ ] メモリ使用量が上限を超えない
- [ ] 下限値が確保される

**確認コマンド**:
```bash
# プロセス情報の確認（Windows）
wmic process where "name='java.exe'" get commandline

# プロセス情報の確認（Linux/Mac）
ps aux | grep java
```

---

## 7. エラーハンドリング

### MT-601: JDK未インストールエラー

**目的**: JDKが未インストールの場合に適切なエラーを返すことを確認

**手順**:
1. インストールされていないJDKバージョン（例: 99）を指定
2. サーバーを追加しようとする

**期待結果**:
- バリデーションエラーが発生する
- エラーメッセージに"JDK not installed"が含まれる

**確認ポイント**:
- [ ] 追加が拒否される
- [ ] エラーメッセージが明確
- [ ] システムに影響しない

---

### MT-602: Server Jar不正エラー

**目的**: 不正なjarファイルを指定した場合のエラーを確認

**手順**:
1. 存在しないjarパスを指定
2. テキストファイルをjarとして指定

**期待結果**:
- バリデーションエラーが発生する
- ファイルが存在しない場合: "File not found"
- 不正なファイルの場合: "Invalid jar file"

**確認ポイント**:
- [ ] ファイル存在チェックが機能
- [ ] ファイル形式チェックが機能
- [ ] 適切なエラーメッセージ

---

### MT-603: 起動失敗時のリカバリ

**目的**: サーバー起動失敗時に適切に処理されることを確認

**手順**:
1. 意図的に起動失敗させる（不正なJVMフラグなど）
2. エラーを確認
3. リトライを試みる

**期待結果**:
- エラーが適切に捕捉される
- ステータスが`stopped`または`crashed`になる
- リソースがクリーンアップされる
- 再試行が可能

**確認ポイント**:
- [ ] エラーがログに記録される
- [ ] プロセスが残らない
- [ ] JDKロックが解放される
- [ ] 再試行が可能

---

## 8. JDK統合

### MT-701: JDKロックの取得と解放

**目的**: JDKManagerとの統合が正常に動作することを確認

**手順**:
1. サーバーを起動
2. JDKのロック状態を確認
3. サーバーを停止
4. ロックが解放されることを確認

**期待結果**:
- 起動時にuseRuntime()が呼ばれる
- ロックIDが取得される
- 停止時にunUseRuntime()が呼ばれる
- ロックが解放される

**確認ポイント**:
- [ ] ロックが正しく取得される
- [ ] ロックIDが記録される
- [ ] 停止時にロックが解放される
- [ ] JDKManagerの状態が一致

---

### MT-702: 異なるJDKバージョンの使用

**目的**: 異なるJDKバージョンを使用したサーバーを管理できることを確認

**手順**:
1. JDK 8でServer Aを起動
2. JDK 17でServer Bを起動
3. JDK 21でServer Cを起動
4. すべてのサーバーが正常に動作することを確認

**期待結果**:
- 各サーバーが指定されたJDKで起動する
- JDKバージョンの混在に問題がない

**確認ポイント**:
- [ ] 各サーバーが正しいJavaバージョンで起動
- [ ] JDKロックが適切に管理される
- [ ] バージョン間で干渉しない

---

## テスト実行チェックリスト

### 基本機能テスト

- [ ] MT-001: 初回起動とデフォルト設定の作成
- [ ] MT-002: 既存設定の読み込み
- [ ] MT-101: サーバーインスタンスの追加
- [ ] MT-102: サーバーの起動
- [ ] MT-103: サーバーへのコマンド送信
- [ ] MT-104: サーバーの停止（正常停止）
- [ ] MT-106: サーバーの再起動

### コンソールI/O テスト

- [ ] MT-201: 標準出力のリアルタイム取得
- [ ] MT-202: 標準エラー出力の取得
- [ ] MT-203: 複数のリスナー登録

### 自動再起動テスト

- [ ] MT-301: 自動再起動の有効化
- [ ] MT-302: 連続再起動の制限
- [ ] MT-303: 再起動カウンターのリセット

### 複数サーバー管理テスト

- [ ] MT-401: 複数サーバーの同時起動
- [ ] MT-402: ポート競合の検出
- [ ] MT-403: サーバー間の独立性

### パフォーマンステスト

- [ ] MT-501: 長時間稼働テスト
- [ ] MT-502: 高負荷時の動作
- [ ] MT-503: メモリ制限の遵守

### エラーハンドリングテスト

- [ ] MT-601: JDK未インストールエラー
- [ ] MT-602: Server Jar不正エラー
- [ ] MT-603: 起動失敗時のリカバリ

### JDK統合テスト

- [ ] MT-701: JDKロックの取得と解放
- [ ] MT-702: 異なるJDKバージョンの使用

### 高度な機能テスト（オプション）

- [ ] MT-105: サーバーの強制終了

---

## テスト実行ログテンプレート

各テストを実行した際は、以下の情報を記録してください:

```
テストID: MT-XXX
テスト名: XXXXXXXXXX
実行日時: YYYY-MM-DD HH:MM:SS
テスター: [名前]
環境: 
  - OS: Windows/Linux/Mac
  - Node.js: vX.X.X
  - JDK: vXX
  - Minecraft Server: vX.XX.X

実行結果: ✓ 成功 / ✗ 失敗
所要時間: XX分XX秒

確認項目:
  - [ ] 項目1
  - [ ] 項目2
  - [ ] 項目3

備考:
  [特記事項があれば記入]

エラー（該当する場合）:
  [エラーメッセージ、スタックトレース等]
```

---

## トラブルシューティング

### サーバーが起動しない

**確認項目**:
1. JDKが正しくインストールされているか
2. Server jarファイルが存在し、アクセス可能か
3. ポートが既に使用されていないか
4. メモリ設定が適切か（システムメモリを超えていないか）
5. eula.txtが正しく作成されているか

**デバッグコマンド**:
```bash
# ポート確認
netstat -an | grep 25565

# Javaプロセス確認
ps aux | grep java

# メモリ使用量確認
free -m  # Linux
```

### ログが取得できない

**確認項目**:
1. `openProcessStd()`が正しく呼ばれているか
2. ログディレクトリが存在するか
3. ログファイルの書き込み権限があるか
4. Pinoロガーが正しく初期化されているか

### 自動再起動が機能しない

**確認項目**:
1. `autoRestart.enabled`がtrueか
2. `maxConsecutiveRestarts`が0より大きいか
3. クラッシュが正しく検出されているか
4. イベントリスナーが登録されているか

---

## 付録

### A. テストデータの準備スクリプト

```bash
#!/bin/bash
# setup-test-environment.sh

# テストディレクトリの作成
mkdir -p manual-test-data/{config,servers,logs}

# Minecraft Server jarのダウンロード（Vanilla 1.20.1）
wget -O manual-test-data/servers/vanilla-1.20.1.jar \
  https://piston-data.mojang.com/v1/objects/84194a2f286ef7c14ed7ce0090dba59902951553/server.jar

echo "Test environment setup complete!"
```

### B. テスト結果サマリーテンプレート

```
# Minecraft Server Manager - 手動テスト結果サマリー

テスト実施日: YYYY-MM-DD
テスター: [名前]
バージョン: [バージョン番号]

## テスト結果概要

- 実施テスト数: XX
- 成功: XX
- 失敗: XX
- スキップ: XX
- 成功率: XX%

## カテゴリ別結果

| カテゴリ | 実施 | 成功 | 失敗 |
|---------|-----|-----|-----|
| インストールと初期化 | X | X | X |
| サーバーライフサイクル | X | X | X |
| コンソール入出力 | X | X | X |
| 自動再起動 | X | X | X |
| 複数サーバー管理 | X | X | X |
| パフォーマンスと安定性 | X | X | X |
| エラーハンドリング | X | X | X |
| JDK統合 | X | X | X |

## 発見された問題

1. [問題の説明]
   - 重要度: 高/中/低
   - 該当テスト: MT-XXX
   - 再現手順: ...

## 推奨事項

1. [推奨事項1]
2. [推奨事項2]

## 次回テストの改善点

1. [改善点1]
2. [改善点2]
```

---

**ドキュメントバージョン**: 1.0.0  
**最終更新日**: 2025-11-03  
**作成者**: Minecraft Server Manager Team
