//sonnet 4.5
# Minecraft Server Manager - å®Ÿè£…ä¾é ¼æ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0.0  
**ä½œæˆæ—¥:** 2025-11-03  
**å¯¾è±¡:** ã‚³ãƒ¼ãƒ€ãƒ¼ãƒ»å®Ÿè£…æ‹…å½“è€…

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#1-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
2. [ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#2-ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
3. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ](#3-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ)
4. [å‹å®šç¾©](#4-å‹å®šç¾©)
5. [ã‚¯ãƒ©ã‚¹å®Ÿè£…ä»•æ§˜](#5-ã‚¯ãƒ©ã‚¹å®Ÿè£…ä»•æ§˜)
6. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æŒ‡é‡](#6-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æŒ‡é‡)
7. [ãƒ†ã‚¹ãƒˆä»•æ§˜](#7-ãƒ†ã‚¹ãƒˆä»•æ§˜)
8. [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæŒ‡ç¤º](#8-ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæŒ‡ç¤º)
9. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#9-å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### **ç›®çš„**

Node.js + TypeScriptç’°å¢ƒã§ã€è¤‡æ•°ã®Minecraftã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’çµ±åˆç®¡ç†ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### **ä¸»è¦æ©Ÿèƒ½**

```mermaid
mindmap
  root((Server Manager))
    ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
      è¿½åŠ ãƒ»å‰Šé™¤ãƒ»æ›´æ–°
      ä¸€è¦§å–å¾—
      ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
    ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«åˆ¶å¾¡
      èµ·å‹•ãƒ»åœæ­¢ãƒ»å†èµ·å‹•
      å¼·åˆ¶çµ‚äº†
      è‡ªå‹•å†èµ·å‹•
    å…¥å‡ºåŠ›ç®¡ç†
      æ¨™æº–å…¥å‡ºåŠ›ç›£è¦–
      ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
      åˆ¶å¾¡æ–‡å­—å¯¾å¿œ
    è¨­å®šç®¡ç†
      server.propertiesç·¨é›†
      ãƒãƒ¼ãƒˆç®¡ç†
      ãƒ¡ãƒ¢ãƒªè¨­å®š
    ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      åå‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
      ãƒãƒ¼ãƒˆç«¶åˆãƒã‚§ãƒƒã‚¯
      JDKå­˜åœ¨ç¢ºèª
```

### **è¨­è¨ˆåŸå‰‡**

- âœ… **è²¬ä»»åˆ†é›¢**: å„ã‚¯ãƒ©ã‚¹ãŒæ˜ç¢ºãªè²¬ä»»ã‚’æŒã¤
- âœ… **ç–çµåˆ**: ã‚¯ãƒ©ã‚¹é–“ã®ä¾å­˜ã‚’æœ€å°é™ã«
- âœ… **æ‹¡å¼µæ€§**: å°†æ¥ã®æ©Ÿèƒ½è¿½åŠ ã‚’è€ƒæ…®
- âœ… **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: å˜ä½“ãƒ†ã‚¹ãƒˆå¯èƒ½ãªè¨­è¨ˆ
- âœ… **å¯èª­æ€§**: åˆå¿ƒè€…ã§ã‚‚ç†è§£ã§ãã‚‹ã‚³ãƒ¼ãƒ‰

---

## 2. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### **2.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ **

```
project-root/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ server-schema.ts           # ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â”‚   â”œâ”€â”€ validation.ts              # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‹
â”‚   â”‚   â””â”€â”€ callbacks.ts               # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹
â”‚   â”œâ”€â”€ classes/
â”‚   â”‚   â”œâ”€â”€ ServerManager.ts           # ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
â”‚   â”‚   â”œâ”€â”€ ServerValidator.ts         # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”œâ”€â”€ ServerPropertiesManager.ts # server.propertiesç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ServerInstanceWrapper.ts   # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
â”‚   â”‚   â””â”€â”€ ProcessExecutor.ts         # ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â””â”€â”€ errors.ts                  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°
â”‚   â””â”€â”€ index.ts                       # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ config/
â”‚   â””â”€â”€ server-manager.json            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”œâ”€â”€ servers/                           # ã‚µãƒ¼ãƒãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ manager.log                    # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ setup/
â”‚   â”‚   â””â”€â”€ test.env.json              # ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒè¨­å®š
â”‚   â”œâ”€â”€ unit/                          # å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ integration/                   # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ e2e/                          # E2Eãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ test-cases.md                  # ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§
â”‚   â”œâ”€â”€ faq.md                        # FAQï¼ˆæ—¢çŸ¥ã®å•é¡Œï¼‰
â”‚   â””â”€â”€ api-usage.md                  # APIä½¿ç”¨ä¾‹
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

### **2.2 ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**

```json
{
  "name": "minecraft-server-manager",
  "version": "1.0.0",
  "dependencies": {
    "pino": "^8.16.0",
    "zod": "^3.22.0"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "typescript": "^5.3.0",
    "jest": "^29.7.0",
    "@types/jest": "^29.5.0",
    "ts-jest": "^29.1.0"
  }
}
```

### **2.3 TypeScriptè¨­å®š**

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### **2.4 ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š**

`tests/setup/test.env.json`:
```json
{
  "jdkManager": {
    "configPath": "/path/to/jdk-registry.json",
    "jdkArchives": {
      "jdk8": "/path/to/jdk8.zip",
      "jdk17": "/path/to/jdk17.zip",
      "jdk21": "/path/to/jdk21.zip"
    }
  },
  "minecraftServer": {
    "vanillaJar": "/path/to/minecraft-server-1.20.1.jar",
    "paperJar": "/path/to/paper-1.20.1.jar"
  },
  "testPaths": {
    "configDir": "./tests/tmp/config",
    "serversDir": "./tests/tmp/servers",
    "logsDir": "./tests/tmp/logs"
  }
}
```

---

## 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ

### **3.1 ã‚¯ãƒ©ã‚¹é–¢ä¿‚å›³**

```mermaid
graph TB
    subgraph "å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ "
        UI[UI/Orchestration Layer]
        JDK[JDKManager<br/>å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª]
    end
    
    subgraph "Server Manager System"
        SM[ServerManager<br/>å…¨ä½“çµ±æ‹¬]
        SV[ServerValidator<br/>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
        SPM[ServerPropertiesManager<br/>server.propertiesç®¡ç†]
        
        subgraph "Instance Layer"
            W1[ServerInstanceWrapper 1]
            W2[ServerInstanceWrapper 2]
            WN[ServerInstanceWrapper N]
        end
        
        subgraph "Process Layer"
            PE1[ProcessExecutor 1]
            PE2[ProcessExecutor 2]
            PEN[ProcessExecutor N]
        end
    end
    
    subgraph "Data Layer"
        Config[(server-manager.json)]
        Props[(server.properties)]
        Logs[(manager.log)]
    end
    
    UI -->|initialize, method calls| SM
    SM -.->|callbacks| UI
    SM --> SV
    SM --> SPM
    SM --> JDK
    
    SM --> W1
    SM --> W2
    SM --> WN
    
    W1 --> PE1
    W2 --> PE2
    WN --> PEN
    
    W1 --> JDK
    W2 --> JDK
    WN --> JDK
    
    SM <-->|read/write| Config
    SPM <-->|read/write| Props
    SM -->|write| Logs
    
    style SM fill:#e1f5ff,stroke:#01579b,stroke-width:3px
    style SV fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style SPM fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style W1 fill:#fff4e1,stroke:#f57c00,stroke-width:2px
    style W2 fill:#fff4e1,stroke:#f57c00,stroke-width:2px
    style WN fill:#fff4e1,stroke:#f57c00,stroke-width:2px
    style PE1 fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style PE2 fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style PEN fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
```

### **3.2 è²¬ä»»åˆ†é›¢ãƒãƒˆãƒªã‚¯ã‚¹**

| ã‚¯ãƒ©ã‚¹ | è²¬ä»» | ä¾å­˜å…ˆ | ä¾å­˜å…ƒ |
|-------|------|--------|--------|
| **ServerManager** | å…¨ä½“çµ±æ‹¬ã€è¨­å®šç®¡ç†ã€å¤–éƒ¨API | Validator, Wrapper, JDKManager | UIå±¤ |
| **ServerValidator** | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ | Managerï¼ˆèª­ã¿å–ã‚Šï¼‰, JDKManager | Manager |
| **ServerPropertiesManager** | server.propertiesç®¡ç† | ãªã—ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰ | Manager, Wrapper |
| **ServerInstanceWrapper** | å€‹åˆ¥ã‚µãƒ¼ãƒãƒ¼åˆ¶å¾¡ | ProcessExecutor, JDKManager | Manager |
| **ProcessExecutor** | ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ | ãªã—ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰ | Wrapper |

### **3.3 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**

```mermaid
sequenceDiagram
    participant UI as UI Layer
    participant SM as ServerManager
    participant SV as ServerValidator
    participant W as ServerInstanceWrapper
    participant PE as ProcessExecutor
    participant MC as Minecraft Server
    
    rect rgb(225, 245, 254)
        Note over UI,SM: åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚º
        UI->>SM: initialize(paths, jdkManager, callbacks)
        SM->>SM: loadConfig()
        SM->>SM: createWrappers()
        SM-->>UI: manager instance
    end
    
    rect rgb(255, 243, 224)
        Note over UI,MC: ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ•ã‚§ãƒ¼ã‚º
        UI->>SM: startServer(uuid)
        SM->>SV: validateServerStart(uuid)
        SV-->>SM: validation result
        SM->>W: start()
        W->>PE: new ProcessExecutor()
        W->>PE: start(javaPath, jarPath, args)
        PE->>MC: spawn process
        MC-->>PE: process started
        PE-->>W: started
        W->>SM: reportEvent('started')
        SM->>UI: callbacks.onServerStarted(uuid)
    end
    
    rect rgb(232, 245, 233)
        Note over UI,MC: å®Ÿè¡Œä¸­ãƒ•ã‚§ãƒ¼ã‚º
        UI->>SM: sendCommand(uuid, 'say Hello')
        SM->>W: sendCommand('say Hello')
        W->>PE: sendCommand('say Hello')
        PE->>MC: stdin: 'say Hello\n'
        MC->>PE: stdout: '[Server] Hello'
        PE->>W: emit('stdout', line)
        W->>SM: (EventEmitterçµŒç”±)
        SM->>UI: callbacks.onStdout(line)
    end
```

---

## 4. å‹å®šç¾©

### **4.1 ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒï¼ˆ`types/server-schema.ts`ï¼‰**

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ:**
- Step1ã§ç¢ºå®šã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’ãã®ã¾ã¾ä½¿ç”¨
- Zodã‚¹ã‚­ãƒ¼ãƒã‚‚ä½µã›ã¦å®šç¾©ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰

```typescript
import { z } from 'zod';

// ========================================
// åŸºæœ¬å‹å®šç¾©
// ========================================

export type ServerStatus = 'stopped' | 'running' | 'crashed';

export interface ServerSoftware {
  name: string;
  version: string;
}

export interface ServerLaunchConfig {
  jarPath: string;
  port: number;
  jdkVersion: number;  // âš ï¸ numberå‹ï¼ˆJDKManagerä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
  maxMemory: number;
  minMemory: number;
  jvmArguments: string[];
  serverArguments: string[];
}

export interface ServerMetadata {
  createdAt: string;
  updatedAt: string;
  lastStartedAt: string | null;
  totalUptime: number;
}

export interface AutoRestartConfig {
  enabled: boolean;
  maxConsecutiveRestarts: number;
  resetThresholdSeconds: number;
}

export interface ServerInstance {
  uuid: string;
  name: string;
  note: string;
  status: ServerStatus;
  software: ServerSoftware;
  launchConfig: ServerLaunchConfig;
  metadata: ServerMetadata;
  autoRestart: AutoRestartConfig;
}

export interface ServerManagerConfig {
  configVersion: string;
  instances: ServerInstance[];
  lastUpdated: string;
}

// ========================================
// å®Ÿè¡Œæ™‚å°‚ç”¨å‹ï¼ˆéæ°¸ç¶šåŒ–ï¼‰
// ========================================

export interface RuntimeState {
  consecutiveRestartCount: number;
  lastRestartTime: number | null;
  resetTimerId: NodeJS.Timeout | null;
  currentSessionStartTime: number | null;
}

// ========================================
// Zodã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
// ========================================

export const ServerManagerConfigSchema = z.object({
  configVersion: z.string(),
  instances: z.array(z.any()), // è©³ç´°ã¯çœç•¥å¯
  lastUpdated: z.string()
});
```

### **4.2 ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‹ï¼ˆ`types/validation.ts`ï¼‰**

```typescript
export interface ValidationResult {
  valid: boolean;
  error?: string;
  warnings?: string[];
}

export class ValidationResultHelper {
  static success(warnings?: string[]): ValidationResult {
    return { valid: true, warnings };
  }
  
  static failure(error: string): ValidationResult {
    return { valid: false, error };
  }
  
  static warning(warnings: string[]): ValidationResult {
    return { valid: true, warnings };
  }
}
```

### **4.3 ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹ï¼ˆ`types/callbacks.ts`ï¼‰**

```typescript
export type InstanceEventType = 
  | 'started'
  | 'stopped'
  | 'crashed'
  | 'autoRestartLimitReached'
  | 'stopTimeout'
  | 'forcedKill';

export interface InstanceEvent {
  type: InstanceEventType;
  uuid: string;
  timestamp: number;
  data?: any;
}

export type NotifyFunction = (event: InstanceEvent) => void;

export interface ServerCallbacks {
  onServerStarted?: (uuid: string) => void;
  onServerStopped?: (uuid: string, exitCode: number) => void;
  onServerCrashed?: (uuid: string, error: Error) => void;
  onAutoRestartLimitReached?: (uuid: string) => void;
  onStopTimeout?: (uuid: string, message: string) => void;
  onForcedKill?: (uuid: string) => void;
}

export interface ProcessStdCallbacks {
  onStdout?: (line: string) => void;
  onStderr?: (line: string) => void;
}
```

### **4.4 ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°ï¼ˆ`constants/errors.ts`ï¼‰**

```typescript
export const ServerManagerErrors = {
  // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
  INSTANCE_NOT_FOUND: 'Server instance not found',
  INSTANCE_NAME_DUPLICATE: 'Server name already exists',
  INSTANCE_RUNNING: 'Server is currently running',
  INSTANCE_NOT_RUNNING: 'Server is not running',
  
  // JDKé–¢é€£
  JDK_NOT_FOUND: 'Required JDK version not found',
  JDK_VERSION_INVALID: 'Invalid JDK version',
  
  // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
  FILE_NOT_FOUND: 'File not found',
  FILE_LOCKED: 'File is locked by another process',
  DIRECTORY_RENAME_FAILED: 'Failed to rename directory',
  DIRECTORY_DELETE_FAILED: 'Failed to delete directory',
  FILE_COPY_FAILED: 'Failed to copy file',
  
  // ãƒãƒ¼ãƒˆ
  PORT_IN_USE: 'Port is already in use by another server',
  PORT_INVALID: 'Invalid port number',
  
  // è¨­å®š
  CONFIG_LOAD_FAILED: 'Failed to load configuration',
  CONFIG_SAVE_FAILED: 'Failed to save configuration',
  CONFIG_INVALID: 'Invalid configuration data',
  
  // ãƒ—ãƒ­ã‚»ã‚¹
  PROCESS_START_FAILED: 'Failed to start server process',
  PROCESS_STOP_TIMEOUT: 'Server did not stop within timeout period',
  
  // ãƒ¬ã‚¸ã‚¹ãƒˆãƒª
  REGISTRY_NOT_LOADED: 'Registry not loaded',
} as const;
```

---

## 5. ã‚¯ãƒ©ã‚¹å®Ÿè£…ä»•æ§˜

### **5.1 ServerManager**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    SM[ServerManager]
    
    R1[å…¨ä½“çµ±æ‹¬]
    R2[è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†]
    R3[ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸€è¦§ç®¡ç†]
    R4[ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å§”è­²]
    R5[ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡]
    R6[ç¨¼åƒæ™‚é–“è¿½è·¡]
    
    SM --> R1
    SM --> R2
    SM --> R3
    SM --> R4
    SM --> R5
    SM --> R6
```

#### **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã¨ãƒ•ãƒ­ãƒ¼**

**åˆæœŸåŒ–:**
```mermaid
flowchart TD
    Start([static initialize]) --> Constructor[private constructor]
    Constructor --> Logger[PinoåˆæœŸåŒ–]
    Logger --> Validator[ServerValidatorç”Ÿæˆ]
    Validator --> CheckConfig{configå­˜åœ¨?}
    CheckConfig -->|No| CreateDefault[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½œæˆ]
    CheckConfig -->|Yes| LoadConfig[èª­ã¿è¾¼ã¿ & Zodæ¤œè¨¼]
    CreateDefault --> CreateWrappers[Wrapperç”Ÿæˆ]
    LoadConfig --> CreateWrappers
    CreateWrappers --> Return[ServerManagerè¿”å´]
```

**addInstance:**
```mermaid
flowchart TD
    Start([addInstance]) --> Validate[Validator.validateAddInstance]
    Validate --> CreateDir[mkdir servers/name]
    CreateDir --> CopyJar[jarç§»å‹•]
    CopyJar --> CreateEula[eula.txtä½œæˆ]
    CreateEula --> CreateProps[server.propertiesä½œæˆ]
    CreateProps --> CreateData[ServerInstanceä½œæˆ]
    CreateData --> SaveConfig[saveConfig]
    SaveConfig --> CreateWrapper[Wrapperç”Ÿæˆ]
    CreateWrapper --> Return[uuidè¿”å´]
```

**startServer:**
```mermaid
flowchart TD
    Start([startServer]) --> GetInstance[getInstance uuid]
    GetInstance --> ValidateStart[Validator.validateServerStart]
    ValidateStart --> WrapperStart[wrapper.start]
    WrapperStart --> StartTracking[ç¨¼åƒæ™‚é–“è¿½è·¡é–‹å§‹]
    StartTracking --> Return[å®Œäº†]
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **åˆæœŸåŒ–ã¯å¿…ãš`static initialize()`çµŒç”±**
   - ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯private
   - éåŒæœŸå‡¦ç†ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç­‰ï¼‰ã‚’å«ã‚€ãŸã‚

2. **ã™ã¹ã¦ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯Validatorã«å§”è­²**
   - Managerå†…ã«ç›´æ¥ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã‹ãªã„

3. **ç¨¼åƒæ™‚é–“è¿½è·¡ã¯5åˆ†ã”ã¨**
   - `setInterval`ã§ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
   - `uptimeIntervals: Map<string, NodeJS.Timeout>`ã«ä¿å­˜

4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã¯try-catchã§å›²ã‚€
   - ã‚¨ãƒ©ãƒ¼æ™‚ã¯è©³ç´°ãªãƒ­ã‚°ã‚’è¨˜éŒ²
   - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”å´

---

### **5.2 ServerValidator**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    SV[ServerValidator]
    
    R1[åå‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    R2[ãƒãƒ¼ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    R3[JDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª]
    R4[ãƒ¡ãƒ¢ãƒªè¨­å®šç¢ºèª]
    R5[è¤‡åˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    
    SV --> R1
    SV --> R2
    SV --> R3
    SV --> R4
    SV --> R5
```

#### **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼**

```mermaid
flowchart TD
    Start([validateAddInstance]) --> Name[validateName]
    Name --> NameOK{OK?}
    NameOK -->|No| ErrorReturn[Errorè¿”å´]
    NameOK -->|Yes| JDK[validateJdkVersion]
    JDK --> JDKOK{OK?}
    JDKOK -->|No| ErrorReturn
    JDKOK -->|Yes| Port[validatePort]
    Port --> PortOK{OK?}
    PortOK -->|No| ErrorReturn
    PortOK -->|Yes| Memory[validateMemorySettings]
    Memory --> MemoryOK{OK?}
    MemoryOK -->|No| ErrorReturn
    MemoryOK -->|Yes| CollectWarnings[è­¦å‘Šã‚’é›†ç´„]
    CollectWarnings --> SuccessReturn[Successè¿”å´]
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **ä¾å­˜ã¯èª­ã¿å–ã‚Šå°‚ç”¨**
   - ServerManagerã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ãªã„
   - `getInstanceByName()`, `getAllInstances()`ã®ã¿ä½¿ç”¨

2. **è­¦å‘Šã¨ã‚¨ãƒ©ãƒ¼ã®åŒºåˆ¥**
   - ã‚¨ãƒ©ãƒ¼: å‡¦ç†ã‚’ç¶šè¡Œã§ããªã„ï¼ˆ`valid: false`ï¼‰
   - è­¦å‘Š: æ³¨æ„ãŒå¿…è¦ã ãŒç¶šè¡Œå¯èƒ½ï¼ˆ`valid: true, warnings: [...]`ï¼‰

3. **JDKå­˜åœ¨ç¢ºèª**
   - `jdkManager.Entrys.getByVersion()`ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
   - æ•´åˆæ€§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚ç¢ºèªï¼ˆmissing/corruptedï¼‰

---

### **5.3 ServerPropertiesManager**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    SPM[ServerPropertiesManager]
    
    R1[ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿æ›¸ã]
    R2[ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è§£æ]
    R3[ãƒãƒ¼ãƒˆç®¡ç†]
    R4[æ‹¡å¼µå¯èƒ½ãªAPI]
    
    SPM --> R1
    SPM --> R2
    SPM --> R3
    SPM --> R4
```

#### **ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ›´æ–°ãƒ•ãƒ­ãƒ¼**

```mermaid
flowchart TD
    Start([updatePort]) --> Exists{ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨?}
    Exists -->|No| Create[æ–°è¦ä½œæˆ]
    Exists -->|Yes| Read[æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿]
    Read --> Parse[ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è§£æ]
    Parse --> Update[server-portæ›´æ–°]
    Update --> Serialize[æ–‡å­—åˆ—åŒ–]
    Create --> Serialize
    Serialize --> Write[ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿]
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ = 1ãƒ•ã‚¡ã‚¤ãƒ«**
   - ä½¿ã„æ¨ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå‘¼ã³å‡ºã—ã®ãŸã³ã«ç”Ÿæˆï¼‰
   - å†…éƒ¨ã®Mapã¯1ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¾

2. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒ**
   - `update()`æ™‚ã¯ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¿æŒ
   - æ­£è¦è¡¨ç¾ã§è©²å½“è¡Œã®ã¿ç½®ãæ›ãˆ

3. **æ‹¡å¼µæ€§**
   - `updatePort()`ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ å¯èƒ½
   - ã‚³ãƒ”ãƒš+ç·¨é›†ã§ç°¡å˜ã«æ‹¡å¼µ

---

### **5.4 ServerInstanceWrapper**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    W[ServerInstanceWrapper]
    
    R1[å€‹åˆ¥ã‚µãƒ¼ãƒãƒ¼åˆ¶å¾¡]
    R2[ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†]
    R3[JDKãƒ­ãƒƒã‚¯ç®¡ç†]
    R4[è‡ªå‹•å†èµ·å‹•åˆ¤å®š]
    R5[æ¨™æº–å…¥å‡ºåŠ›ã‚¤ãƒ™ãƒ³ãƒˆ]
    
    W --> R1
    W --> R2
    W --> R3
    W --> R4
    W --> R5
```

#### **èµ·å‹•ãƒ•ãƒ­ãƒ¼**

```mermaid
sequenceDiagram
    participant W as Wrapper
    participant JDK as JDKManager
    participant PE as ProcessExecutor
    
    W->>JDK: Entrys.getByVersion(jdkVersion)
    JDK-->>W: JDKEntry
    W->>JDK: useRuntime(purpose)
    JDK-->>W: lockId
    W->>PE: new ProcessExecutor(logger, workingDir)
    W->>PE: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
    W->>PE: start(javaPath, jarPath, args)
    PE-->>W: èµ·å‹•å®Œäº†
    W->>W: status = 'running'
    W->>W: startResetTimer()
    W->>W: reportEvent('started')
```

#### **è‡ªå‹•å†èµ·å‹•ãƒ•ãƒ­ãƒ¼**

```mermaid
flowchart TD
    Exit([ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†]) --> CheckCode{exitCode?}
    CheckCode -->|0| Normal[æ­£å¸¸çµ‚äº†]
    CheckCode -->|!= 0| Crash[ã‚¯ãƒ©ãƒƒã‚·ãƒ¥]
    
    Normal --> Cleanup[cleanup]
    Normal --> ReportStopped[reportEvent stopped]
    
    Crash --> CheckAuto{autoRestart<br/>enabled?}
    CheckAuto -->|No| Cleanup
    CheckAuto -->|Yes| CheckLimit{ä¸Šé™ãƒã‚§ãƒƒã‚¯}
    
    CheckLimit -->|è¶…é| ReportLimit[reportEvent<br/>autoRestartLimitReached]
    CheckLimit -->|OK| Increment[count++]
    
    ReportLimit --> Cleanup
    Increment --> Restart[attemptAutoRestart]
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **EventEmitterã®ç¶™æ‰¿**
   - `extends EventEmitter`
   - æ¨™æº–å…¥å‡ºåŠ›ç”¨ã«`emit('stdout', line)`ç­‰ã‚’ä½¿ç”¨

2. **JDKãƒ­ãƒƒã‚¯ã®ç¢ºå®Ÿãªè§£æ”¾**
   - èµ·å‹•æˆåŠŸæ™‚ã€å¤±æ•—æ™‚ã€åœæ­¢æ™‚ã™ã¹ã¦ã§è§£æ”¾
   - `finally`ãƒ–ãƒ­ãƒƒã‚¯ã®æ´»ç”¨

3. **ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ã®ç®¡ç†**
   - èµ·å‹•æ™‚ã«é–‹å§‹ï¼ˆ10åˆ†å¾Œã«ãƒªã‚»ãƒƒãƒˆï¼‰
   - åœæ­¢æ™‚ã«ã‚¯ãƒªã‚¢
   - `clearTimeout()`ã‚’å¿˜ã‚Œãšã«

4. **è‡ªå·±å®Œçµçš„ãªãƒ‘ã‚¹ç®¡ç†**
   - `serversBasePath`ã‚’ä¿æŒ
   - `getWorkingDirectory()`ã§è‡ªåˆ†ã§ãƒ‘ã‚¹æ§‹ç¯‰

---

### **5.5 ProcessExecutor**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    PE[ProcessExecutor]
    
    R1[ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ãƒ»åœæ­¢]
    R2[æ¨™æº–å…¥å‡ºåŠ›ç®¡ç†]
    R3[åˆ¶å¾¡æ–‡å­—å¯¾å¿œ]
    R4[ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†]
    
    PE --> R1
    PE --> R2
    PE --> R3
    PE --> R4
```

#### **èµ·å‹•ãƒ»åœæ­¢ãƒ•ãƒ­ãƒ¼**

```mermaid
sequenceDiagram
    participant W as Wrapper
    participant PE as ProcessExecutor
    participant CP as child_process
    
    rect rgb(225, 245, 254)
        Note over W,CP: èµ·å‹•
        W->>PE: start(javaPath, jarPath, args)
        PE->>CP: spawn(javaPath, args, options)
        CP-->>PE: ChildProcess
        PE->>PE: setupOutputHandlers()
        PE->>PE: ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–é–‹å§‹
        PE-->>W: å®Œäº†
    end
    
    rect rgb(255, 243, 224)
        Note over W,CP: åœæ­¢
        W->>PE: stop(timeout)
        PE->>CP: stdin.write('stop\n')
        PE->>PE: waitForExit(timeout)
        alt ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå†…ã«çµ‚äº†
            CP->>PE: exit event
            PE->>W: onExit(exitCode)
        else ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            PE->>W: onStopTimeout()
        end
    end
```

#### **åˆ¶å¾¡æ–‡å­—å¯¾å¿œ**

```typescript
enum ControlCharacter {
  ENTER = '\n',
  CTRL_C = '\x03',
  TAB = '\t'
}
```

```mermaid
graph LR
    Input[å…¥åŠ›] --> Type{ç¨®åˆ¥}
    Type -->|sendCommand| AddEnter[æ–‡å­—åˆ— + Enter]
    Type -->|sendInput| Direct[ãã®ã¾ã¾]
    Type -->|sendControlCharacter| Convert[åˆ¶å¾¡æ–‡å­—å¤‰æ›]
    
    AddEnter --> Write[stdin.write]
    Direct --> Write
    Convert --> Write
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **å®Œå…¨ç‹¬ç«‹ã‚¯ãƒ©ã‚¹**
   - ServerManager/Wrapperã®æ¦‚å¿µã«ä¾å­˜ã—ãªã„
   - æ±ç”¨çš„ãªãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œã‚¯ãƒ©ã‚¹

2. **readline interfaceã®ä½¿ç”¨**
   - æ¨™æº–å‡ºåŠ›ã‚’è¡Œå˜ä½ã§å‡¦ç†
   - `createInterface({ input: process.stdout })`

3. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯é€šçŸ¥ã®ã¿**
   - `stop()`ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚å¼·åˆ¶çµ‚äº†ã—ãªã„
   - `onStopTimeout`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§é€šçŸ¥
   - `kill()`ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«å‘¼ã³å‡ºã™

4. **åˆ¶å¾¡æ–‡å­—ã®å®Ÿè£…**
   - `sendCommand()`: æ—¢å­˜äº’æ›ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ + Enterï¼‰
   - `sendInput()`: Enterãªã—
   - `sendControlCharacter()`: åˆ¶å¾¡æ–‡å­—é€ä¿¡

---

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æŒ‡é‡

### **6.1 åŸºæœ¬æ–¹é‡**

```mermaid
graph TB
    Error[ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ] --> Catch[try-catchã§ã‚­ãƒ£ãƒƒãƒ]
    Catch --> Log[è©³ç´°ãƒ­ã‚°è¨˜éŒ²]
    Log --> Return[é©åˆ‡ãªã‚¨ãƒ©ãƒ¼è¿”å´]
    Return --> NoThrow[ä¸Šä½ã«æŠ•ã’ãªã„]
    
    style Error fill:#ffcdd2
    style Catch fill:#fff9c4
    style Log fill:#e1f5ff
    style Return fill:#c8e6c9
```

**åŸå‰‡:**
- âœ… ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã¯try-catchã§å›²ã‚€
- âœ… ã‚¨ãƒ©ãƒ¼ã¯è©³ç´°ã«ãƒ­ã‚°è¨˜éŒ²
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- âœ… ä¾‹å¤–ã‚’ä¸Šä½ã«æŠ•ã’ãšã€Resultå‹ã§è¿”ã™
- âœ… ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªã‚¨ãƒ©ãƒ¼ã®ã¿throw

### **6.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³**

#### **ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ**

```typescript
async removeInstance(uuid: string): Promise<VoidResult> {
  const instance = this.instances.get(uuid);
  if (!instance) {
    return { success: false, error: ServerManagerErrors.INSTANCE_NOT_FOUND };
  }
  
  const serverDir = path.join(this.serversBasePath, instance.getData().name);
  
  try {
    await fs.promises.rm(serverDir, { recursive: true, force: true });
    this.logger.info(`Deleted directory: ${serverDir}`);
  } catch (error) {
    this.logger.error(`Failed to delete directory: ${serverDir}`, error);
    // âŒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•— â†’ å…¨å‡¦ç†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    return { 
      success: false, 
      error: `${ServerManagerErrors.DIRECTORY_DELETE_FAILED}: ${error.message}` 
    };
  }
  
  // âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤æˆåŠŸ â†’ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªæ›´æ–°
  this.instances.delete(uuid);
  await this.saveConfig();
  
  return { success: true };
}
```

#### **ãƒ‘ã‚¿ãƒ¼ãƒ³2: éã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªã‚¨ãƒ©ãƒ¼**

```typescript
async updateInstance(params: UpdateInstanceParams): Promise<VoidResult> {
  // ... å‰å‡¦ç†
  
  // ãƒãƒ¼ãƒˆå¤‰æ›´ï¼ˆå¤±æ•—ã—ã¦ã‚‚å‡¦ç†ç¶™ç¶šï¼‰
  if (params.updates.port !== undefined) {
    try {
      const propManager = this.getServerPropertiesManager(params.uuid);
      await propManager.updatePort(params.updates.port);
      this.logger.info(`Updated port to ${params.updates.port}`);
    } catch (error) {
      // âš ï¸ server.propertiesæ›´æ–°å¤±æ•— â†’ è­¦å‘Šã®ã¿
      this.logger.warn('Failed to update server.properties', error);
      this.logger.warn('Port updated in registry, but server.properties update failed');
      // å‡¦ç†ã¯ç¶™ç¶š
    }
  }
  
  // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆå¿…ãšå®Ÿè¡Œï¼‰
  instance.updateData(params.updates);
  await this.saveConfig();
  
  return { success: true };
}
```

#### **ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼**

```typescript
async addInstance(params: AddInstanceParams): Promise<AddInstanceResult> {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const validation = await this.validator.validateAddInstance(params);
  if (!validation.valid) {
    // âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— â†’ å³åº§ã«è¿”å´
    return { success: false, error: validation.error };
  }
  
  // âš ï¸ è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯ãƒ­ã‚°è¨˜éŒ²
  if (validation.warnings && validation.warnings.length > 0) {
    validation.warnings.forEach(warning => {
      this.logger.warn(warning);
    });
  }
  
  // å‡¦ç†ç¶™ç¶š...
}
```

### **6.3 ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®ä½¿ã„åˆ†ã‘**

| ãƒ¬ãƒ™ãƒ« | ç”¨é€” | ä¾‹ |
|--------|------|-----|
| `debug` | è©³ç´°ãªå‡¦ç†å†…å®¹ | ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã€å¤‰æ•°ã®å€¤ |
| `info` | æ­£å¸¸ãªå‡¦ç† | ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æˆåŠŸã€è¨­å®šä¿å­˜ |
| `warn` | è­¦å‘Šï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰ | server.propertiesæ›´æ–°å¤±æ•—ã€ãƒ¡ãƒ¢ãƒªè­¦å‘Š |
| `error` | ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†ä¸­æ–­ï¼‰ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•—ã€JDKæœªç™ºè¦‹ |

---

## 7. ãƒ†ã‚¹ãƒˆä»•æ§˜

### **7.1 ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**

#### **test.env.json ã®ä½¿ç”¨**

```typescript
// tests/setup/loadTestEnv.ts
import * as fs from 'fs';
import * as path from 'path';

export interface TestEnv {
  jdkManager: {
    configPath: string;
    jdkArchives: {
      jdk8: string;
      jdk17: string;
      jdk21: string;
    };
  };
  minecraftServer: {
    vanillaJar: string;
    paperJar: string;
  };
  testPaths: {
    configDir: string;
    serversDir: string;
    logsDir: string;
  };
}

export function loadTestEnv(): TestEnv {
  const envPath = path.join(__dirname, 'test.env.json');
  const content = fs.readFileSync(envPath, 'utf-8');
  return JSON.parse(content);
}
```

### **7.2 ãƒ†ã‚¹ãƒˆã®æ§‹æˆ**

```mermaid
graph TB
    subgraph "ãƒ†ã‚¹ãƒˆéšå±¤"
        Unit[å˜ä½“ãƒ†ã‚¹ãƒˆ<br/>å„ã‚¯ãƒ©ã‚¹å€‹åˆ¥]
        Integration[çµ±åˆãƒ†ã‚¹ãƒˆ<br/>ã‚¯ãƒ©ã‚¹é–“é€£æº]
        E2E[E2Eãƒ†ã‚¹ãƒˆ<br/>å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼èµ·å‹•]
    end
    
    subgraph "ãƒ†ã‚¹ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"
        Cases[test-cases.md<br/>æ‰‹å‹•ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§]
    end
    
    Unit --> Integration
    Integration --> E2E
    E2E --> Cases
    
    style Unit fill:#e8f5e9
    style Integration fill:#fff9c4
    style E2E fill:#ffcdd2
    style Cases fill:#e1f5ff
```

### **7.3 çµ±åˆãƒ†ã‚¹ãƒˆã®ä¾‹**

```typescript
// tests/integration/server-lifecycle.test.ts
import { ServerManager } from '../../src/classes/ServerManager';
import { JdkManager } from 'jdk-manager';
import { loadTestEnv } from '../setup/loadTestEnv';

describe('Server Lifecycle Integration Test', () => {
  let manager: ServerManager;
  let jdkManager: JdkManager;
  const testEnv = loadTestEnv();
  
  beforeAll(async () => {
    // JDKManageråˆæœŸåŒ–
    jdkManager = new JdkManager(testEnv.jdkManager.configPath);
    await jdkManager.Data.load();
    
    // ServerManageråˆæœŸåŒ–
    manager = await ServerManager.initialize(
      testEnv.testPaths.configDir + '/server-manager.json',
      testEnv.testPaths.serversDir,
      testEnv.testPaths.logsDir + '/manager.log',
      jdkManager
    );
  });
  
  test('ã‚µãƒ¼ãƒãƒ¼ã®è¿½åŠ ãƒ»èµ·å‹•ãƒ»åœæ­¢ãƒ»å‰Šé™¤', async () => {
    // 1. ã‚µãƒ¼ãƒãƒ¼è¿½åŠ 
    const addResult = await manager.addInstance({
      name: 'test-server',
      note: 'ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ¼ãƒãƒ¼',
      software: { name: 'Vanilla', version: '1.20.1' },
      jdkVersion: 17,
      serverBinaryFilePath: testEnv.minecraftServer.vanillaJar
    });
    
    expect(addResult.success).toBe(true);
    const uuid = addResult.uuid!;
    
    // 2. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
    const startResult = await manager.startServer(uuid);
    expect(startResult.success).toBe(true);
    
    // 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
    const data = manager.getInstanceData(uuid);
    expect(data?.status).toBe('running');
    
    // 4. ã‚µãƒ¼ãƒãƒ¼åœæ­¢
    const stopResult = await manager.stopServer(uuid);
    expect(stopResult.success).toBe(true);
    
    // 5. ã‚µãƒ¼ãƒãƒ¼å‰Šé™¤
    const removeResult = await manager.removeInstance(uuid);
    expect(removeResult.success).toBe(true);
  });
});
```

### **7.4 E2Eãƒ†ã‚¹ãƒˆã®ä¾‹**

```typescript
// tests/e2e/minecraft-server.test.ts
describe('Minecraft Server E2E Test', () => {
  test('å®Ÿéš›ã«Minecraftã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã€ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã‚‹', async () => {
    // ... åˆæœŸåŒ–
    
    const addResult = await manager.addInstance({
      name: 'e2e-server',
      note: 'E2Eãƒ†ã‚¹ãƒˆ',
      software: { name: 'Vanilla', version: '1.20.1' },
      jdkVersion: 17,
      serverBinaryFilePath: testEnv.minecraftServer.vanillaJar
    });
    
    const uuid = addResult.uuid!;
    
    // æ¨™æº–å‡ºåŠ›ç›£è¦–
    const outputs: string[] = [];
    manager.openProcessStd(uuid, {
      onStdout: (line) => outputs.push(line)
    });
    
    // èµ·å‹•
    await manager.startServer(uuid);
    
    // ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº†ã‚’å¾…æ©Ÿï¼ˆ"Done"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
    await waitForServerReady(outputs, 60000);
    
    // ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
    manager.sendCommand(uuid, 'list');
    
    // å¿œç­”å¾…æ©Ÿ
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // å‡ºåŠ›ç¢ºèª
    const hasListOutput = outputs.some(line => 
      line.includes('There are') && line.includes('players online')
    );
    expect(hasListOutput).toBe(true);
    
    // åœæ­¢
    await manager.stopServer(uuid, 30000);
    await manager.removeInstance(uuid);
  });
});
```

---

## 8. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæŒ‡ç¤º

### **8.1 ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§ï¼ˆ`docs/test-cases.md`ï¼‰**

ä»¥ä¸‹ã®å½¢å¼ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ï¼š

```markdown
# ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§

## 1. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†

### 1.1 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¿½åŠ 

| ID | ãƒ†ã‚¹ãƒˆé …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|----|----------|------|---------|
| TC-001 | æ­£å¸¸ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¿½åŠ  | 1. æœ‰åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§addInstanceå‘¼ã³å‡ºã—<br/>2. çµæœç¢ºèª | success: true, uuidãŒè¿”å´ã•ã‚Œã‚‹ |
| TC-002 | åå‰é‡è¤‡ã‚¨ãƒ©ãƒ¼ | 1. åŒã˜åå‰ã§2å›addInstance<br/>2. 2å›ç›®ã®çµæœç¢ºèª | success: false, error: "Name already exists" |
| TC-003 | ç„¡åŠ¹ãªJDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1. å­˜åœ¨ã—ãªã„JDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š<br/>2. çµæœç¢ºèª | success: false, error: "JDK not found" |

## 2. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ»åœæ­¢

### 2.1 èµ·å‹•

| ID | ãƒ†ã‚¹ãƒˆé …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|----|----------|------|---------|
| TC-101 | æ­£å¸¸èµ·å‹• | 1. stopServerå‘¼ã³å‡ºã—<br/>2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª | status: 'running' |
| TC-102 | æ—¢ã«èµ·å‹•ä¸­ã®ã‚µãƒ¼ãƒãƒ¼èµ·å‹• | 1. èµ·å‹•ä¸­ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦startServer<br/>2. çµæœç¢ºèª | success: false, error: "Already running" |

...
```

### **8.2 FAQï¼ˆ`docs/faq.md`ï¼‰**

```markdown
# FAQ - æ—¢çŸ¥ã®å•é¡Œã¨å¯¾å‡¦æ³•

## ãƒãƒ¼ãƒˆé–¢é€£

### Q1: ãƒãƒ¼ãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ãŸã®ã«èµ·å‹•ã«å¤±æ•—ã™ã‚‹

**åŸå› :**
- å¤–éƒ¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ä¸­
- OSå´ã§ãƒãƒ¼ãƒˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹
- ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®š

**å¯¾å‡¦æ³•:**
1. `netstat -ano | findstr :{PORT}` (Windows) ã§ãƒãƒ¼ãƒˆä½¿ç”¨çŠ¶æ³ç¢ºèª
2. ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
3. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šã‚’ç¢ºèª

## ã‚¯ãƒ©ãƒƒã‚·ãƒ¥åˆ¤å®š

### Q2: æ­£å¸¸çµ‚äº†ãªã®ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ‰±ã„ã«ãªã‚‹

**åŸå› :**
- ä¸€éƒ¨ã®ã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯æ­£å¸¸çµ‚äº†ã§ã‚‚exitCode != 0ã‚’è¿”ã™å ´åˆãŒã‚ã‚‹

**å¯¾å‡¦æ³•:**
- ç¾åœ¨ã®å®Ÿè£…ã§ã¯exitCode == 0ã®ã¿ã‚’æ­£å¸¸çµ‚äº†ã¨åˆ¤å®š
- å°†æ¥çš„ã«ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã”ã¨ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ã‚’æ¤œè¨

...
```

### **8.3 APIä½¿ç”¨ä¾‹ï¼ˆ`docs/api-usage.md`ï¼‰**

```markdown
# APIä½¿ç”¨ä¾‹

## åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•

### åˆæœŸåŒ–

\`\`\`typescript
import { ServerManager } from './classes/ServerManager';
import { JdkManager } from 'jdk-manager';

// JDKManageråˆæœŸåŒ–
const jdkManager = new JdkManager('./jdk-registry.json');
await jdkManager.Data.load();

// ServerManageråˆæœŸåŒ–
const manager = await ServerManager.initialize(
  './config/server-manager.json',
  './servers',
  './logs/manager.log',
  jdkManager,
  {
    onServerStarted: (uuid) => console.log(`Started: ${uuid}`),
    onServerCrashed: (uuid, error) => console.error(`Crashed: ${uuid}`, error)
  }
);
\`\`\`

...
```

---

## 9. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### **9.1 ã‚¯ãƒ©ã‚¹å®Ÿè£…**

#### **ServerManager**
- [ ] `static initialize()`ã®å®Ÿè£…
- [ ] `addInstance()`ã®å®Ÿè£…
- [ ] `removeInstance()`ã®å®Ÿè£…ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•—æ™‚ã¯å…¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
- [ ] `updateInstance()`ã®å®Ÿè£…ï¼ˆnoteã®ã¿èµ·å‹•ä¸­æ›´æ–°å¯ï¼‰
- [ ] `startServer()`ã®å®Ÿè£…
- [ ] `stopServer()`ã®å®Ÿè£…
- [ ] `restartServer()`ã®å®Ÿè£…
- [ ] `forceKillServer()`ã®å®Ÿè£…
- [ ] `getInstance()`ã®å®Ÿè£…
- [ ] `getInstanceData()`ã®å®Ÿè£…
- [ ] `getAllInstances()`ã®å®Ÿè£…
- [ ] `getRunningInstances()`ã®å®Ÿè£…
- [ ] `getValidator()`ã®å®Ÿè£…
- [ ] `getServerPropertiesManager()`ã®å®Ÿè£…
- [ ] `openProcessStd()`ã®å®Ÿè£…
- [ ] `closeProcessStd()`ã®å®Ÿè£…
- [ ] `sendCommand()`ã®å®Ÿè£…
- [ ] ç¨¼åƒæ™‚é–“è¿½è·¡ï¼ˆ5åˆ†ã”ã¨ï¼‰ã®å®Ÿè£…
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…

#### **ServerValidator**
- [ ] `validateName()`ã®å®Ÿè£…
- [ ] `validatePort()`ã®å®Ÿè£…ï¼ˆè­¦å‘Šæ©Ÿèƒ½å«ã‚€ï¼‰
- [ ] `validateJdkVersion()`ã®å®Ÿè£…
- [ ] `validateMemorySettings()`ã®å®Ÿè£…
- [ ] `validateJvmArguments()`ã®å®Ÿè£…
- [ ] `validateAddInstance()`ã®å®Ÿè£…
- [ ] `validateUpdateInstance()`ã®å®Ÿè£…
- [ ] `validateServerStart()`ã®å®Ÿè£…

#### **ServerPropertiesManager**
- [ ] `create()`ã®å®Ÿè£…
- [ ] `read()`ã®å®Ÿè£…
- [ ] `write()`ã®å®Ÿè£…
- [ ] `update()`ã®å®Ÿè£…
- [ ] `updateMultiple()`ã®å®Ÿè£…
- [ ] `get()`ã®å®Ÿè£…
- [ ] `exists()`ã®å®Ÿè£…
- [ ] `updatePort()`ã®å®Ÿè£…
- [ ] `getPort()`ã®å®Ÿè£…
- [ ] ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è§£æãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

#### **ServerInstanceWrapper**
- [ ] ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å®Ÿè£…
- [ ] `start()`ã®å®Ÿè£…
- [ ] `stop()`ã®å®Ÿè£…
- [ ] `restart()`ã®å®Ÿè£…
- [ ] `forceKill()`ã®å®Ÿè£…
- [ ] `sendCommand()`ã®å®Ÿè£…
- [ ] `getData()`ã®å®Ÿè£…ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ï¼‰
- [ ] `updateData()`ã®å®Ÿè£…
- [ ] `getStatus()`ã®å®Ÿè£…
- [ ] `isRunning()`ã®å®Ÿè£…
- [ ] EventEmitteræ©Ÿèƒ½ã®å®Ÿè£…
- [ ] JDKãƒ­ãƒƒã‚¯ç®¡ç†ã®å®Ÿè£…
- [ ] è‡ªå‹•å†èµ·å‹•ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- [ ] ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ã®å®Ÿè£…
- [ ] ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…

#### **ProcessExecutor**
- [ ] ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å®Ÿè£…
- [ ] `start()`ã®å®Ÿè£…
- [ ] `stop()`ã®å®Ÿè£…ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼‰
- [ ] `kill()`ã®å®Ÿè£…
- [ ] `sendCommand()`ã®å®Ÿè£…
- [ ] `sendInput()`ã®å®Ÿè£…
- [ ] `sendControlCharacter()`ã®å®Ÿè£…
- [ ] `isRunning()`ã®å®Ÿè£…
- [ ] `getPid()`ã®å®Ÿè£…
- [ ] æ¨™æº–å‡ºåŠ›ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®Ÿè£…
- [ ] æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®Ÿè£…
- [ ] `waitForExit()`ã®å®Ÿè£…
- [ ] `cleanup()`ã®å®Ÿè£…

### **9.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
- [ ] ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã«try-catchã‚’å®Ÿè£…
- [ ] é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¿”å´
- [ ] ãƒ­ã‚°è¨˜éŒ²ã®å®Ÿè£…
- [ ] ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ãã†ã§ãªã„ã‚¨ãƒ©ãƒ¼ã®åŒºåˆ¥

### **9.3 ãƒ†ã‚¹ãƒˆ**
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè£…
- [ ] E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
- [ ] test.env.jsonã®è¨­å®š

### **9.4 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
- [ ] test-cases.mdã®ä½œæˆ
- [ ] faq.mdã®ä½œæˆ
- [ ] api-usage.mdã®ä½œæˆ
- [ ] README.mdã®ä½œæˆ

---

## ğŸ‰ å®Œäº†

ã“ã®å®Ÿè£…ä¾é ¼æ›¸ã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚

**ä¸æ˜ç‚¹ãŒã‚ã‚‹å ´åˆ:**
1. è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆStep1, Step2ï¼‰ã‚’å‚ç…§
2. JDKManagerã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§
3. è³ªå•ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ç¢ºèª

**å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:**
- âœ… è²¬ä»»åˆ†é›¢ã‚’æ„è­˜
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¾¹åº•
- âœ… ãƒ­ã‚°ã‚’è©³ç´°ã«è¨˜éŒ²
- âœ… ãƒ†ã‚¹ãƒˆã‚’æ›¸ããªãŒã‚‰å®Ÿè£…
- âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°

**é ‘å¼µã£ã¦ãã ã•ã„ï¼ğŸš€**

# è£œè¶³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - å®Ÿè£…ä¾é ¼æ›¸ã¸ã®è¿½è¨˜ï¼ˆæœ€çµ‚ç‰ˆï¼‰

ä»¥ä¸‹ã®å†…å®¹ã‚’å®Ÿè£…ä¾é ¼æ›¸ã®æœ«å°¾ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

---

## 10. è£œè¶³äº‹é …ã¨é‡è¦ãªä»•æ§˜

### **10.1 è¿½åŠ ã®å‹å®šç¾©**

å®Ÿè£…ä¾é ¼æ›¸ã®ã€Œ4. å‹å®šç¾©ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ä»¥ä¸‹ã®å‹ãŒä¸è¶³ã—ã¦ã„ã¾ã—ãŸã€‚

#### **Resultå‹ï¼ˆ`types/result.ts`ï¼‰**

ServerManagerå°‚ç”¨ã®Resultå‹ã‚’å®šç¾©ã—ã¾ã™ã€‚JDKManagerã®Resultå‹ã¨ã¯åˆ¥ç‰©ã§ã™ã€‚

```typescript
export type ServerManagerResult<T = void> = 
  | { success: true; data: T }
  | { success: false; error: string };

export type VoidResult = ServerManagerResult<void>;

export interface AddInstanceResult {
  success: boolean;
  uuid?: string;
  error?: string;
}
```

#### **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‹ï¼ˆ`types/params.ts`ï¼‰**

```typescript
export interface AddInstanceParams {
  name: string;
  note: string;
  software: ServerSoftware;
  jdkVersion: number;
  serverBinaryFilePath: string;
  port?: number;
  maxMemory?: number;
  minMemory?: number;
}

export interface UpdateInstanceParams {
  uuid: string;
  updates: {
    name?: string;
    note?: string;
    maxMemory?: number;
    minMemory?: number;
    jvmArguments?: string[];
    serverArguments?: string[];
    autoRestart?: AutoRestartConfig;
    port?: number;
  };
}
```

#### **åˆ¶å¾¡æ–‡å­—åˆ—æŒ™å‹ï¼ˆ`types/control-character.ts`ï¼‰**

```typescript
export enum ControlCharacter {
  ENTER = '\n',      // å¿…é ˆæ©Ÿèƒ½
  CTRL_C = '\x03',   // æ¨å¥¨æ©Ÿèƒ½ï¼ˆãƒ—ãƒ­ã‚»ã‚¹å‰²ã‚Šè¾¼ã¿ï¼‰
  TAB = '\t'         // æ¨å¥¨æ©Ÿèƒ½ï¼ˆã‚¿ãƒ–è£œå®Œï¼‰
}
```

---

### **10.2 Zodã‚¹ã‚­ãƒ¼ãƒã®è©³ç´°ç‰ˆ**

å®Ÿè£…ä¾é ¼æ›¸ã®ã€Œ4.1 ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒã€ã§çœç•¥ã•ã‚Œã¦ã„ãŸZodã‚¹ã‚­ãƒ¼ãƒã®è©³ç´°ç‰ˆã§ã™ã€‚

```typescript
import { z } from 'zod';

const ServerSoftwareSchema = z.object({
  name: z.string(),
  version: z.string()
});

const ServerLaunchConfigSchema = z.object({
  jarPath: z.string(),
  port: z.number().int().min(1).max(65535),
  jdkVersion: z.number().int().positive(),
  maxMemory: z.number().int().positive(),
  minMemory: z.number().int().positive(),
  jvmArguments: z.array(z.string()),
  serverArguments: z.array(z.string())
});

const ServerMetadataSchema = z.object({
  createdAt: z.string(),
  updatedAt: z.string(),
  lastStartedAt: z.string().nullable(),
  totalUptime: z.number().nonnegative()
});

const AutoRestartConfigSchema = z.object({
  enabled: z.boolean(),
  maxConsecutiveRestarts: z.number().int().positive(),
  resetThresholdSeconds: z.number().int().positive()
});

const ServerInstanceSchema = z.object({
  uuid: z.string().uuid(),
  name: z.string(),
  note: z.string(),
  status: z.enum(['stopped', 'running', 'crashed']),
  software: ServerSoftwareSchema,
  launchConfig: ServerLaunchConfigSchema,
  metadata: ServerMetadataSchema,
  autoRestart: AutoRestartConfigSchema
});

export const ServerManagerConfigSchema = z.object({
  configVersion: z.string(),
  instances: z.array(ServerInstanceSchema),
  lastUpdated: z.string()
});
```

---

### **10.3 ã‚¯ãƒ©ã‚¹åˆ¥ã®é‡è¦ãªå®Ÿè£…ä»•æ§˜**

#### **ServerManager**

**ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã®åˆæœŸåŒ–é †åº:**

```mermaid
graph LR
    A[ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®š] --> B[ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ]
    B --> C[Pinoãƒ­ã‚¬ãƒ¼åˆæœŸåŒ–]
    C --> D[ServerValidatorç”Ÿæˆ]
    D --> E[MapåˆæœŸåŒ–]
```

**é‡è¦ãªä»•æ§˜:**
1. ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯`recursive: true`ã§ä½œæˆ
2. Validatorã«ã¯`this`ï¼ˆServerManagerè‡ªèº«ï¼‰ã‚’æ¸¡ã™
3. `instances`ã¨`uptimeIntervals`ã¯ç©ºã®Mapã§åˆæœŸåŒ–

**Wrapperç”Ÿæˆæ™‚ã®å¼•æ•°é †åº:**
```typescript
new ServerInstanceWrapper(
  data,
  this.serversBasePath,  // â† å¿…é ˆ
  this.jdkManager,
  this.logger,
  (event) => this.handleInstanceEvent(event)
)
```

**ç¨¼åƒæ™‚é–“è¿½è·¡ã®ä»•æ§˜:**
- èµ·å‹•æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
- 5åˆ†ã”ã¨ã«`updateUptime()`ã‚’å®Ÿè¡Œ
- åœæ­¢æ™‚ã«æœ€çµ‚æ›´æ–°ã—ã¦ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢
- `uptimeIntervals`ãƒãƒƒãƒ—ã§ç®¡ç†

**è¨­å®šä¿å­˜æ™‚ã®è‡ªå‹•æ›´æ–°:**
- `saveConfig()`å‘¼ã³å‡ºã—æ™‚ã«`config.lastUpdated`ã‚’è‡ªå‹•æ›´æ–°
- ISO 8601å½¢å¼ã®ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š

**è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ‰±ã„:**
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯è‡ªå‹•ä½œæˆ
- ã‚µãƒ¼ãƒãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯`recursive: true`ã§ä½œæˆ

---

#### **ServerValidator**

**ä¾å­˜ã®æ€§è³ª:**

```mermaid
graph LR
    SV[ServerValidator] -->|èª­ã¿å–ã‚Šå°‚ç”¨| SM[ServerManager]
    SV -->|èª­ã¿å–ã‚Šå°‚ç”¨| JDK[JDKManager]
    
    Note[ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã¯è¡Œã‚ãªã„]
    
    style Note fill:#fff9c4
```

**ä½¿ç”¨ã™ã‚‹ServerManagerã®ãƒ¡ã‚½ãƒƒãƒ‰:**
- `getInstanceByName()` - åå‰é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨
- `getAllInstances()` - ãƒãƒ¼ãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨
- `getRunningInstances()` - ç¨¼åƒä¸­ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ç”¨

**ä½¿ç”¨ã™ã‚‹JDKManagerã®ãƒ¡ã‚½ãƒƒãƒ‰:**
- `Entrys.getByVersion()` - JDKå­˜åœ¨ç¢ºèªç”¨

**è­¦å‘Šã¨ã‚¨ãƒ©ãƒ¼ã®åŒºåˆ¥:**

| çµæœ | æ„å‘³ | å‡¦ç† |
|------|------|------|
| `valid: true` | å•é¡Œãªã— | å‡¦ç†ç¶šè¡Œ |
| `valid: true, warnings: [...]` | æ³¨æ„ãŒå¿…è¦ | è­¦å‘Šãƒ­ã‚°è¨˜éŒ²å¾Œã€å‡¦ç†ç¶šè¡Œ |
| `valid: false, error: "..."` | ã‚¨ãƒ©ãƒ¼ | å‡¦ç†ä¸­æ–­ã€ã‚¨ãƒ©ãƒ¼è¿”å´ |

**ãƒ¡ãƒ¢ãƒªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæº–:**
- æœ€å°ãƒ¡ãƒ¢ãƒª: 512MBä»¥ä¸Š
- æœ€å¤§ãƒ¡ãƒ¢ãƒª >= æœ€å°ãƒ¡ãƒ¢ãƒª
- ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒªã®80%è¶…é: è­¦å‘Š
- åˆ©ç”¨å¯èƒ½ãƒ¡ãƒ¢ãƒªè¶…é: è­¦å‘Š

---

#### **ServerPropertiesManager**

**ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ€§è³ª:**

```mermaid
graph TB
    Call1[å‘¼ã³å‡ºã—1] --> New1[new ServerPropertiesManager]
    Call2[å‘¼ã³å‡ºã—2] --> New2[new ServerPropertiesManager]
    
    New1 -.ä½¿ã„æ¨ã¦.-> GC1[GC]
    New2 -.ä½¿ã„æ¨ã¦.-> GC2[GC]
    
    Note[æ¯å›æ–°è¦ç”Ÿæˆ<br/>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ä¿æŒã—ãªã„]
    
    style Note fill:#fff9c4
```

**1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ = 1ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸå‰‡:**
- å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯1ã¤ã®`server.properties`ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ç®¡ç†
- å†…éƒ¨ã®Mapã¯ã€Œ1ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆkey-valueï¼‰ã€ã‚’è¡¨ç¾
- è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã™ã‚‹å ´åˆã¯ã€è¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ

**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è§£æã®ä»•æ§˜:**
- ç©ºè¡Œã¨ã‚³ãƒ¡ãƒ³ãƒˆè¡Œï¼ˆ`#`ã§å§‹ã¾ã‚‹ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
- `key=value`å½¢å¼ã‚’ãƒ‘ãƒ¼ã‚¹
- `=`ãŒå«ã¾ã‚Œãªã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
- å‰å¾Œã®ç©ºç™½ã¯ãƒˆãƒªãƒ 

**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ›´æ–°ã®ä»•æ§˜:**
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
- æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯è©²å½“ã‚­ãƒ¼ã®ã¿æ›´æ–°
- ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ä¿æŒ

**æ‹¡å¼µæ–¹æ³•:**
- `updatePort()`ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ–°ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
- å‹å®šç¾©ã¯å¿…è¦ã«å¿œã˜ã¦ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰

---

#### **ServerInstanceWrapper**

**serversBasePathã®é‡è¦æ€§:**

ServerInstanceWrapperã¯è‡ªå·±å®Œçµçš„ã«ãƒ‘ã‚¹ã‚’ç®¡ç†ã—ã¾ã™ã€‚

```mermaid
graph LR
    Base[serversBasePath<br/>"./servers"] --> Name[data.name<br/>"survival-server"]
    Name --> Working[workingDir<br/>"./servers/survival-server"]
    
    Working --> Jar[jarPath<br/>"./servers/survival-server/server.jar"]
    Working --> Props[server.properties<br/>"./servers/survival-server/server.properties"]
```

**ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å¼•æ•°:**
```typescript
constructor(
  data: ServerInstance,
  serversBasePath: string,  // â† è‡ªå·±å®Œçµã®ãŸã‚ã«å¿…é ˆ
  jdkManager: JDKManager,
  logger: Logger,
  notify: NotifyFunction
)
```

**JDKãƒ­ãƒƒã‚¯ç®¡ç†ã®ä»•æ§˜:**
- èµ·å‹•æ™‚ã«`jdkEntry.useRuntime()`ã§ãƒ­ãƒƒã‚¯å–å¾—
- `jdkLockId`ã‚’ä¿æŒ
- åœæ­¢æ™‚ã€ã‚¨ãƒ©ãƒ¼æ™‚ã«å¿…ãš`unUseRuntime()`ã§è§£æ”¾
- è§£æ”¾ã¯finallyãƒ–ãƒ­ãƒƒã‚¯ã¾ãŸã¯cleanup()ã§ç¢ºå®Ÿã«å®Ÿè¡Œ

**è‡ªå‹•å†èµ·å‹•ã®ä»•æ§˜:**

```mermaid
stateDiagram-v2
    [*] --> Running: èµ·å‹•
    Running --> Crashed: exitCode != 0
    Crashed --> CheckAuto: autoRestartç¢ºèª
    CheckAuto --> CheckLimit: enabled=true
    CheckAuto --> Stopped: enabled=false
    CheckLimit --> Restart: ä¸Šé™æœªæº€
    CheckLimit --> Stopped: ä¸Šé™åˆ°é”
    Restart --> Running: å†èµ·å‹•
    Running --> ResetTimer: 10åˆ†çµŒé
    ResetTimer --> Running: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
    Running --> Stopped: exitCode=0
```

**ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ã®ä»•æ§˜:**
- èµ·å‹•æ™‚ã«`setTimeout`ã§10åˆ†å¾Œã®ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
- ã‚¿ã‚¤ãƒãƒ¼ç™ºç«æ™‚ã«`consecutiveRestartCount = 0`
- åœæ­¢æ™‚ã«`clearTimeout()`ã§ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢

**EventEmitterã®ä½¿ç”¨:**
- æ¨™æº–å‡ºåŠ›: `emit('stdout', line)`
- æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›: `emit('stderr', line)`
- ServerManagerçµŒç”±ã§å¤–éƒ¨ã‹ã‚‰ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²å¯èƒ½

**getData()ã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼:**
- å¤–éƒ¨ã‹ã‚‰ã®ç›´æ¥å¤‰æ›´ã‚’é˜²ããŸã‚ã€å¿…ãšãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
- `JSON.parse(JSON.stringify(this.data))`ã‚’ä½¿ç”¨

**updateData()ã®è‡ªå‹•æ›´æ–°:**
- `metadata.updatedAt`ã‚’è‡ªå‹•çš„ã«ç¾åœ¨æ™‚åˆ»ã«æ›´æ–°
- å‘¼ã³å‡ºã—å´ã¯æ„è­˜ã™ã‚‹å¿…è¦ãªã—

**getRuntimeState()ã®ç”¨é€”:**
- ServerManagerãŒç¨¼åƒæ™‚é–“ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«ä½¿ç”¨
- å¤–éƒ¨APIã¨ã—ã¦ã¯å…¬é–‹ã—ãªã„ï¼ˆå†…éƒ¨ä½¿ç”¨ã®ã¿ï¼‰

---

#### **ProcessExecutor**

**å®Œå…¨ç‹¬ç«‹ã‚¯ãƒ©ã‚¹ã®åŸå‰‡:**

```mermaid
graph TB
    PE[ProcessExecutor]
    
    Independent[ServerManager/Wrapper<br/>ã®æ¦‚å¿µã«ä¾å­˜ã—ãªã„]
    Reusable[ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚<br/>å†åˆ©ç”¨å¯èƒ½]
    Generic[æ±ç”¨çš„ãªãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ]
    
    PE --> Independent
    PE --> Reusable
    PE --> Generic
    
    style PE fill:#e8f5e9
    style Independent fill:#c8e6c9
    style Reusable fill:#c8e6c9
    style Generic fill:#c8e6c9
```

**æ¨™æº–å…¥å‡ºåŠ›ã®è¡Œå˜ä½å‡¦ç†:**
- `readline.createInterface()`ã‚’ä½¿ç”¨
- `crlfDelay: Infinity`ã§æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’çµ±ä¸€
- `line`ã‚¤ãƒ™ãƒ³ãƒˆã§1è¡Œãšã¤å‡¦ç†

**åˆ¶å¾¡æ–‡å­—å¯¾å¿œã®ä»•æ§˜:**

| ãƒ¡ã‚½ãƒƒãƒ‰ | å‹•ä½œ | ç”¨é€” |
|---------|------|------|
| `sendCommand(text)` | ãƒ†ã‚­ã‚¹ãƒˆ + Enter | é€šå¸¸ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ |
| `sendInput(text)` | ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼ˆEnterãªã—ï¼‰ | éƒ¨åˆ†å…¥åŠ›ã€Tabè£œå®Œå‰ |
| `sendControlCharacter(char)` | åˆ¶å¾¡æ–‡å­—é€ä¿¡ | Ctrl+Cã€Tabç­‰ |

**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã®ä»•æ§˜:**
- `stop()`ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚å¼·åˆ¶çµ‚äº†ã—ãªã„
- `onStopTimeout`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§é€šçŸ¥ã®ã¿
- `kill()`ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹

**cleanup()ã®é‡è¦æ€§:**
- `exit`ã‚¤ãƒ™ãƒ³ãƒˆã¨`error`ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã§å‘¼ã³å‡ºã™
- `stdin.end()`ã‚’å¿…ãšå®Ÿè¡Œ
- ã™ã¹ã¦ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
- `isRunningFlag`ã‚’falseã«è¨­å®š

**ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•å¤±æ•—ã®å³åº§ã®æ¤œå‡º:**
- `spawn()`å®Ÿè¡Œå¾Œã«`process.pid`ã®å­˜åœ¨ã‚’ç¢ºèª
- PIDãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å³åº§ã«ã‚¨ãƒ©ãƒ¼

---

### **10.4 ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®å®šç¾©**

addInstanceæ™‚ã®çœç•¥å¯èƒ½ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ˜ç¢ºã«å®šç¾©ã—ã¾ã™ã€‚

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | ç†ç”± |
|-----------|------------|------|
| `port` | `25565` | Minecraftã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆ |
| `maxMemory` | `2048` MB | ä¸€èˆ¬çš„ãªæ¨å¥¨å€¤ |
| `minMemory` | `1024` MB | æœ€å°é™ã®å®‰å®šå‹•ä½œ |
| `jvmArguments` | `[]` | ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãªã— |
| `serverArguments` | `["--nogui"]` | GUIãªã—ã§èµ·å‹• |
| `autoRestart.enabled` | `false` | æ˜ç¤ºçš„ã«æœ‰åŠ¹åŒ–ãŒå¿…è¦ |
| `autoRestart.maxConsecutiveRestarts` | `3` | éåº¦ãªå†èµ·å‹•ã‚’é˜²ã |
| `autoRestart.resetThresholdSeconds` | `600` | 10åˆ† |
| `status` | `"stopped"` | åˆæœŸçŠ¶æ…‹ |
| `metadata.totalUptime` | `0` | åˆæœŸå€¤ |
| `metadata.lastStartedAt` | `null` | æœªèµ·å‹• |

---

### **10.5 é‡è¦ãªå‡¦ç†é †åº**

#### **updateInstance()ã§ã®nameå¤‰æ›´ã¨portå¤‰æ›´ã®åŒæ™‚å‡¦ç†**

```mermaid
sequenceDiagram
    participant U as updateInstance
    participant FS as FileSystem
    participant PM as PropertiesManager
    
    Note over U: nameå¤‰æ›´ã‚’å…ˆã«å®Ÿè¡Œ
    U->>FS: rename(oldDir, newDir)
    FS-->>U: å®Œäº†
    U->>U: currentName = newName
    
    Note over U: portå¤‰æ›´ã¯æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã§å®Ÿè¡Œ
    U->>PM: new ServerPropertiesManager(newDir/server.properties)
    U->>PM: updatePort(newPort)
    PM-->>U: å®Œäº†
```

**é‡è¦:** nameå¤‰æ›´å¾Œã®æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’ä½¿ç”¨ã—ã¦server.propertiesã‚’æ›´æ–°ã—ã¾ã™ã€‚

---

#### **removeInstance()ã§ã®å‡¦ç†é †åº**

```mermaid
flowchart TD
    Start([removeInstance]) --> Check1[èµ·å‹•çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯]
    Check1 --> Delete[ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤]
    Delete --> Success{æˆåŠŸ?}
    
    Success -->|No| Cancel[å…¨å‡¦ç†ã‚­ãƒ£ãƒ³ã‚»ãƒ«<br/>ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå¤‰æ›´ãªã—]
    Success -->|Yes| RemoveMap[Mapã‹ã‚‰å‰Šé™¤]
    RemoveMap --> RemoveTimer[ã‚¿ã‚¤ãƒãƒ¼å‰Šé™¤]
    RemoveTimer --> SaveConfig[è¨­å®šä¿å­˜]
    
    Cancel --> End([çµ‚äº†])
    SaveConfig --> End
    
    style Cancel fill:#ffcdd2
    style SaveConfig fill:#c8e6c9
```

**é‡è¦:** ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’æ›´æ–°ã—ã¾ã™ã€‚

---

#### **addInstance()ã§ã®å‡¦ç†é †åºã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**

```mermaid
flowchart TD
    Start([addInstance]) --> Validate[Validatoræ¤œè¨¼]
    Validate --> CreateDir[ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ]
    CreateDir --> CopyJar[jarç§»å‹•]
    CopyJar --> CreateEula[eula.txtä½œæˆ]
    CreateEula --> CreateProps[server.propertiesä½œæˆ]
    
    CreateProps --> PropsOK{æˆåŠŸ?}
    PropsOK -->|No| Rollback[ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨å‰Šé™¤]
    PropsOK -->|Yes| Continue[ä»¥é™ã®å‡¦ç†]
    
    Rollback --> Error[Errorè¿”å´]
    Continue --> Success[Successè¿”å´]
    
    style Rollback fill:#ffcdd2
    style Success fill:#c8e6c9
```

**é‡è¦:** server.propertiesä½œæˆã«å¤±æ•—ã—ãŸå ´åˆã€ä½œæˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨å‰Šé™¤ã—ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚

---

### **10.6 ç‰¹åˆ¥ãªæ›´æ–°ä»•æ§˜**

#### **updateInstance()ã®noteæ›´æ–°**

```mermaid
flowchart TD
    Start([updateInstance]) --> Parse[updatesåˆ†è§£]
    Parse --> Check{noteã®ã¿?}
    
    Check -->|Yes| DirectUpdate[å³åº§ã«æ›´æ–°<br/>èµ·å‹•çŠ¶æ…‹ç„¡è¦–]
    Check -->|No| CheckRunning{èµ·å‹•ä¸­?}
    
    CheckRunning -->|Yes| Error[Error:<br/>èµ·å‹•ä¸­ã¯æ›´æ–°ä¸å¯]
    CheckRunning -->|No| NormalUpdate[é€šå¸¸ã®æ›´æ–°å‡¦ç†]
    
    DirectUpdate --> Save[è¨­å®šä¿å­˜]
    NormalUpdate --> Save
    Save --> Success[Success]
    
    Error --> End([çµ‚äº†])
    Success --> End
    
    style DirectUpdate fill:#c8e6c9
    style Error fill:#ffcdd2
```

**æ›´æ–°å¯èƒ½ãªé …ç›®:**

| é …ç›® | èµ·å‹•ä¸­ | åˆ¶ç´„ | ç‰¹è¨˜äº‹é … |
|------|--------|------|---------|
| `note` | âœ… å¯èƒ½ | ãªã— | å”¯ä¸€èµ·å‹•ä¸­ã§ã‚‚æ›´æ–°å¯èƒ½ |
| `name` | âŒ ä¸å¯ | é‡è¤‡ä¸å¯ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚‚å¤‰æ›´ |
| `port` | âŒ ä¸å¯ | é‡è¤‡ä¸å¯ | server.propertiesã‚‚æ›´æ–° |
| ãã®ä»– | âŒ ä¸å¯ | - | åœæ­¢ä¸­ã®ã¿ |

---

### **10.7 JDKManagerã¨ã®é€£æºä»•æ§˜**

#### **å‰ææ¡ä»¶**

```mermaid
graph LR
    Init1[JDKManagerç”Ÿæˆ] --> Init2[Data.load or init]
    Init2 --> Init3[ServerManager.initialize]
    Init3 --> Ready[æº–å‚™å®Œäº†]
    
    style Init2 fill:#fff9c4
    Note[JDKManagerã¯å¿…ãš<br/>åˆæœŸåŒ–æ¸ˆã¿ã§æ¸¡ã™]
```

**ServerManagerã«æ¸¡ã™JDKManagerã¯å¿…ãšåˆæœŸåŒ–æ¸ˆã¿**ï¼ˆ`Data.load()`ã¾ãŸã¯`Data.init()`å®Ÿè¡Œæ¸ˆã¿ï¼‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### **JDKå–å¾—ã®æµã‚Œ**

```mermaid
sequenceDiagram
    participant W as Wrapper
    participant JDK as JDKManager
    participant Entry as JDKEntry
    
    W->>JDK: Entrys.getByVersion(version)
    JDK-->>W: Result~JDKEntry~
    
    alt success = false
        W->>W: Error: JDK not found
    end
    
    W->>Entry: getExecutableFilePath()
    Entry-->>W: "/path/to/java"
    
    W->>Entry: useRuntime(purpose)
    Entry-->>W: lockId
    
    Note over W: ãƒ—ãƒ­ã‚»ã‚¹ä½¿ç”¨ä¸­...
    
    W->>Entry: unUseRuntime(lockId)
    Entry-->>W: Result~void~
```

**ä½¿ç”¨ã™ã‚‹JDKManagerã®API:**
- `Entrys.getByVersion(majorVersion: number): Result<JDKEntry>`
- `JDKEntry.getExecutableFilePath(): string`
- `JDKEntry.useRuntime(purpose?: string): string`
- `JDKEntry.unUseRuntime(lockId: string): Result<void>`

---

### **10.8 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ä»•æ§˜**

**ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** `"1.0.0"`

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã®å‡¦ç†:**
```mermaid
flowchart TD
    Load[è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿] --> Parse[JSONè§£æ]
    Parse --> CheckVer{configVersion<br/>ãƒã‚§ãƒƒã‚¯}
    
    CheckVer -->|"1.0.0"| Valid[æ­£å¸¸]
    CheckVer -->|ãã®ä»–| Warn[è­¦å‘Šãƒ­ã‚°è¨˜éŒ²]
    
    Warn --> Future[å°†æ¥çš„ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³]
    Future --> Valid
    
    Valid --> Zod[Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    
    style Warn fill:#fff9c4
    style Future fill:#e0e0e0
```

**ç¾æ™‚ç‚¹ã®å®Ÿè£…:**
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ`"1.0.0"`ã§ãªã„å ´åˆã€è­¦å‘Šãƒ­ã‚°ã‚’è¨˜éŒ²
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã§æ®‹ã™
- Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯å®Ÿè¡Œ

---

### **10.9 ã‚¨ãƒ©ãƒ¼ã®åˆ†é¡ã¨å¯¾å¿œæ–¹é‡**

#### **ã‚¨ãƒ©ãƒ¼ã®é‡å¤§åº¦**

| é‡å¤§åº¦ | èª¬æ˜ | å¯¾å¿œ |
|--------|------|------|
| **Critical** | ã‚·ã‚¹ãƒ†ãƒ ãŒå‹•ä½œä¸èƒ½ | å³åº§ã«ã‚¨ãƒ©ãƒ¼è¿”å´ã€å‡¦ç†ä¸­æ–­ |
| **High** | æ©Ÿèƒ½ãŒä½¿ç”¨ä¸å¯ | ã‚¨ãƒ©ãƒ¼è¿”å´ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| **Medium** | ä¸€éƒ¨æ©Ÿèƒ½ã«å½±éŸ¿ | è­¦å‘Šãƒ­ã‚°ã€å‡¦ç†ç¶™ç¶šå¯èƒ½ |
| **Low** | æ³¨æ„ãŒå¿…è¦ | è­¦å‘Šã®ã¿ã€å‡¦ç†ç¶™ç¶š |

#### **ãƒªãƒˆãƒ©ã‚¤æ–¹é‡**

```mermaid
graph TB
    Error[ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ] --> Type{ç¨®åˆ¥}
    
    Type -->|ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³| NoRetry[ãƒªãƒˆãƒ©ã‚¤ä¸å¯<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿®æ­£å¿…è¦]
    Type -->|ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯| ManualRetry[æ‰‹å‹•ãƒªãƒˆãƒ©ã‚¤<br/>åŸå› è§£æ±ºå¾Œ]
    Type -->|ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯| AutoRetry[è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤<br/>å°†æ¥çš„ã«å®Ÿè£…]
    Type -->|ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼| ManualRetry
    
    style NoRetry fill:#ffcdd2
    style ManualRetry fill:#fff9c4
    style AutoRetry fill:#e0e0e0
```

**ç¾æ™‚ç‚¹ã®æ–¹é‡:**
- è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã¯å®Ÿè£…ã—ãªã„
- ã™ã¹ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŸå› ã‚’è§£æ±ºã—ã¦ã‹ã‚‰æ‰‹å‹•ã§ãƒªãƒˆãƒ©ã‚¤
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾å‡¦æ³•ã‚’å«ã‚ã‚‹

---

### **10.10 æ—¢çŸ¥ã®åˆ¶ç´„ã¨æ‡¸å¿µäº‹é …**

å®Ÿè£…æ™‚ã«ç†è§£ã—ã¦ãŠãã¹ãåˆ¶ç´„ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯`docs/faq.md`ã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚

#### **1. ãƒãƒ¼ãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ã®åˆ¶é™**

**åˆ¶ç´„:**
- ç®¡ç†ä¸‹ã®ã‚µãƒ¼ãƒãƒ¼é–“ã§ã®ãƒãƒ¼ãƒˆé‡è¤‡ã®ã¿æ¤œå‡º
- å¤–éƒ¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½¿ç”¨ä¸­ã®ãƒãƒ¼ãƒˆã¯æ¤œå‡ºä¸å¯
- OSå´ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒˆã‚‚æ¤œå‡ºä¸å¯

**å¯¾å¿œ:** FAQã«è¨˜è¼‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ`netstat`ç­‰ã§ç¢ºèª

---

#### **2. ã‚¯ãƒ©ãƒƒã‚·ãƒ¥åˆ¤å®šã®åˆ¶ç´„**

**ç¾åœ¨ã®å®Ÿè£…:**
- `exitCode === 0`: æ­£å¸¸çµ‚äº†
- `exitCode !== 0`: ã‚¯ãƒ©ãƒƒã‚·ãƒ¥

**æ‡¸å¿µ:**
- ä¸€éƒ¨ã®ã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯æ­£å¸¸çµ‚äº†ã§ã‚‚`exitCode !== 0`ã‚’è¿”ã™å¯èƒ½æ€§
- ç¾æ™‚ç‚¹ã§ã¯é­é‡ã—ã¦ã„ãªã„ãŒã€å°†æ¥çš„ã«ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š

**å¯¾å¿œ:** FAQã«æ—¢çŸ¥ã®å•é¡Œã¨ã—ã¦è¨˜è¼‰ã€é­é‡æ™‚ã«æ”¹å–„ã‚’æ¤œè¨

---

#### **3. jarãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ãªã—**

**åˆ¶ç´„:**
- jarãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ¬å½“ã«Minecraftã‚µãƒ¼ãƒãƒ¼ã‹ã¯æ¤œè¨¼ã—ãªã„
- èµ·å‹•ã—ã¦ã¿ãªã„ã¨åˆ¤æ˜ã—ãªã„

**ç†ç”±:** æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘ã€æ§˜ã€…ãªã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¸ã®å¯¾å¿œãŒå›°é›£

**å¯¾å¿œ:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è²¬ä»»ã¨ã—ã¦æ‰±ã†

---

#### **4. ãƒ¡ãƒ¢ãƒªä¸è¶³ã®æ¤œå‡º**

**åˆ¶ç´„:**
- Validatorã§è­¦å‘Šã¯å‡ºã™ãŒã€èµ·å‹•ã¯è©¦ã¿ã‚‹
- å®Ÿéš›ã®ãƒ¡ãƒ¢ãƒªä¸è¶³ã¯èµ·å‹•æ™‚ã«åˆ¤æ˜

**ç†ç”±:** ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è²¬ä»»

**å¯¾å¿œ:** è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ³¨æ„å–šèµ·

---

### **10.11 å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®è¿½åŠ é …ç›®**

ã€Œ9. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

#### **å‹å®šç¾©**
- [ ] `ServerManagerResult<T>`å‹ã®å®šç¾©
- [ ] `VoidResult`å‹ã®å®šç¾©
- [ ] `AddInstanceResult`å‹ã®å®šç¾©
- [ ] `AddInstanceParams`å‹ã®å®šç¾©
- [ ] `UpdateInstanceParams`å‹ã®å®šç¾©
- [ ] `ControlCharacter`åˆ—æŒ™å‹ã®å®šç¾©
- [ ] Zodã‚¹ã‚­ãƒ¼ãƒã®è©³ç´°ç‰ˆå®Ÿè£…

#### **ServerManager - è¿½åŠ é …ç›®**
- [ ] ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è‡ªå‹•ä½œæˆ
- [ ] Wrapperç”Ÿæˆæ™‚ã«`serversBasePath`ã‚’æ¸¡ã™
- [ ] `updateInstance()`ã§noteã®ã¿èµ·å‹•ä¸­æ›´æ–°å¯èƒ½
- [ ] `updateInstance()`ã§nameå¤‰æ›´ã¨portå¤‰æ›´ã®é †åºåˆ¶å¾¡
- [ ] `removeInstance()`ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•—æ™‚ã¯å…¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- [ ] `uptimeIntervals`ã®é©åˆ‡ãªå‰Šé™¤ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
- [ ] `saveConfig()`å‰ã«`config.lastUpdated`ã‚’è‡ªå‹•æ›´æ–°
- [ ] è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰
- [ ] ã‚µãƒ¼ãƒãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆæ™‚ã«`recursive: true`ã‚’ä½¿ç”¨

#### **ServerValidator - è¿½åŠ é …ç›®**
- [ ] `os.totalmem()`ã¨`os.freemem()`ã‚’ä½¿ç”¨ã—ãŸãƒ¡ãƒ¢ãƒªãƒã‚§ãƒƒã‚¯
- [ ] è­¦å‘Šã¨ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªåŒºåˆ¥

#### **ServerPropertiesManager - è¿½åŠ é …ç›®**
- [ ] ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è§£ææ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã¨ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
- [ ] `=`ãŒå«ã¾ã‚Œãªã„è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
- [ ] æ—¢å­˜ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ä¿æŒï¼ˆæ›´æ–°æ™‚ï¼‰

#### **ServerInstanceWrapper - è¿½åŠ é …ç›®**
- [ ] ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§`serversBasePath`ã‚’å—ã‘å–ã‚‹
- [ ] `getRuntimeState()`ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ï¼ˆServerManagerå°‚ç”¨ï¼‰
- [ ] JDKãƒ­ãƒƒã‚¯è§£æ”¾ã®ç¢ºå®Ÿãªå®Ÿè¡Œï¼ˆfinally/cleanupï¼‰
- [ ] `getData()`ã§ã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
- [ ] `updateData()`ã§ã®`metadata.updatedAt`è‡ªå‹•æ›´æ–°
- [ ] ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ã®é©åˆ‡ãªç®¡ç†

#### **ProcessExecutor - è¿½åŠ é …ç›®**
- [ ] `readline.createInterface()`ã®ä½¿ç”¨
- [ ] `crlfDelay: Infinity`ã®è¨­å®š
- [ ] `stdin.end()`ã®å‘¼ã³å‡ºã—
- [ ] `process.pid`ã®å­˜åœ¨ç¢ºèª
- [ ] `exit`ã¨`error`ä¸¡ã‚¤ãƒ™ãƒ³ãƒˆã§ã®`cleanup()`å‘¼ã³å‡ºã—
- [ ] `sendInput()`ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
- [ ] `sendControlCharacter()`ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…

---

### **10.12 ãƒ†ã‚¹ãƒˆé …ç›®ã®è¿½åŠ **

ã€Œ8.1 ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§ã€ã«ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

#### **è‡ªå‹•å†èµ·å‹•ã®ãƒ†ã‚¹ãƒˆ**

| ID | ãƒ†ã‚¹ãƒˆé …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|----|----------|------|---------|
| TC-301 | è‡ªå‹•å†èµ·å‹•æˆåŠŸ | autoRestartæœ‰åŠ¹ãªã‚µãƒ¼ãƒãƒ¼ã‚’ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã•ã›ã‚‹ | è‡ªå‹•çš„ã«å†èµ·å‹•ã€`consecutiveRestartCount`ãŒå¢—åŠ  |
| TC-302 | å†èµ·å‹•ä¸Šé™åˆ°é” | çŸ­æ™‚é–“ã§3å›ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã•ã›ã‚‹ | `onAutoRestartLimitReached`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç™ºç«ã€å†èµ·å‹•ã—ãªã„ |
| TC-303 | ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ | ã‚¯ãƒ©ãƒƒã‚·ãƒ¥å¾Œ10åˆ†ä»¥ä¸Šç¨¼åƒã•ã›ã¦ã‹ã‚‰å†åº¦ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ | `consecutiveRestartCount`ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ |

#### **æ¨™æº–å…¥å‡ºåŠ›ã®ãƒ†ã‚¹ãƒˆ**

| ID | ãƒ†ã‚¹ãƒˆé …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|----|----------|------|---------|
| TC-401 | ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ | `sendCommand('list')`ã‚’å®Ÿè¡Œ | æ¨™æº–å‡ºåŠ›ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| TC-402 | åˆ¶å¾¡æ–‡å­—é€ä¿¡ï¼ˆCtrl+Cï¼‰ | `sendControlCharacter(CTRL_C)`ã‚’å®Ÿè¡Œ | ãƒ—ãƒ­ã‚»ã‚¹ãŒå‰²ã‚Šè¾¼ã¾ã‚Œã‚‹ |
| TC-403 | åˆ¶å¾¡æ–‡å­—é€ä¿¡ï¼ˆTabï¼‰ | éƒ¨åˆ†å…¥åŠ›å¾Œã«`sendControlCharacter(TAB)`ã‚’å®Ÿè¡Œ | è£œå®Œå€™è£œãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| TC-404 | ãƒªã‚¹ãƒŠãƒ¼è§£é™¤ | `openProcessStd`å¾Œã«`closeProcessStd`ã‚’å®Ÿè¡Œ | ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒç™ºç«ã—ãªããªã‚‹ |

#### **è¨­å®šæ›´æ–°ã®ãƒ†ã‚¹ãƒˆ**

| ID | ãƒ†ã‚¹ãƒˆé …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|----|----------|------|---------|
| TC-501 | noteæ›´æ–°ï¼ˆèµ·å‹•ä¸­ï¼‰ | èµ·å‹•ä¸­ã®ã‚µãƒ¼ãƒãƒ¼ã®noteã‚’æ›´æ–° | æˆåŠŸ |
| TC-502 | ãã®ä»–æ›´æ–°ï¼ˆèµ·å‹•ä¸­ï¼‰ | èµ·å‹•ä¸­ã®ã‚µãƒ¼ãƒãƒ¼ã®maxMemoryã‚’æ›´æ–° | ã‚¨ãƒ©ãƒ¼: "èµ·å‹•ä¸­ã¯noteã®ã¿æ›´æ–°å¯èƒ½" |
| TC-503 | nameå¤‰æ›´ | åœæ­¢ä¸­ã®ã‚µãƒ¼ãƒãƒ¼ã®nameã‚’å¤‰æ›´ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚‚å¤‰æ›´ã•ã‚Œã‚‹ |
| TC-504 | portå¤‰æ›´ | åœæ­¢ä¸­ã®ã‚µãƒ¼ãƒãƒ¼ã®portã‚’å¤‰æ›´ | server.propertiesã®server-portè¡ŒãŒæ›´æ–°ã•ã‚Œã‚‹ |
| TC-505 | name+portåŒæ™‚å¤‰æ›´ | nameã¨portã‚’åŒæ™‚ã«å¤‰æ›´ | æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã§server.propertiesãŒæ›´æ–°ã•ã‚Œã‚‹ |

---

### **10.13 FAQã®è¿½åŠ é …ç›®**

ã€Œ8.2 FAQã€ã«ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

```markdown
## ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œé–¢é€£

### Q3: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ã«å¤±æ•—ã™ã‚‹

**åŸå› :**
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½¿ç”¨ä¸­ï¼ˆãƒ­ãƒƒã‚¯çŠ¶æ…‹ï¼‰
- ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Œå…¨ã«çµ‚äº†ã—ã¦ã„ãªã„
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é–‹ã„ã¦ã„ã‚‹
- ã‚¢ãƒ³ãƒã‚¦ã‚¤ãƒ«ã‚¹ã‚½ãƒ•ãƒˆãŒã‚¹ã‚­ãƒ£ãƒ³ä¸­

**å¯¾å‡¦æ³•:**
1. ã‚µãƒ¼ãƒãƒ¼ãŒå®Œå…¨ã«åœæ­¢ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’é–‰ã˜ã‚‹
3. ã‚¿ã‚¹ã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§Javaãƒ—ãƒ­ã‚»ã‚¹ãŒæ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèª
4. ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ

**é‡è¦:** ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ã«å¤±æ•—ã—ãŸå ´åˆã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã‚´ãƒŸãƒ•ã‚¡ã‚¤ãƒ«ã®è“„ç©ã‚’é˜²ããŸã‚ã®ä»•æ§˜ã§ã™ã€‚

---

## server.propertiesé–¢é€£

### Q4: ãƒãƒ¼ãƒˆã‚’å¤‰æ›´ã—ãŸã®ã«ã‚µãƒ¼ãƒãƒ¼ãŒå¤ã„ãƒãƒ¼ãƒˆã§èµ·å‹•ã™ã‚‹

**åŸå› :**
- server.propertiesã®æ›´æ–°ã«å¤±æ•—ã—ãŸ
- æ›´æ–°å¾Œã«ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã—ã¦ã„ãªã„

**å¯¾å‡¦æ³•:**
1. ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
2. æ‰‹å‹•ã§server.propertiesã‚’ç¢ºèª
3. server-portè¡ŒãŒæ­£ã—ã„ã‹ç¢ºèª
4. ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
5. ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦server.propertiesæ›´æ–°ã®ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯

---

## ãƒ¡ãƒ¢ãƒªé–¢é€£

### Q5: ãƒ¡ãƒ¢ãƒªä¸è¶³ã§èµ·å‹•ã«å¤±æ•—ã™ã‚‹

**åŸå› :**
- ã‚·ã‚¹ãƒ†ãƒ ã®ç©ºããƒ¡ãƒ¢ãƒªãŒä¸è¶³
- ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ¡ãƒ¢ãƒªã‚’å¤§é‡æ¶ˆè²»
- è¨­å®šã—ãŸmaxMemoryãŒå¤§ãã™ãã‚‹

**å¯¾å‡¦æ³•:**
1. ã‚¿ã‚¹ã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèª
2. ä¸è¦ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
3. ã‚µãƒ¼ãƒãƒ¼ã®`maxMemory`è¨­å®šã‚’ä¸‹ã’ã‚‹
4. ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ¢ãƒªã®å¢—è¨­ã‚’æ¤œè¨
```

---

### **10.14 å®Ÿè£…ã®æ¨å¥¨é †åº**

```mermaid
graph TB
    S1[Step 1: å‹å®šç¾©<br/>ã™ã¹ã¦ã®å‹ã‚’å®šç¾©] --> S2[Step 2: å®šæ•°å®šç¾©<br/>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç­‰]
    S2 --> S3[Step 3: ProcessExecutor<br/>å®Œå…¨ç‹¬ç«‹ã‚¯ãƒ©ã‚¹]
    S3 --> S4[Step 4: ServerPropertiesManager<br/>å®Œå…¨ç‹¬ç«‹ã‚¯ãƒ©ã‚¹]
    S4 --> S5[Step 5: ServerValidator<br/>ä¾å­˜ãŒå°‘ãªã„]
    S5 --> S6[Step 6: ServerInstanceWrapper<br/>ProcessExecutorã«ä¾å­˜]
    S6 --> S7[Step 7: ServerManager<br/>ã™ã¹ã¦ã«ä¾å­˜]
    S7 --> S8[Step 8: ãƒ†ã‚¹ãƒˆå®Ÿè£…]
    S8 --> S9[Step 9: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ]
    
    style S1 fill:#e1f5ff
    style S2 fill:#e1f5ff
    style S3 fill:#e8f5e9
    style S4 fill:#e8f5e9
    style S5 fill:#fff3e0
    style S6 fill:#fff4e1
    style S7 fill:#e1f5ff
    style S8 fill:#fff9c4
    style S9 fill:#c8e6c9
```

**ç†ç”±:**
- ä¾å­˜é–¢ä¿‚ã®å°‘ãªã„ã‚¯ãƒ©ã‚¹ã‹ã‚‰å®Ÿè£…
- å„ã‚¯ãƒ©ã‚¹ã‚’å˜ä½“ãƒ†ã‚¹ãƒˆã—ãªãŒã‚‰é€²ã‚ã‚‰ã‚Œã‚‹
- å•é¡Œã®æ—©æœŸç™ºè¦‹ãŒå¯èƒ½
- çµ±åˆæ™‚ã®ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“

---

### **10.15 å¿…é ˆã®importæ–‡ä¸€è¦§**

å„ãƒ•ã‚¡ã‚¤ãƒ«ã§å¿…è¦ãªä¸»è¦ãªimportæ–‡ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

#### **ServerManager.ts**
```typescript
import * as fs from 'fs';
import * as path from 'path';
import pino from 'pino';
import { randomUUID } from 'crypto';
import type { JdkManager } from 'jdk-manager';
```

#### **ServerValidator.ts**
```typescript
import * as os from 'os';
import type { JdkManager } from 'jdk-manager';
import type { Logger } from 'pino';
```

#### **ServerPropertiesManager.ts**
```typescript
import * as fs from 'fs';
import * as path from 'path';
import type { Logger } from 'pino';
```

#### **ServerInstanceWrapper.ts**
```typescript
import * as path from 'path';
import { EventEmitter } from 'events';
import type { JdkManager } from 'jdk-manager';
import type { Logger } from 'pino';
```

#### **ProcessExecutor.ts**
```typescript
import { spawn, ChildProcess } from 'child_process';
import { createInterface } from 'readline';
import type { Logger } from 'pino';
```

---

## ğŸ¯ å®Ÿè£…é–‹å§‹ã®æº–å‚™å®Œäº†

### **å®Ÿè£…å‰ã«ç¢ºèªã™ã¹ãã“ã¨**

- âœ… JDKManagerã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§å¯èƒ½
- âœ… test.env.jsonã‚’ä½œæˆæ¸ˆã¿
- âœ… ãƒ†ã‚¹ãƒˆç”¨ã®JDKã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’æº–å‚™
- âœ… ãƒ†ã‚¹ãƒˆç”¨ã®Minecraft Server jarã‚’æº–å‚™
- âœ… å®Ÿè£…ä¾é ¼æ›¸ã¨æœ¬è£œè¶³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç†è§£

### **å®Ÿè£…æ™‚ã®é‡è¦åŸå‰‡**

- âœ… è²¬ä»»åˆ†é›¢ã‚’å¸¸ã«æ„è­˜
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¾¹åº•ï¼ˆtry-catchã§å›²ã‚€ï¼‰
- âœ… ãƒ­ã‚°ã‚’è©³ç´°ã«è¨˜éŒ²ï¼ˆdebug, info, warn, errorï¼‰
- âœ… è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã¯å®Ÿè£…ã—ãªã„
- âœ… ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã‚’é©åˆ‡ã«ä½¿ç”¨

---

## ğŸš€ å®Ÿè£…ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼

ã“ã®è£œè¶³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨å®Ÿè£…ä¾é ¼æ›¸ã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚

**ä¸æ˜ç‚¹ãŒã‚ã‚‹å ´åˆ:**
1. æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å†ç¢ºèª
2. JDKManagerã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§
3. è³ªå•ãƒªã‚¹ãƒˆã‚’ä½œæˆ

**Good luck! ğŸ‰**