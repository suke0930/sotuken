//sonnet 4.5
# Minecraft Server Manager - å®Ÿè£…ä¾é ¼æ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0.0  
**ä½œæˆæ—¥:** 2025-11-03  
**å¯¾è±¡:** ã‚³ãƒ¼ãƒ€ãƒ¼ãƒ»å®Ÿè£…æ‹…å½“è€…

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#1-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
2. [ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#2-ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
3. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ](#3-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ)
4. [å‹å®šç¾©](#4-å‹å®šç¾©)
5. [ã‚¯ãƒ©ã‚¹å®Ÿè£…ä»•æ§˜](#5-ã‚¯ãƒ©ã‚¹å®Ÿè£…ä»•æ§˜)
6. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æŒ‡é‡](#6-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æŒ‡é‡)
7. [ãƒ†ã‚¹ãƒˆä»•æ§˜](#7-ãƒ†ã‚¹ãƒˆä»•æ§˜)
8. [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæŒ‡ç¤º](#8-ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæŒ‡ç¤º)
9. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#9-å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### **ç›®çš„**

Node.js + TypeScriptç’°å¢ƒã§ã€è¤‡æ•°ã®Minecraftã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’çµ±åˆç®¡ç†ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### **ä¸»è¦æ©Ÿèƒ½**

```mermaid
mindmap
  root((Server Manager))
    ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
      è¿½åŠ ãƒ»å‰Šé™¤ãƒ»æ›´æ–°
      ä¸€è¦§å–å¾—
      ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
    ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«åˆ¶å¾¡
      èµ·å‹•ãƒ»åœæ­¢ãƒ»å†èµ·å‹•
      å¼·åˆ¶çµ‚äº†
      è‡ªå‹•å†èµ·å‹•
    å…¥å‡ºåŠ›ç®¡ç†
      æ¨™æº–å…¥å‡ºåŠ›ç›£è¦–
      ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
      åˆ¶å¾¡æ–‡å­—å¯¾å¿œ
    è¨­å®šç®¡ç†
      server.propertiesç·¨é›†
      ãƒãƒ¼ãƒˆç®¡ç†
      ãƒ¡ãƒ¢ãƒªè¨­å®š
    ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      åå‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
      ãƒãƒ¼ãƒˆç«¶åˆãƒã‚§ãƒƒã‚¯
      JDKå­˜åœ¨ç¢ºèª
```

### **è¨­è¨ˆåŸå‰‡**

- âœ… **è²¬ä»»åˆ†é›¢**: å„ã‚¯ãƒ©ã‚¹ãŒæ˜ç¢ºãªè²¬ä»»ã‚’æŒã¤
- âœ… **ç–çµåˆ**: ã‚¯ãƒ©ã‚¹é–“ã®ä¾å­˜ã‚’æœ€å°é™ã«
- âœ… **æ‹¡å¼µæ€§**: å°†æ¥ã®æ©Ÿèƒ½è¿½åŠ ã‚’è€ƒæ…®
- âœ… **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: å˜ä½“ãƒ†ã‚¹ãƒˆå¯èƒ½ãªè¨­è¨ˆ
- âœ… **å¯èª­æ€§**: åˆå¿ƒè€…ã§ã‚‚ç†è§£ã§ãã‚‹ã‚³ãƒ¼ãƒ‰

---

## 2. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### **2.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ **

```
project-root/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ server-schema.ts           # ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â”‚   â”œâ”€â”€ validation.ts              # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‹
â”‚   â”‚   â””â”€â”€ callbacks.ts               # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹
â”‚   â”œâ”€â”€ classes/
â”‚   â”‚   â”œâ”€â”€ ServerManager.ts           # ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
â”‚   â”‚   â”œâ”€â”€ ServerValidator.ts         # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”œâ”€â”€ ServerPropertiesManager.ts # server.propertiesç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ServerInstanceWrapper.ts   # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
â”‚   â”‚   â””â”€â”€ ProcessExecutor.ts         # ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â””â”€â”€ errors.ts                  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°
â”‚   â””â”€â”€ index.ts                       # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ config/
â”‚   â””â”€â”€ server-manager.json            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”œâ”€â”€ servers/                           # ã‚µãƒ¼ãƒãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ manager.log                    # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ setup/
â”‚   â”‚   â””â”€â”€ test.env.json              # ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒè¨­å®š
â”‚   â”œâ”€â”€ unit/                          # å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ integration/                   # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ e2e/                          # E2Eãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ test-cases.md                  # ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§
â”‚   â”œâ”€â”€ faq.md                        # FAQï¼ˆæ—¢çŸ¥ã®å•é¡Œï¼‰
â”‚   â””â”€â”€ api-usage.md                  # APIä½¿ç”¨ä¾‹
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

### **2.2 ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**

```json
{
  "name": "minecraft-server-manager",
  "version": "1.0.0",
  "dependencies": {
    "pino": "^8.16.0",
    "zod": "^3.22.0"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "typescript": "^5.3.0",
    "jest": "^29.7.0",
    "@types/jest": "^29.5.0",
    "ts-jest": "^29.1.0"
  }
}
```

### **2.3 TypeScriptè¨­å®š**

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### **2.4 ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š**

`tests/setup/test.env.json`:
```json
{
  "jdkManager": {
    "configPath": "/path/to/jdk-registry.json",
    "jdkArchives": {
      "jdk8": "/path/to/jdk8.zip",
      "jdk17": "/path/to/jdk17.zip",
      "jdk21": "/path/to/jdk21.zip"
    }
  },
  "minecraftServer": {
    "vanillaJar": "/path/to/minecraft-server-1.20.1.jar",
    "paperJar": "/path/to/paper-1.20.1.jar"
  },
  "testPaths": {
    "configDir": "./tests/tmp/config",
    "serversDir": "./tests/tmp/servers",
    "logsDir": "./tests/tmp/logs"
  }
}
```

---

## 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ

### **3.1 ã‚¯ãƒ©ã‚¹é–¢ä¿‚å›³**

```mermaid
graph TB
    subgraph "å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ "
        UI[UI/Orchestration Layer]
        JDK[JDKManager<br/>å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª]
    end
    
    subgraph "Server Manager System"
        SM[ServerManager<br/>å…¨ä½“çµ±æ‹¬]
        SV[ServerValidator<br/>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
        SPM[ServerPropertiesManager<br/>server.propertiesç®¡ç†]
        
        subgraph "Instance Layer"
            W1[ServerInstanceWrapper 1]
            W2[ServerInstanceWrapper 2]
            WN[ServerInstanceWrapper N]
        end
        
        subgraph "Process Layer"
            PE1[ProcessExecutor 1]
            PE2[ProcessExecutor 2]
            PEN[ProcessExecutor N]
        end
    end
    
    subgraph "Data Layer"
        Config[(server-manager.json)]
        Props[(server.properties)]
        Logs[(manager.log)]
    end
    
    UI -->|initialize, method calls| SM
    SM -.->|callbacks| UI
    SM --> SV
    SM --> SPM
    SM --> JDK
    
    SM --> W1
    SM --> W2
    SM --> WN
    
    W1 --> PE1
    W2 --> PE2
    WN --> PEN
    
    W1 --> JDK
    W2 --> JDK
    WN --> JDK
    
    SM <-->|read/write| Config
    SPM <-->|read/write| Props
    SM -->|write| Logs
    
    style SM fill:#e1f5ff,stroke:#01579b,stroke-width:3px
    style SV fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style SPM fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style W1 fill:#fff4e1,stroke:#f57c00,stroke-width:2px
    style W2 fill:#fff4e1,stroke:#f57c00,stroke-width:2px
    style WN fill:#fff4e1,stroke:#f57c00,stroke-width:2px
    style PE1 fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style PE2 fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style PEN fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
```

### **3.2 è²¬ä»»åˆ†é›¢ãƒãƒˆãƒªã‚¯ã‚¹**

| ã‚¯ãƒ©ã‚¹ | è²¬ä»» | ä¾å­˜å…ˆ | ä¾å­˜å…ƒ |
|-------|------|--------|--------|
| **ServerManager** | å…¨ä½“çµ±æ‹¬ã€è¨­å®šç®¡ç†ã€å¤–éƒ¨API | Validator, Wrapper, JDKManager | UIå±¤ |
| **ServerValidator** | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ | Managerï¼ˆèª­ã¿å–ã‚Šï¼‰, JDKManager | Manager |
| **ServerPropertiesManager** | server.propertiesç®¡ç† | ãªã—ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰ | Manager, Wrapper |
| **ServerInstanceWrapper** | å€‹åˆ¥ã‚µãƒ¼ãƒãƒ¼åˆ¶å¾¡ | ProcessExecutor, JDKManager | Manager |
| **ProcessExecutor** | ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ | ãªã—ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰ | Wrapper |

### **3.3 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**

```mermaid
sequenceDiagram
    participant UI as UI Layer
    participant SM as ServerManager
    participant SV as ServerValidator
    participant W as ServerInstanceWrapper
    participant PE as ProcessExecutor
    participant MC as Minecraft Server
    
    rect rgb(225, 245, 254)
        Note over UI,SM: åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚º
        UI->>SM: initialize(paths, jdkManager, callbacks)
        SM->>SM: loadConfig()
        SM->>SM: createWrappers()
        SM-->>UI: manager instance
    end
    
    rect rgb(255, 243, 224)
        Note over UI,MC: ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ•ã‚§ãƒ¼ã‚º
        UI->>SM: startServer(uuid)
        SM->>SV: validateServerStart(uuid)
        SV-->>SM: validation result
        SM->>W: start()
        W->>PE: new ProcessExecutor()
        W->>PE: start(javaPath, jarPath, args)
        PE->>MC: spawn process
        MC-->>PE: process started
        PE-->>W: started
        W->>SM: reportEvent('started')
        SM->>UI: callbacks.onServerStarted(uuid)
    end
    
    rect rgb(232, 245, 233)
        Note over UI,MC: å®Ÿè¡Œä¸­ãƒ•ã‚§ãƒ¼ã‚º
        UI->>SM: sendCommand(uuid, 'say Hello')
        SM->>W: sendCommand('say Hello')
        W->>PE: sendCommand('say Hello')
        PE->>MC: stdin: 'say Hello\n'
        MC->>PE: stdout: '[Server] Hello'
        PE->>W: emit('stdout', line)
        W->>SM: (EventEmitterçµŒç”±)
        SM->>UI: callbacks.onStdout(line)
    end
```

---

## 4. å‹å®šç¾©

### **4.1 ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒï¼ˆ`types/server-schema.ts`ï¼‰**

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ:**
- Step1ã§ç¢ºå®šã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’ãã®ã¾ã¾ä½¿ç”¨
- Zodã‚¹ã‚­ãƒ¼ãƒã‚‚ä½µã›ã¦å®šç¾©ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰

```typescript
import { z } from 'zod';

// ========================================
// åŸºæœ¬å‹å®šç¾©
// ========================================

export type ServerStatus = 'stopped' | 'running' | 'crashed';

export interface ServerSoftware {
  name: string;
  version: string;
}

export interface ServerLaunchConfig {
  jarPath: string;
  port: number;
  jdkVersion: number;  // âš ï¸ numberå‹ï¼ˆJDKManagerä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
  maxMemory: number;
  minMemory: number;
  jvmArguments: string[];
  serverArguments: string[];
}

export interface ServerMetadata {
  createdAt: string;
  updatedAt: string;
  lastStartedAt: string | null;
  totalUptime: number;
}

export interface AutoRestartConfig {
  enabled: boolean;
  maxConsecutiveRestarts: number;
  resetThresholdSeconds: number;
}

export interface ServerInstance {
  uuid: string;
  name: string;
  note: string;
  status: ServerStatus;
  software: ServerSoftware;
  launchConfig: ServerLaunchConfig;
  metadata: ServerMetadata;
  autoRestart: AutoRestartConfig;
}

export interface ServerManagerConfig {
  configVersion: string;
  instances: ServerInstance[];
  lastUpdated: string;
}

// ========================================
// å®Ÿè¡Œæ™‚å°‚ç”¨å‹ï¼ˆéæ°¸ç¶šåŒ–ï¼‰
// ========================================

export interface RuntimeState {
  consecutiveRestartCount: number;
  lastRestartTime: number | null;
  resetTimerId: NodeJS.Timeout | null;
  currentSessionStartTime: number | null;
}

// ========================================
// Zodã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
// ========================================

export const ServerManagerConfigSchema = z.object({
  configVersion: z.string(),
  instances: z.array(z.any()), // è©³ç´°ã¯çœç•¥å¯
  lastUpdated: z.string()
});
```

### **4.2 ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‹ï¼ˆ`types/validation.ts`ï¼‰**

```typescript
export interface ValidationResult {
  valid: boolean;
  error?: string;
  warnings?: string[];
}

export class ValidationResultHelper {
  static success(warnings?: string[]): ValidationResult {
    return { valid: true, warnings };
  }
  
  static failure(error: string): ValidationResult {
    return { valid: false, error };
  }
  
  static warning(warnings: string[]): ValidationResult {
    return { valid: true, warnings };
  }
}
```

### **4.3 ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹ï¼ˆ`types/callbacks.ts`ï¼‰**

```typescript
export type InstanceEventType = 
  | 'started'
  | 'stopped'
  | 'crashed'
  | 'autoRestartLimitReached'
  | 'stopTimeout'
  | 'forcedKill';

export interface InstanceEvent {
  type: InstanceEventType;
  uuid: string;
  timestamp: number;
  data?: any;
}

export type NotifyFunction = (event: InstanceEvent) => void;

export interface ServerCallbacks {
  onServerStarted?: (uuid: string) => void;
  onServerStopped?: (uuid: string, exitCode: number) => void;
  onServerCrashed?: (uuid: string, error: Error) => void;
  onAutoRestartLimitReached?: (uuid: string) => void;
  onStopTimeout?: (uuid: string, message: string) => void;
  onForcedKill?: (uuid: string) => void;
}

export interface ProcessStdCallbacks {
  onStdout?: (line: string) => void;
  onStderr?: (line: string) => void;
}
```

### **4.4 ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°ï¼ˆ`constants/errors.ts`ï¼‰**

```typescript
export const ServerManagerErrors = {
  // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
  INSTANCE_NOT_FOUND: 'Server instance not found',
  INSTANCE_NAME_DUPLICATE: 'Server name already exists',
  INSTANCE_RUNNING: 'Server is currently running',
  INSTANCE_NOT_RUNNING: 'Server is not running',
  
  // JDKé–¢é€£
  JDK_NOT_FOUND: 'Required JDK version not found',
  JDK_VERSION_INVALID: 'Invalid JDK version',
  
  // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
  FILE_NOT_FOUND: 'File not found',
  FILE_LOCKED: 'File is locked by another process',
  DIRECTORY_RENAME_FAILED: 'Failed to rename directory',
  DIRECTORY_DELETE_FAILED: 'Failed to delete directory',
  FILE_COPY_FAILED: 'Failed to copy file',
  
  // ãƒãƒ¼ãƒˆ
  PORT_IN_USE: 'Port is already in use by another server',
  PORT_INVALID: 'Invalid port number',
  
  // è¨­å®š
  CONFIG_LOAD_FAILED: 'Failed to load configuration',
  CONFIG_SAVE_FAILED: 'Failed to save configuration',
  CONFIG_INVALID: 'Invalid configuration data',
  
  // ãƒ—ãƒ­ã‚»ã‚¹
  PROCESS_START_FAILED: 'Failed to start server process',
  PROCESS_STOP_TIMEOUT: 'Server did not stop within timeout period',
  
  // ãƒ¬ã‚¸ã‚¹ãƒˆãƒª
  REGISTRY_NOT_LOADED: 'Registry not loaded',
} as const;
```

---

## 5. ã‚¯ãƒ©ã‚¹å®Ÿè£…ä»•æ§˜

### **5.1 ServerManager**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    SM[ServerManager]
    
    R1[å…¨ä½“çµ±æ‹¬]
    R2[è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†]
    R3[ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸€è¦§ç®¡ç†]
    R4[ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å§”è­²]
    R5[ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡]
    R6[ç¨¼åƒæ™‚é–“è¿½è·¡]
    
    SM --> R1
    SM --> R2
    SM --> R3
    SM --> R4
    SM --> R5
    SM --> R6
```

#### **ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰ã¨ãƒ•ãƒ­ãƒ¼**

**åˆæœŸåŒ–:**
```mermaid
flowchart TD
    Start([static initialize]) --> Constructor[private constructor]
    Constructor --> Logger[PinoåˆæœŸåŒ–]
    Logger --> Validator[ServerValidatorç”Ÿæˆ]
    Validator --> CheckConfig{configå­˜åœ¨?}
    CheckConfig -->|No| CreateDefault[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½œæˆ]
    CheckConfig -->|Yes| LoadConfig[èª­ã¿è¾¼ã¿ & Zodæ¤œè¨¼]
    CreateDefault --> CreateWrappers[Wrapperç”Ÿæˆ]
    LoadConfig --> CreateWrappers
    CreateWrappers --> Return[ServerManagerè¿”å´]
```

**addInstance:**
```mermaid
flowchart TD
    Start([addInstance]) --> Validate[Validator.validateAddInstance]
    Validate --> CreateDir[mkdir servers/name]
    CreateDir --> CopyJar[jarç§»å‹•]
    CopyJar --> CreateEula[eula.txtä½œæˆ]
    CreateEula --> CreateProps[server.propertiesä½œæˆ]
    CreateProps --> CreateData[ServerInstanceä½œæˆ]
    CreateData --> SaveConfig[saveConfig]
    SaveConfig --> CreateWrapper[Wrapperç”Ÿæˆ]
    CreateWrapper --> Return[uuidè¿”å´]
```

**startServer:**
```mermaid
flowchart TD
    Start([startServer]) --> GetInstance[getInstance uuid]
    GetInstance --> ValidateStart[Validator.validateServerStart]
    ValidateStart --> WrapperStart[wrapper.start]
    WrapperStart --> StartTracking[ç¨¼åƒæ™‚é–“è¿½è·¡é–‹å§‹]
    StartTracking --> Return[å®Œäº†]
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **åˆæœŸåŒ–ã¯å¿…ãš`static initialize()`çµŒç”±**
   - ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯private
   - éåŒæœŸå‡¦ç†ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç­‰ï¼‰ã‚’å«ã‚€ãŸã‚

2. **ã™ã¹ã¦ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯Validatorã«å§”è­²**
   - Managerå†…ã«ç›´æ¥ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã‹ãªã„

3. **ç¨¼åƒæ™‚é–“è¿½è·¡ã¯5åˆ†ã”ã¨**
   - `setInterval`ã§ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
   - `uptimeIntervals: Map<string, NodeJS.Timeout>`ã«ä¿å­˜

4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã¯try-catchã§å›²ã‚€
   - ã‚¨ãƒ©ãƒ¼æ™‚ã¯è©³ç´°ãªãƒ­ã‚°ã‚’è¨˜éŒ²
   - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”å´

---

### **5.2 ServerValidator**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    SV[ServerValidator]
    
    R1[åå‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    R2[ãƒãƒ¼ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    R3[JDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª]
    R4[ãƒ¡ãƒ¢ãƒªè¨­å®šç¢ºèª]
    R5[è¤‡åˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    
    SV --> R1
    SV --> R2
    SV --> R3
    SV --> R4
    SV --> R5
```

#### **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼**

```mermaid
flowchart TD
    Start([validateAddInstance]) --> Name[validateName]
    Name --> NameOK{OK?}
    NameOK -->|No| ErrorReturn[Errorè¿”å´]
    NameOK -->|Yes| JDK[validateJdkVersion]
    JDK --> JDKOK{OK?}
    JDKOK -->|No| ErrorReturn
    JDKOK -->|Yes| Port[validatePort]
    Port --> PortOK{OK?}
    PortOK -->|No| ErrorReturn
    PortOK -->|Yes| Memory[validateMemorySettings]
    Memory --> MemoryOK{OK?}
    MemoryOK -->|No| ErrorReturn
    MemoryOK -->|Yes| CollectWarnings[è­¦å‘Šã‚’é›†ç´„]
    CollectWarnings --> SuccessReturn[Successè¿”å´]
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **ä¾å­˜ã¯èª­ã¿å–ã‚Šå°‚ç”¨**
   - ServerManagerã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ãªã„
   - `getInstanceByName()`, `getAllInstances()`ã®ã¿ä½¿ç”¨

2. **è­¦å‘Šã¨ã‚¨ãƒ©ãƒ¼ã®åŒºåˆ¥**
   - ã‚¨ãƒ©ãƒ¼: å‡¦ç†ã‚’ç¶šè¡Œã§ããªã„ï¼ˆ`valid: false`ï¼‰
   - è­¦å‘Š: æ³¨æ„ãŒå¿…è¦ã ãŒç¶šè¡Œå¯èƒ½ï¼ˆ`valid: true, warnings: [...]`ï¼‰

3. **JDKå­˜åœ¨ç¢ºèª**
   - `jdkManager.Entrys.getByVersion()`ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
   - æ•´åˆæ€§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚ç¢ºèªï¼ˆmissing/corruptedï¼‰

---

### **5.3 ServerPropertiesManager**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    SPM[ServerPropertiesManager]
    
    R1[ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿æ›¸ã]
    R2[ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è§£æ]
    R3[ãƒãƒ¼ãƒˆç®¡ç†]
    R4[æ‹¡å¼µå¯èƒ½ãªAPI]
    
    SPM --> R1
    SPM --> R2
    SPM --> R3
    SPM --> R4
```

#### **ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ›´æ–°ãƒ•ãƒ­ãƒ¼**

```mermaid
flowchart TD
    Start([updatePort]) --> Exists{ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨?}
    Exists -->|No| Create[æ–°è¦ä½œæˆ]
    Exists -->|Yes| Read[æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿]
    Read --> Parse[ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è§£æ]
    Parse --> Update[server-portæ›´æ–°]
    Update --> Serialize[æ–‡å­—åˆ—åŒ–]
    Create --> Serialize
    Serialize --> Write[ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿]
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ = 1ãƒ•ã‚¡ã‚¤ãƒ«**
   - ä½¿ã„æ¨ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå‘¼ã³å‡ºã—ã®ãŸã³ã«ç”Ÿæˆï¼‰
   - å†…éƒ¨ã®Mapã¯1ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¾

2. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒ**
   - `update()`æ™‚ã¯ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¿æŒ
   - æ­£è¦è¡¨ç¾ã§è©²å½“è¡Œã®ã¿ç½®ãæ›ãˆ

3. **æ‹¡å¼µæ€§**
   - `updatePort()`ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ å¯èƒ½
   - ã‚³ãƒ”ãƒš+ç·¨é›†ã§ç°¡å˜ã«æ‹¡å¼µ

---

### **5.4 ServerInstanceWrapper**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    W[ServerInstanceWrapper]
    
    R1[å€‹åˆ¥ã‚µãƒ¼ãƒãƒ¼åˆ¶å¾¡]
    R2[ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†]
    R3[JDKãƒ­ãƒƒã‚¯ç®¡ç†]
    R4[è‡ªå‹•å†èµ·å‹•åˆ¤å®š]
    R5[æ¨™æº–å…¥å‡ºåŠ›ã‚¤ãƒ™ãƒ³ãƒˆ]
    
    W --> R1
    W --> R2
    W --> R3
    W --> R4
    W --> R5
```

#### **èµ·å‹•ãƒ•ãƒ­ãƒ¼**

```mermaid
sequenceDiagram
    participant W as Wrapper
    participant JDK as JDKManager
    participant PE as ProcessExecutor
    
    W->>JDK: Entrys.getByVersion(jdkVersion)
    JDK-->>W: JDKEntry
    W->>JDK: useRuntime(purpose)
    JDK-->>W: lockId
    W->>PE: new ProcessExecutor(logger, workingDir)
    W->>PE: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
    W->>PE: start(javaPath, jarPath, args)
    PE-->>W: èµ·å‹•å®Œäº†
    W->>W: status = 'running'
    W->>W: startResetTimer()
    W->>W: reportEvent('started')
```

#### **è‡ªå‹•å†èµ·å‹•ãƒ•ãƒ­ãƒ¼**

```mermaid
flowchart TD
    Exit([ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†]) --> CheckCode{exitCode?}
    CheckCode -->|0| Normal[æ­£å¸¸çµ‚äº†]
    CheckCode -->|!= 0| Crash[ã‚¯ãƒ©ãƒƒã‚·ãƒ¥]
    
    Normal --> Cleanup[cleanup]
    Normal --> ReportStopped[reportEvent stopped]
    
    Crash --> CheckAuto{autoRestart<br/>enabled?}
    CheckAuto -->|No| Cleanup
    CheckAuto -->|Yes| CheckLimit{ä¸Šé™ãƒã‚§ãƒƒã‚¯}
    
    CheckLimit -->|è¶…é| ReportLimit[reportEvent<br/>autoRestartLimitReached]
    CheckLimit -->|OK| Increment[count++]
    
    ReportLimit --> Cleanup
    Increment --> Restart[attemptAutoRestart]
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **EventEmitterã®ç¶™æ‰¿**
   - `extends EventEmitter`
   - æ¨™æº–å…¥å‡ºåŠ›ç”¨ã«`emit('stdout', line)`ç­‰ã‚’ä½¿ç”¨

2. **JDKãƒ­ãƒƒã‚¯ã®ç¢ºå®Ÿãªè§£æ”¾**
   - èµ·å‹•æˆåŠŸæ™‚ã€å¤±æ•—æ™‚ã€åœæ­¢æ™‚ã™ã¹ã¦ã§è§£æ”¾
   - `finally`ãƒ–ãƒ­ãƒƒã‚¯ã®æ´»ç”¨

3. **ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ã®ç®¡ç†**
   - èµ·å‹•æ™‚ã«é–‹å§‹ï¼ˆ10åˆ†å¾Œã«ãƒªã‚»ãƒƒãƒˆï¼‰
   - åœæ­¢æ™‚ã«ã‚¯ãƒªã‚¢
   - `clearTimeout()`ã‚’å¿˜ã‚Œãšã«

4. **è‡ªå·±å®Œçµçš„ãªãƒ‘ã‚¹ç®¡ç†**
   - `serversBasePath`ã‚’ä¿æŒ
   - `getWorkingDirectory()`ã§è‡ªåˆ†ã§ãƒ‘ã‚¹æ§‹ç¯‰

---

### **5.5 ProcessExecutor**

#### **è²¬ä»»ç¯„å›²**

```mermaid
graph TB
    PE[ProcessExecutor]
    
    R1[ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ãƒ»åœæ­¢]
    R2[æ¨™æº–å…¥å‡ºåŠ›ç®¡ç†]
    R3[åˆ¶å¾¡æ–‡å­—å¯¾å¿œ]
    R4[ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†]
    
    PE --> R1
    PE --> R2
    PE --> R3
    PE --> R4
```

#### **èµ·å‹•ãƒ»åœæ­¢ãƒ•ãƒ­ãƒ¼**

```mermaid
sequenceDiagram
    participant W as Wrapper
    participant PE as ProcessExecutor
    participant CP as child_process
    
    rect rgb(225, 245, 254)
        Note over W,CP: èµ·å‹•
        W->>PE: start(javaPath, jarPath, args)
        PE->>CP: spawn(javaPath, args, options)
        CP-->>PE: ChildProcess
        PE->>PE: setupOutputHandlers()
        PE->>PE: ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–é–‹å§‹
        PE-->>W: å®Œäº†
    end
    
    rect rgb(255, 243, 224)
        Note over W,CP: åœæ­¢
        W->>PE: stop(timeout)
        PE->>CP: stdin.write('stop\n')
        PE->>PE: waitForExit(timeout)
        alt ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå†…ã«çµ‚äº†
            CP->>PE: exit event
            PE->>W: onExit(exitCode)
        else ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            PE->>W: onStopTimeout()
        end
    end
```

#### **åˆ¶å¾¡æ–‡å­—å¯¾å¿œ**

```typescript
enum ControlCharacter {
  ENTER = '\n',
  CTRL_C = '\x03',
  TAB = '\t'
}
```

```mermaid
graph LR
    Input[å…¥åŠ›] --> Type{ç¨®åˆ¥}
    Type -->|sendCommand| AddEnter[æ–‡å­—åˆ— + Enter]
    Type -->|sendInput| Direct[ãã®ã¾ã¾]
    Type -->|sendControlCharacter| Convert[åˆ¶å¾¡æ–‡å­—å¤‰æ›]
    
    AddEnter --> Write[stdin.write]
    Direct --> Write
    Convert --> Write
```

#### **å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ**

1. **å®Œå…¨ç‹¬ç«‹ã‚¯ãƒ©ã‚¹**
   - ServerManager/Wrapperã®æ¦‚å¿µã«ä¾å­˜ã—ãªã„
   - æ±ç”¨çš„ãªãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œã‚¯ãƒ©ã‚¹

2. **readline interfaceã®ä½¿ç”¨**
   - æ¨™æº–å‡ºåŠ›ã‚’è¡Œå˜ä½ã§å‡¦ç†
   - `createInterface({ input: process.stdout })`

3. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯é€šçŸ¥ã®ã¿**
   - `stop()`ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚å¼·åˆ¶çµ‚äº†ã—ãªã„
   - `onStopTimeout`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§é€šçŸ¥
   - `kill()`ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«å‘¼ã³å‡ºã™

4. **åˆ¶å¾¡æ–‡å­—ã®å®Ÿè£…**
   - `sendCommand()`: æ—¢å­˜äº’æ›ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ + Enterï¼‰
   - `sendInput()`: Enterãªã—
   - `sendControlCharacter()`: åˆ¶å¾¡æ–‡å­—é€ä¿¡

---

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æŒ‡é‡

### **6.1 åŸºæœ¬æ–¹é‡**

```mermaid
graph TB
    Error[ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ] --> Catch[try-catchã§ã‚­ãƒ£ãƒƒãƒ]
    Catch --> Log[è©³ç´°ãƒ­ã‚°è¨˜éŒ²]
    Log --> Return[é©åˆ‡ãªã‚¨ãƒ©ãƒ¼è¿”å´]
    Return --> NoThrow[ä¸Šä½ã«æŠ•ã’ãªã„]
    
    style Error fill:#ffcdd2
    style Catch fill:#fff9c4
    style Log fill:#e1f5ff
    style Return fill:#c8e6c9
```

**åŸå‰‡:**
- âœ… ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã¯try-catchã§å›²ã‚€
- âœ… ã‚¨ãƒ©ãƒ¼ã¯è©³ç´°ã«ãƒ­ã‚°è¨˜éŒ²
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- âœ… ä¾‹å¤–ã‚’ä¸Šä½ã«æŠ•ã’ãšã€Resultå‹ã§è¿”ã™
- âœ… ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªã‚¨ãƒ©ãƒ¼ã®ã¿throw

### **6.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³**

#### **ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ**

```typescript
async removeInstance(uuid: string): Promise<VoidResult> {
  const instance = this.instances.get(uuid);
  if (!instance) {
    return { success: false, error: ServerManagerErrors.INSTANCE_NOT_FOUND };
  }
  
  const serverDir = path.join(this.serversBasePath, instance.getData().name);
  
  try {
    await fs.promises.rm(serverDir, { recursive: true, force: true });
    this.logger.info(`Deleted directory: ${serverDir}`);
  } catch (error) {
    this.logger.error(`Failed to delete directory: ${serverDir}`, error);
    // âŒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•— â†’ å…¨å‡¦ç†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    return { 
      success: false, 
      error: `${ServerManagerErrors.DIRECTORY_DELETE_FAILED}: ${error.message}` 
    };
  }
  
  // âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤æˆåŠŸ â†’ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªæ›´æ–°
  this.instances.delete(uuid);
  await this.saveConfig();
  
  return { success: true };
}
```

#### **ãƒ‘ã‚¿ãƒ¼ãƒ³2: éã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªã‚¨ãƒ©ãƒ¼**

```typescript
async updateInstance(params: UpdateInstanceParams): Promise<VoidResult> {
  // ... å‰å‡¦ç†
  
  // ãƒãƒ¼ãƒˆå¤‰æ›´ï¼ˆå¤±æ•—ã—ã¦ã‚‚å‡¦ç†ç¶™ç¶šï¼‰
  if (params.updates.port !== undefined) {
    try {
      const propManager = this.getServerPropertiesManager(params.uuid);
      await propManager.updatePort(params.updates.port);
      this.logger.info(`Updated port to ${params.updates.port}`);
    } catch (error) {
      // âš ï¸ server.propertiesæ›´æ–°å¤±æ•— â†’ è­¦å‘Šã®ã¿
      this.logger.warn('Failed to update server.properties', error);
      this.logger.warn('Port updated in registry, but server.properties update failed');
      // å‡¦ç†ã¯ç¶™ç¶š
    }
  }
  
  // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆå¿…ãšå®Ÿè¡Œï¼‰
  instance.updateData(params.updates);
  await this.saveConfig();
  
  return { success: true };
}
```

#### **ãƒ‘ã‚¿ãƒ¼ãƒ³3: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼**

```typescript
async addInstance(params: AddInstanceParams): Promise<AddInstanceResult> {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const validation = await this.validator.validateAddInstance(params);
  if (!validation.valid) {
    // âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— â†’ å³åº§ã«è¿”å´
    return { success: false, error: validation.error };
  }
  
  // âš ï¸ è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯ãƒ­ã‚°è¨˜éŒ²
  if (validation.warnings && validation.warnings.length > 0) {
    validation.warnings.forEach(warning => {
      this.logger.warn(warning);
    });
  }
  
  // å‡¦ç†ç¶™ç¶š...
}
```

### **6.3 ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®ä½¿ã„åˆ†ã‘**

| ãƒ¬ãƒ™ãƒ« | ç”¨é€” | ä¾‹ |
|--------|------|-----|
| `debug` | è©³ç´°ãªå‡¦ç†å†…å®¹ | ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã€å¤‰æ•°ã®å€¤ |
| `info` | æ­£å¸¸ãªå‡¦ç† | ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æˆåŠŸã€è¨­å®šä¿å­˜ |
| `warn` | è­¦å‘Šï¼ˆå‡¦ç†ã¯ç¶™ç¶šï¼‰ | server.propertiesæ›´æ–°å¤±æ•—ã€ãƒ¡ãƒ¢ãƒªè­¦å‘Š |
| `error` | ã‚¨ãƒ©ãƒ¼ï¼ˆå‡¦ç†ä¸­æ–­ï¼‰ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•—ã€JDKæœªç™ºè¦‹ |

---

## 7. ãƒ†ã‚¹ãƒˆä»•æ§˜

### **7.1 ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**

#### **test.env.json ã®ä½¿ç”¨**

```typescript
// tests/setup/loadTestEnv.ts
import * as fs from 'fs';
import * as path from 'path';

export interface TestEnv {
  jdkManager: {
    configPath: string;
    jdkArchives: {
      jdk8: string;
      jdk17: string;
      jdk21: string;
    };
  };
  minecraftServer: {
    vanillaJar: string;
    paperJar: string;
  };
  testPaths: {
    configDir: string;
    serversDir: string;
    logsDir: string;
  };
}

export function loadTestEnv(): TestEnv {
  const envPath = path.join(__dirname, 'test.env.json');
  const content = fs.readFileSync(envPath, 'utf-8');
  return JSON.parse(content);
}
```

### **7.2 ãƒ†ã‚¹ãƒˆã®æ§‹æˆ**

```mermaid
graph TB
    subgraph "ãƒ†ã‚¹ãƒˆéšå±¤"
        Unit[å˜ä½“ãƒ†ã‚¹ãƒˆ<br/>å„ã‚¯ãƒ©ã‚¹å€‹åˆ¥]
        Integration[çµ±åˆãƒ†ã‚¹ãƒˆ<br/>ã‚¯ãƒ©ã‚¹é–“é€£æº]
        E2E[E2Eãƒ†ã‚¹ãƒˆ<br/>å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼èµ·å‹•]
    end
    
    subgraph "ãƒ†ã‚¹ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"
        Cases[test-cases.md<br/>æ‰‹å‹•ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§]
    end
    
    Unit --> Integration
    Integration --> E2E
    E2E --> Cases
    
    style Unit fill:#e8f5e9
    style Integration fill:#fff9c4
    style E2E fill:#ffcdd2
    style Cases fill:#e1f5ff
```

### **7.3 çµ±åˆãƒ†ã‚¹ãƒˆã®ä¾‹**

```typescript
// tests/integration/server-lifecycle.test.ts
import { ServerManager } from '../../src/classes/ServerManager';
import { JdkManager } from 'jdk-manager';
import { loadTestEnv } from '../setup/loadTestEnv';

describe('Server Lifecycle Integration Test', () => {
  let manager: ServerManager;
  let jdkManager: JdkManager;
  const testEnv = loadTestEnv();
  
  beforeAll(async () => {
    // JDKManageråˆæœŸåŒ–
    jdkManager = new JdkManager(testEnv.jdkManager.configPath);
    await jdkManager.Data.load();
    
    // ServerManageråˆæœŸåŒ–
    manager = await ServerManager.initialize(
      testEnv.testPaths.configDir + '/server-manager.json',
      testEnv.testPaths.serversDir,
      testEnv.testPaths.logsDir + '/manager.log',
      jdkManager
    );
  });
  
  test('ã‚µãƒ¼ãƒãƒ¼ã®è¿½åŠ ãƒ»èµ·å‹•ãƒ»åœæ­¢ãƒ»å‰Šé™¤', async () => {
    // 1. ã‚µãƒ¼ãƒãƒ¼è¿½åŠ 
    const addResult = await manager.addInstance({
      name: 'test-server',
      note: 'ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ¼ãƒãƒ¼',
      software: { name: 'Vanilla', version: '1.20.1' },
      jdkVersion: 17,
      serverBinaryFilePath: testEnv.minecraftServer.vanillaJar
    });
    
    expect(addResult.success).toBe(true);
    const uuid = addResult.uuid!;
    
    // 2. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
    const startResult = await manager.startServer(uuid);
    expect(startResult.success).toBe(true);
    
    // 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
    const data = manager.getInstanceData(uuid);
    expect(data?.status).toBe('running');
    
    // 4. ã‚µãƒ¼ãƒãƒ¼åœæ­¢
    const stopResult = await manager.stopServer(uuid);
    expect(stopResult.success).toBe(true);
    
    // 5. ã‚µãƒ¼ãƒãƒ¼å‰Šé™¤
    const removeResult = await manager.removeInstance(uuid);
    expect(removeResult.success).toBe(true);
  });
});
```

### **7.4 E2Eãƒ†ã‚¹ãƒˆã®ä¾‹**

```typescript
// tests/e2e/minecraft-server.test.ts
describe('Minecraft Server E2E Test', () => {
  test('å®Ÿéš›ã«Minecraftã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã€ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã‚‹', async () => {
    // ... åˆæœŸåŒ–
    
    const addResult = await manager.addInstance({
      name: 'e2e-server',
      note: 'E2Eãƒ†ã‚¹ãƒˆ',
      software: { name: 'Vanilla', version: '1.20.1' },
      jdkVersion: 17,
      serverBinaryFilePath: testEnv.minecraftServer.vanillaJar
    });
    
    const uuid = addResult.uuid!;
    
    // æ¨™æº–å‡ºåŠ›ç›£è¦–
    const outputs: string[] = [];
    manager.openProcessStd(uuid, {
      onStdout: (line) => outputs.push(line)
    });
    
    // èµ·å‹•
    await manager.startServer(uuid);
    
    // ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº†ã‚’å¾…æ©Ÿï¼ˆ"Done"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
    await waitForServerReady(outputs, 60000);
    
    // ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
    manager.sendCommand(uuid, 'list');
    
    // å¿œç­”å¾…æ©Ÿ
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // å‡ºåŠ›ç¢ºèª
    const hasListOutput = outputs.some(line => 
      line.includes('There are') && line.includes('players online')
    );
    expect(hasListOutput).toBe(true);
    
    // åœæ­¢
    await manager.stopServer(uuid, 30000);
    await manager.removeInstance(uuid);
  });
});
```

---

## 8. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæŒ‡ç¤º

### **8.1 ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§ï¼ˆ`docs/test-cases.md`ï¼‰**

ä»¥ä¸‹ã®å½¢å¼ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ï¼š

```markdown
# ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§

## 1. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†

### 1.1 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¿½åŠ 

| ID | ãƒ†ã‚¹ãƒˆé …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|----|----------|------|---------|
| TC-001 | æ­£å¸¸ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¿½åŠ  | 1. æœ‰åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§addInstanceå‘¼ã³å‡ºã—<br/>2. çµæœç¢ºèª | success: true, uuidãŒè¿”å´ã•ã‚Œã‚‹ |
| TC-002 | åå‰é‡è¤‡ã‚¨ãƒ©ãƒ¼ | 1. åŒã˜åå‰ã§2å›addInstance<br/>2. 2å›ç›®ã®çµæœç¢ºèª | success: false, error: "Name already exists" |
| TC-003 | ç„¡åŠ¹ãªJDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1. å­˜åœ¨ã—ãªã„JDKãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š<br/>2. çµæœç¢ºèª | success: false, error: "JDK not found" |

## 2. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ»åœæ­¢

### 2.1 èµ·å‹•

| ID | ãƒ†ã‚¹ãƒˆé …ç›® | æ‰‹é † | æœŸå¾…çµæœ |
|----|----------|------|---------|
| TC-101 | æ­£å¸¸èµ·å‹• | 1. stopServerå‘¼ã³å‡ºã—<br/>2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª | status: 'running' |
| TC-102 | æ—¢ã«èµ·å‹•ä¸­ã®ã‚µãƒ¼ãƒãƒ¼èµ·å‹• | 1. èµ·å‹•ä¸­ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦startServer<br/>2. çµæœç¢ºèª | success: false, error: "Already running" |

...
```

### **8.2 FAQï¼ˆ`docs/faq.md`ï¼‰**

```markdown
# FAQ - æ—¢çŸ¥ã®å•é¡Œã¨å¯¾å‡¦æ³•

## ãƒãƒ¼ãƒˆé–¢é€£

### Q1: ãƒãƒ¼ãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ãŸã®ã«èµ·å‹•ã«å¤±æ•—ã™ã‚‹

**åŸå› :**
- å¤–éƒ¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ä¸­
- OSå´ã§ãƒãƒ¼ãƒˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹
- ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®š

**å¯¾å‡¦æ³•:**
1. `netstat -ano | findstr :{PORT}` (Windows) ã§ãƒãƒ¼ãƒˆä½¿ç”¨çŠ¶æ³ç¢ºèª
2. ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
3. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šã‚’ç¢ºèª

## ã‚¯ãƒ©ãƒƒã‚·ãƒ¥åˆ¤å®š

### Q2: æ­£å¸¸çµ‚äº†ãªã®ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ‰±ã„ã«ãªã‚‹

**åŸå› :**
- ä¸€éƒ¨ã®ã‚µãƒ¼ãƒãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯æ­£å¸¸çµ‚äº†ã§ã‚‚exitCode != 0ã‚’è¿”ã™å ´åˆãŒã‚ã‚‹

**å¯¾å‡¦æ³•:**
- ç¾åœ¨ã®å®Ÿè£…ã§ã¯exitCode == 0ã®ã¿ã‚’æ­£å¸¸çµ‚äº†ã¨åˆ¤å®š
- å°†æ¥çš„ã«ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã”ã¨ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ã‚’æ¤œè¨

...
```

### **8.3 APIä½¿ç”¨ä¾‹ï¼ˆ`docs/api-usage.md`ï¼‰**

```markdown
# APIä½¿ç”¨ä¾‹

## åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•

### åˆæœŸåŒ–

\`\`\`typescript
import { ServerManager } from './classes/ServerManager';
import { JdkManager } from 'jdk-manager';

// JDKManageråˆæœŸåŒ–
const jdkManager = new JdkManager('./jdk-registry.json');
await jdkManager.Data.load();

// ServerManageråˆæœŸåŒ–
const manager = await ServerManager.initialize(
  './config/server-manager.json',
  './servers',
  './logs/manager.log',
  jdkManager,
  {
    onServerStarted: (uuid) => console.log(`Started: ${uuid}`),
    onServerCrashed: (uuid, error) => console.error(`Crashed: ${uuid}`, error)
  }
);
\`\`\`

...
```

---

## 9. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### **9.1 ã‚¯ãƒ©ã‚¹å®Ÿè£…**

#### **ServerManager**
- [ ] `static initialize()`ã®å®Ÿè£…
- [ ] `addInstance()`ã®å®Ÿè£…
- [ ] `removeInstance()`ã®å®Ÿè£…ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤å¤±æ•—æ™‚ã¯å…¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
- [ ] `updateInstance()`ã®å®Ÿè£…ï¼ˆnoteã®ã¿èµ·å‹•ä¸­æ›´æ–°å¯ï¼‰
- [ ] `startServer()`ã®å®Ÿè£…
- [ ] `stopServer()`ã®å®Ÿè£…
- [ ] `restartServer()`ã®å®Ÿè£…
- [ ] `forceKillServer()`ã®å®Ÿè£…
- [ ] `getInstance()`ã®å®Ÿè£…
- [ ] `getInstanceData()`ã®å®Ÿè£…
- [ ] `getAllInstances()`ã®å®Ÿè£…
- [ ] `getRunningInstances()`ã®å®Ÿè£…
- [ ] `getValidator()`ã®å®Ÿè£…
- [ ] `getServerPropertiesManager()`ã®å®Ÿè£…
- [ ] `openProcessStd()`ã®å®Ÿè£…
- [ ] `closeProcessStd()`ã®å®Ÿè£…
- [ ] `sendCommand()`ã®å®Ÿè£…
- [ ] ç¨¼åƒæ™‚é–“è¿½è·¡ï¼ˆ5åˆ†ã”ã¨ï¼‰ã®å®Ÿè£…
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…

#### **ServerValidator**
- [ ] `validateName()`ã®å®Ÿè£…
- [ ] `validatePort()`ã®å®Ÿè£…ï¼ˆè­¦å‘Šæ©Ÿèƒ½å«ã‚€ï¼‰
- [ ] `validateJdkVersion()`ã®å®Ÿè£…
- [ ] `validateMemorySettings()`ã®å®Ÿè£…
- [ ] `validateJvmArguments()`ã®å®Ÿè£…
- [ ] `validateAddInstance()`ã®å®Ÿè£…
- [ ] `validateUpdateInstance()`ã®å®Ÿè£…
- [ ] `validateServerStart()`ã®å®Ÿè£…

#### **ServerPropertiesManager**
- [ ] `create()`ã®å®Ÿè£…
- [ ] `read()`ã®å®Ÿè£…
- [ ] `write()`ã®å®Ÿè£…
- [ ] `update()`ã®å®Ÿè£…
- [ ] `updateMultiple()`ã®å®Ÿè£…
- [ ] `get()`ã®å®Ÿè£…
- [ ] `exists()`ã®å®Ÿè£…
- [ ] `updatePort()`ã®å®Ÿè£…
- [ ] `getPort()`ã®å®Ÿè£…
- [ ] ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è§£æãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

#### **ServerInstanceWrapper**
- [ ] ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å®Ÿè£…
- [ ] `start()`ã®å®Ÿè£…
- [ ] `stop()`ã®å®Ÿè£…
- [ ] `restart()`ã®å®Ÿè£…
- [ ] `forceKill()`ã®å®Ÿè£…
- [ ] `sendCommand()`ã®å®Ÿè£…
- [ ] `getData()`ã®å®Ÿè£…ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ï¼‰
- [ ] `updateData()`ã®å®Ÿè£…
- [ ] `getStatus()`ã®å®Ÿè£…
- [ ] `isRunning()`ã®å®Ÿè£…
- [ ] EventEmitteræ©Ÿèƒ½ã®å®Ÿè£…
- [ ] JDKãƒ­ãƒƒã‚¯ç®¡ç†ã®å®Ÿè£…
- [ ] è‡ªå‹•å†èµ·å‹•ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…
- [ ] ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ã®å®Ÿè£…
- [ ] ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…

#### **ProcessExecutor**
- [ ] ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å®Ÿè£…
- [ ] `start()`ã®å®Ÿè£…
- [ ] `stop()`ã®å®Ÿè£…ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼‰
- [ ] `kill()`ã®å®Ÿè£…
- [ ] `sendCommand()`ã®å®Ÿè£…
- [ ] `sendInput()`ã®å®Ÿè£…
- [ ] `sendControlCharacter()`ã®å®Ÿè£…
- [ ] `isRunning()`ã®å®Ÿè£…
- [ ] `getPid()`ã®å®Ÿè£…
- [ ] æ¨™æº–å‡ºåŠ›ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®Ÿè£…
- [ ] æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®Ÿè£…
- [ ] `waitForExit()`ã®å®Ÿè£…
- [ ] `cleanup()`ã®å®Ÿè£…

### **9.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
- [ ] ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã«try-catchã‚’å®Ÿè£…
- [ ] é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¿”å´
- [ ] ãƒ­ã‚°è¨˜éŒ²ã®å®Ÿè£…
- [ ] ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ãã†ã§ãªã„ã‚¨ãƒ©ãƒ¼ã®åŒºåˆ¥

### **9.3 ãƒ†ã‚¹ãƒˆ**
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè£…
- [ ] E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
- [ ] test.env.jsonã®è¨­å®š

### **9.4 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
- [ ] test-cases.mdã®ä½œæˆ
- [ ] faq.mdã®ä½œæˆ
- [ ] api-usage.mdã®ä½œæˆ
- [ ] README.mdã®ä½œæˆ

---

## ğŸ‰ å®Œäº†

ã“ã®å®Ÿè£…ä¾é ¼æ›¸ã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚

**ä¸æ˜ç‚¹ãŒã‚ã‚‹å ´åˆ:**
1. è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆStep1, Step2ï¼‰ã‚’å‚ç…§
2. JDKManagerã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§
3. è³ªå•ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ç¢ºèª

**å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:**
- âœ… è²¬ä»»åˆ†é›¢ã‚’æ„è­˜
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¾¹åº•
- âœ… ãƒ­ã‚°ã‚’è©³ç´°ã«è¨˜éŒ²
- âœ… ãƒ†ã‚¹ãƒˆã‚’æ›¸ããªãŒã‚‰å®Ÿè£…
- âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°

**é ‘å¼µã£ã¦ãã ã•ã„ï¼ğŸš€**
